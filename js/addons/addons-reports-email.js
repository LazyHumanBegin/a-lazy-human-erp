// ==================== ADDONS-REPORTS-EMAIL.JS ====================
// EZCubic - Email Report Functions - Split from addons-reports.js v2.3.2
// Email Daily Report, Report Reminder System

// ==================== EMAIL DAILY REPORT ====================
function generateDailyReportEmail() {
    const today = new Date().toISOString().split('T')[0];
    const businessName = window.businessData?.settings?.businessName || 'A Lazy Human';
    
    // Get today's data
    const transactions = getTransactionsFromStorage();
    const todayTransactions = transactions.filter(t => t.date === today);
    
    const todayIncome = todayTransactions.filter(t => t.type === 'income').reduce((sum, t) => sum + parseFloat(t.amount || 0), 0);
    const todayExpense = todayTransactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + parseFloat(t.amount || 0), 0);
    const netProfit = todayIncome - todayExpense;
    
    // Get orders
    const orders = window.orders || [];
    const todayOrders = orders.filter(o => o.date === today);
    const orderTotal = todayOrders.reduce((sum, o) => sum + parseFloat(o.total || 0), 0);
    
    // Get pending bills
    const bills = getBillsFromStorage();
    const pendingBills = bills.filter(b => b.status !== 'paid');
    const overdueBills = pendingBills.filter(b => new Date(b.dueDate) < new Date());
    
    // Build email body
    const subject = `ðŸ“Š Daily Report - ${businessName} - ${today}`;
    const body = `
DAILY BUSINESS REPORT
${businessName}
Date: ${today}
Generated: ${new Date().toLocaleString()}

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ðŸ“ˆ TODAY'S SUMMARY
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
Income:      RM ${todayIncome.toFixed(2)}
Expenses:    RM ${todayExpense.toFixed(2)}
Net Profit:  RM ${netProfit.toFixed(2)}

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ðŸ›’ SALES
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
Orders Today:    ${todayOrders.length}
Sales Total:     RM ${orderTotal.toFixed(2)}

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ðŸ“‹ BILLS STATUS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
Pending Bills:   ${pendingBills.length}
Overdue Bills:   ${overdueBills.length}

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ðŸ“ TODAY'S TRANSACTIONS (${todayTransactions.length})
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
${todayTransactions.length > 0 ? todayTransactions.map(t => 
    `${t.type === 'income' ? 'âž•' : 'âž–'} ${t.description || t.category}: RM ${parseFloat(t.amount).toFixed(2)}`
).join('\n') : 'No transactions recorded today'}

---
Report generated by A Lazy Human ERP
    `.trim();
    
    return { subject, body };
}

function sendDailyReportEmail() {
    const { subject, body } = generateDailyReportEmail();
    const recipient = localStorage.getItem('ezcubic_report_email') || '';
    
    // Create mailto link
    const mailtoLink = `mailto:${recipient}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
    
    // Open email client
    window.location.href = mailtoLink;
    
    showNotification('Email client opened with daily report', 'success');
}

function showEmailReportModal() {
    const savedEmail = localStorage.getItem('ezcubic_report_email') || '';
    const savedTime = localStorage.getItem('ezcubic_report_reminder_time') || '18:00';
    const reminderEnabled = localStorage.getItem('ezcubic_report_reminder') === 'true';
    
    const modal = document.createElement('div');
    modal.id = 'emailReportModal';
    modal.innerHTML = `
        <div style="position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 99999; 
                    display: flex; align-items: center; justify-content: center; padding: 20px;"
             onclick="if(event.target === this) this.remove()">
            <div style="background: white; border-radius: 16px; width: 100%; max-width: 450px; 
                        box-shadow: 0 20px 50px rgba(0,0,0,0.3); overflow: hidden;">
                <div style="padding: 20px; background: linear-gradient(135deg, #2563eb, #1d4ed8); color: white;">
                    <h3 style="margin: 0; display: flex; align-items: center; gap: 10px;">
                        <i class="fas fa-envelope"></i> Daily Report Email
                    </h3>
                </div>
                <div style="padding: 20px;">
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 500;">Your Email Address</label>
                        <input type="email" id="reportEmailAddress" class="form-control" value="${savedEmail}"
                               placeholder="your@email.com" style="width: 100%;">
                    </div>
                    
                    <div style="margin-bottom: 15px; padding: 15px; background: #f8fafc; border-radius: 10px;">
                        <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                            <input type="checkbox" id="enableReportReminder" ${reminderEnabled ? 'checked' : ''}>
                            <span style="font-weight: 500;"><i class="fas fa-bell"></i> Daily Reminder</span>
                        </label>
                        <div style="margin-top: 10px; display: flex; align-items: center; gap: 10px;">
                            <span style="color: #64748b;">Remind me at:</span>
                            <input type="time" id="reportReminderTime" class="form-control" value="${savedTime}"
                                   style="width: auto;">
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 10px;">
                        <button onclick="saveEmailReportSettings()" class="btn-primary" style="flex: 1;">
                            <i class="fas fa-save"></i> Save Settings
                        </button>
                        <button onclick="sendDailyReportEmail()" class="btn-secondary" style="flex: 1;">
                            <i class="fas fa-paper-plane"></i> Send Now
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
}

function saveEmailReportSettings() {
    const email = document.getElementById('reportEmailAddress').value;
    const reminderEnabled = document.getElementById('enableReportReminder').checked;
    const reminderTime = document.getElementById('reportReminderTime').value;
    
    localStorage.setItem('ezcubic_report_email', email);
    localStorage.setItem('ezcubic_report_reminder', reminderEnabled);
    localStorage.setItem('ezcubic_report_reminder_time', reminderTime);
    
    // Remove modal
    document.getElementById('emailReportModal')?.remove();
    
    showNotification('Email report settings saved!', 'success');
    
    // Restart reminder check
    if (reminderEnabled) {
        initDailyReportReminder();
    }
}

// ==================== DAILY REPORT REMINDER ====================
let reportReminderInterval = null;

function initDailyReportReminder() {
    // Clear existing interval
    if (reportReminderInterval) {
        clearInterval(reportReminderInterval);
    }
    
    const reminderEnabled = localStorage.getItem('ezcubic_report_reminder') === 'true';
    if (!reminderEnabled) return;
    
    const reminderTime = localStorage.getItem('ezcubic_report_reminder_time') || '18:00';
    const lastReminder = localStorage.getItem('ezcubic_last_report_reminder');
    const today = new Date().toISOString().split('T')[0];
    
    // Check every minute
    reportReminderInterval = setInterval(() => {
        const now = new Date();
        const currentTime = now.toTimeString().slice(0, 5); // HH:MM
        const currentDate = now.toISOString().split('T')[0];
        
        // Check if it's reminder time and haven't reminded today
        if (currentTime === reminderTime && lastReminder !== currentDate) {
            localStorage.setItem('ezcubic_last_report_reminder', currentDate);
            showReportReminderNotification();
        }
    }, 60000); // Check every minute
    
    console.log('Daily report reminder initialized for', reminderTime);
}

function showReportReminderNotification() {
    // Create prominent reminder
    const reminder = document.createElement('div');
    reminder.id = 'reportReminderBanner';
    reminder.innerHTML = `
        <div style="position: fixed; bottom: 20px; left: 20px; right: 20px; max-width: 400px;
                    background: linear-gradient(135deg, #2563eb, #1d4ed8); color: white;
                    padding: 20px; border-radius: 16px; box-shadow: 0 10px 30px rgba(37,99,235,0.4);
                    z-index: 99998; animation: slideUp 0.3s ease;">
            <style>
                @keyframes slideUp { from { transform: translateY(100px); opacity: 0; } }
            </style>
            <div style="display: flex; align-items: center; gap: 15px;">
                <div style="font-size: 32px;">ðŸ“Š</div>
                <div style="flex: 1;">
                    <div style="font-weight: 600; font-size: 16px;">Time for Daily Report!</div>
                    <div style="opacity: 0.9; font-size: 14px;">Send your business summary email</div>
                </div>
                <button onclick="this.parentElement.parentElement.parentElement.remove()" 
                        style="background: none; border: none; color: white; font-size: 20px; cursor: pointer; opacity: 0.7;">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div style="display: flex; gap: 10px; margin-top: 15px;">
                <button onclick="sendDailyReportEmail(); this.parentElement.parentElement.parentElement.remove();"
                        style="flex: 1; padding: 10px; background: white; color: #2563eb; border: none; 
                               border-radius: 8px; font-weight: 600; cursor: pointer;">
                    <i class="fas fa-paper-plane"></i> Send Report
                </button>
                <button onclick="this.parentElement.parentElement.parentElement.remove();"
                        style="padding: 10px 15px; background: rgba(255,255,255,0.2); color: white; 
                               border: none; border-radius: 8px; cursor: pointer;">
                    Later
                </button>
            </div>
        </div>
    `;
    document.body.appendChild(reminder);
    
    // Also show notification
    showNotification('ðŸ“Š Time to send your daily report!', 'info');
}

// ==================== GLOBAL EXPORTS - EMAIL REPORT ====================
window.generateDailyReportEmail = generateDailyReportEmail;
window.sendDailyReportEmail = sendDailyReportEmail;
window.showEmailReportModal = showEmailReportModal;
window.saveEmailReportSettings = saveEmailReportSettings;
window.initDailyReportReminder = initDailyReportReminder;
window.showReportReminderNotification = showReportReminderNotification;
