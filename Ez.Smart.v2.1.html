<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#2563eb">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="A Lazy Human">
    <meta name="application-name" content="A Lazy Human ERP">
    <meta name="description" content="Complete ERP system for Malaysian businesses - Accounting, POS, Inventory, CRM & more">
    <meta name="mobile-web-app-capable" content="yes">
    
    <title>A Lazy Human - Malaysian Business Accounting & Tax</title>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    
    <!-- Icons for iOS -->
    <link rel="apple-touch-icon" href="images/icon-152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="images/icon-180.png">
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" href="images/icon-192.png">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <!-- SheetJS for Excel Export -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    
    <!-- Supabase Cloud Database SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <link rel="stylesheet" href="style.css?v=1766330009">
    
    <!-- Prevent zoom issues on orientation change -->
    <script>
    (function() {
        // Handle orientation change - reset zoom
        window.addEventListener('orientationchange', function() {
            // Brief delay to let orientation settle
            setTimeout(function() {
                // Reset viewport zoom
                var viewport = document.querySelector('meta[name="viewport"]');
                if (viewport) {
                    viewport.content = 'width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no';
                }
                // Only scroll to top on actual orientation change, not on resize
                window.scrollTo(0, 0);
            }, 100);
        });
        
        // Removed resize scroll-to-top - was causing scroll issues on mobile
        // when keyboard opens/closes or address bar shows/hides
    })();
    </script>
</head>
<body>
    <!-- Mobile Menu Button (Draggable) - Hidden until logged in -->
    <button class="mobile-menu-btn" id="mobileMenuBtn" style="display: none;">
        <img src="images/lazyhuman.svg" alt="A Lazy Human" style="width: 24px; height: 24px;">
    </button>
    <div class="mobile-overlay" onclick="toggleMobileMenu()"></div>
    
    <!-- Draggable Mobile Button Script -->
    <script>
    (function() {
        const btn = document.getElementById('mobileMenuBtn');
        if (!btn) return;
        
        let isDragging = false;
        let wasDragged = false;
        let startX, startY, startLeft, startTop;
        
        // Load saved position
        const savedPos = localStorage.getItem('mobileMenuBtnPosition');
        if (savedPos) {
            const pos = JSON.parse(savedPos);
            btn.style.left = pos.left;
            btn.style.top = pos.top;
            btn.style.right = 'auto';
            btn.style.bottom = 'auto';
        }
        
        function onStart(e) {
            isDragging = true;
            wasDragged = false;
            
            const touch = e.touches ? e.touches[0] : e;
            startX = touch.clientX;
            startY = touch.clientY;
            
            const rect = btn.getBoundingClientRect();
            startLeft = rect.left;
            startTop = rect.top;
            
            btn.style.transition = 'none';
        }
        
        function onMove(e) {
            if (!isDragging) return;
            
            const touch = e.touches ? e.touches[0] : e;
            const deltaX = touch.clientX - startX;
            const deltaY = touch.clientY - startY;
            
            // Only count as drag if moved more than 8px
            if (Math.abs(deltaX) > 8 || Math.abs(deltaY) > 8) {
                wasDragged = true;
                e.preventDefault();
            }
            
            if (wasDragged) {
                let newLeft = startLeft + deltaX;
                let newTop = startTop + deltaY;
                
                // Keep within bounds
                const btnSize = btn.offsetWidth;
                newLeft = Math.max(5, Math.min(window.innerWidth - btnSize - 5, newLeft));
                newTop = Math.max(5, Math.min(window.innerHeight - btnSize - 5, newTop));
                
                btn.style.left = newLeft + 'px';
                btn.style.top = newTop + 'px';
                btn.style.right = 'auto';
                btn.style.bottom = 'auto';
            }
        }
        
        function onEnd(e) {
            if (!isDragging) return;
            isDragging = false;
            
            btn.style.transition = 'all 0.3s';
            
            // Save position if dragged
            if (wasDragged) {
                localStorage.setItem('mobileMenuBtnPosition', JSON.stringify({
                    left: btn.style.left,
                    top: btn.style.top
                }));
            }
        }
        
        // Touch events
        btn.addEventListener('touchstart', onStart, { passive: true });
        document.addEventListener('touchmove', onMove, { passive: false });
        document.addEventListener('touchend', onEnd);
        
        // Mouse events
        btn.addEventListener('mousedown', onStart);
        document.addEventListener('mousemove', onMove);
        document.addEventListener('mouseup', onEnd);
        
        // Handle click - only toggle menu if not dragged
        btn.addEventListener('click', function(e) {
            if (!wasDragged) {
                toggleMobileMenu();
            }
            wasDragged = false;
        });
    })();
    </script>
    
    <div class="app-container" style="display: none;" id="appContainer">
        <!-- Navigation Panel -->
        <div class="nav-panel" id="navPanel">
            <div class="logo">
                <h1><img src="images/lazyhuman.svg" alt="A Lazy Human" style="width: 32px; height: 32px; vertical-align: middle; margin-right: 8px;"> A Lazy Human</h1>
                <div class="tagline">Malaysian Business Accounting & Tax</div>
                <div class="version" id="appVersion">v2.2.1</div>
            </div>
            
            <div class="nav-menu">
                <button class="nav-btn active" onclick="showSection('dashboard')">
                    <i class="fas fa-tachometer-alt"></i> Dashboard
                </button>
                
                <!-- Sales & CRM -->
                <div class="nav-separator" onclick="toggleNavCategory(this)">
                    <span>Sales & CRM</span>
                    <i class="fas fa-chevron-down collapse-icon"></i>
                </div>
                <div class="nav-category">
                <button class="nav-btn" onclick="showSection('crm')">
                    <i class="fas fa-users"></i> Customers
                </button>
                <button class="nav-btn" onclick="showSection('quotations')">
                    <i class="fas fa-file-invoice"></i> Quotations
                </button>
                <button class="nav-btn" onclick="showSection('invoices')">
                    <i class="fas fa-file-invoice-dollar"></i> Invoices
                </button>
                <button class="nav-btn" onclick="showSection('projects')">
                    <i class="fas fa-project-diagram"></i> Projects
                </button>
                </div>
                <!-- Operations -->
                <div class="nav-separator" onclick="toggleNavCategory(this)">
                    <span>Operations</span>
                    <i class="fas fa-chevron-down collapse-icon"></i>
                </div>
                <div class="nav-category">
                <button class="nav-btn" onclick="showSection('inventory')">
                    <i class="fas fa-boxes"></i> Inventory
                    <span class="nav-badge" id="lowStockBadge" style="display: none;">0</span>
                </button>
                <button class="nav-btn" onclick="showSection('pos')">
                    <i class="fas fa-cash-register"></i> POS / Sales
                </button>
                <button class="nav-btn" onclick="showSection('stock')">
                    <i class="fas fa-warehouse"></i> Stock Control
                </button>
                <button class="nav-btn" onclick="showSection('orders')">
                    <i class="fas fa-clipboard-list"></i> Orders
                    <span class="nav-badge" id="pendingOrdersBadge" style="display: none;">0</span>
                </button>
                </div>
                
                <!-- Purchasing -->
                <div class="nav-separator" onclick="toggleNavCategory(this)">
                    <span>Purchasing</span>
                    <i class="fas fa-chevron-down collapse-icon"></i>
                </div>
                <div class="nav-category">
                <button class="nav-btn" onclick="showSection('suppliers')">
                    <i class="fas fa-truck"></i> Suppliers
                    <span class="nav-badge" id="suppliersPayableBadge" style="display: none;">0</span>
                </button>
                </div>
                
                <!-- HR & Payroll -->
                <div class="nav-separator" onclick="toggleNavCategory(this)">
                    <span>HR & Payroll</span>
                    <i class="fas fa-chevron-down collapse-icon"></i>
                </div>
                <div class="nav-category">
                <button class="nav-btn" onclick="showSection('payroll')">
                    <i class="fas fa-users"></i> Employees & Payroll
                </button>
                <button class="nav-btn" onclick="showSection('leave-attendance')">
                    <i class="fas fa-calendar-check"></i> Leave & Attendance
                </button>
                </div>
                
                <div class="nav-separator" onclick="toggleNavCategory(this)">
                    <span>Accounting</span>
                    <i class="fas fa-chevron-down collapse-icon"></i>
                </div>
                <div class="nav-category">
                <button class="nav-btn" onclick="showSection('chart-of-accounts')">
                    <i class="fas fa-sitemap"></i> Chart of Accounts
                </button>
                <button class="nav-btn" onclick="showSection('journal-entries')">
                    <i class="fas fa-book"></i> Journal Entries
                </button>
                <button class="nav-btn" onclick="showSection('transactions')">
                    <i class="fas fa-exchange-alt"></i> All Transactions
                </button>
                <button class="nav-btn" onclick="showSection('income')">
                    <i class="fas fa-arrow-circle-up"></i> Record Income
                </button>
                <button class="nav-btn" onclick="showSection('expenses')">
                    <i class="fas fa-arrow-circle-down"></i> Record Expenses
                </button>
                <button class="nav-btn" onclick="showSection('bills')">
                    <i class="fas fa-file-invoice-dollar"></i> Bills to Pay
                    <span class="nav-badge" id="billsBadge">0</span>
                </button>
                </div>
                
                <div class="nav-separator" onclick="toggleNavCategory(this)">
                    <span>Reports</span>
                    <i class="fas fa-chevron-down collapse-icon"></i>
                </div>
                <div class="nav-category">
                <button class="nav-btn" onclick="showSection('aging-reports')">
                    <i class="fas fa-clock"></i> AR/AP Aging
                </button>
                <button class="nav-btn" onclick="showSection('monthly-reports')">
                    <i class="fas fa-chart-bar"></i> Monthly Reports
                </button>
                <button class="nav-btn" onclick="showSection('reports')">
                    <i class="fas fa-chart-pie"></i> Financial Reports
                </button>
                <button class="nav-btn" onclick="showSection('balance-sheet')">
                    <i class="fas fa-balance-scale"></i> Balance Sheet
                </button>
                <button class="nav-btn" onclick="showSection('taxes')">
                    <i class="fas fa-calculator"></i> Malaysian Taxes
                </button>
                <button class="nav-btn" onclick="showSection('bank-reconciliation')">
                    <i class="fas fa-university"></i> Bank Reconciliation
                </button>
                <button class="nav-btn" id="lhdnExportNav" onclick="showSection('lhdn-export')">
                    <i class="fas fa-file-export"></i> LHDN & Audit Export
                </button>
                </div>
                
                <div class="nav-separator" onclick="toggleNavCategory(this)">
                    <span>Multi-Branch</span>
                    <i class="fas fa-chevron-down collapse-icon"></i>
                </div>
                <div class="nav-category">
                <button class="nav-btn" onclick="showSection('branches')">
                    <i class="fas fa-building"></i> Branches
                    <span class="nav-badge" id="branchesBadge" style="display: none;">0</span>
                </button>
                </div>
                
                <div class="nav-separator" onclick="toggleNavCategory(this)">
                    <span>Tools</span>
                    <i class="fas fa-chevron-down collapse-icon"></i>
                </div>
                <div class="nav-category">
                <button class="nav-btn" onclick="showSection('ai-chatbot')">
                    <i class="fas fa-robot"></i> AI Assistant
                    <span class="nav-badge" id="chatbotNavBadge" style="display: none;">0</span>
                </button>
                <button class="nav-btn" onclick="showSection('audit-log')">
                    <i class="fas fa-clipboard-list"></i> Audit Log
                </button>
                <button class="nav-btn" onclick="showSection('settings')">
                    <i class="fas fa-cog"></i> Settings
                </button>
                </div>
                
                <!-- Platform Admin (Founder/ERP Assistant only) -->
                <div class="nav-separator platform-admin-nav" id="platformAdminNav" style="display: none !important;">
                    <span>Platform Admin</span>
                </div>
                <button class="nav-btn platform-admin-nav" id="userManagementNav" onclick="showSection('user-management')" style="display: none !important;">
                    <i class="fas fa-users-cog"></i> User Management
                </button>
                <button class="nav-btn platform-admin-nav" id="platformControlNav" onclick="showSection('platform-control')" style="display: none !important;">
                    <i class="fas fa-server"></i> Platform Control
                </button>
            </div>
            
            <div class="data-security">
                <i class="fas fa-lock"></i> Your data is stored locally on your device
            </div>
        </div>
        
        <!-- Main Content Area -->
        <div class="main-content">
            <!-- Auth Bar -->
            <div class="top-auth-bar">
                <!-- Tenant selector (hidden - access via Platform Control instead) -->
                <select id="tenantSelector" class="form-control" style="display: none !important;" onchange="switchTenant(this.value)">
                    <!-- Populated dynamically -->
                </select>
                
                <!-- Quick Actions - ALL IN ONE LINE -->
                <div class="top-bar-actions">
                    <!-- Global Search Icon -->
                    <button onclick="openGlobalSearch()" class="btn-icon" title="Search (Ctrl+/)">
                        <i class="fas fa-search"></i>
                    </button>
                    <!-- Dark Mode Toggle -->
                    <button onclick="toggleDarkMode()" class="btn-icon" title="Toggle Dark Mode">
                        <i class="fas fa-moon" id="darkModeIcon"></i>
                    </button>
                    
                    <!-- Auth buttons (when logged out) -->
                    <div id="authContainer">
                        <button class="btn-primary" onclick="showLoginPage()" title="Login">
                            <i class="fas fa-sign-in-alt"></i> <span class="hide-mobile">Login</span>
                        </button>
                        <button class="btn-outline hide-mobile" onclick="showFreeRegistrationModal()">
                            <i class="fas fa-user-plus"></i> Sign Up
                        </button>
                    </div>
                    
                    <!-- User menu (when logged in) -->
                    <div id="userMenuContainer" style="display: none;">
                        <!-- User menu rendered by users.js -->
                    </div>
                </div>
            </div>
            
            <!-- Welcome Banner (Dashboard only) -->
            <div id="welcomeBanner" class="welcome-banner" style="display: none;">
                <div>
                    <h2 id="welcomeCompanyName">Welcome to A Lazy Human!</h2>
                    <p>Complete business accounting & personal tax management in one platform</p>
                </div>
                <div class="banner-actions">
                    <button class="btn-secondary" onclick="hideWelcomeBanner()" style="background: rgba(255,255,255,0.2); color: white; border-color: rgba(255,255,255,0.3);">
                        Dismiss
                    </button>
                </div>
            </div>
            
            <!-- Dashboard Section -->
            <div id="dashboard" class="content-section active">
                <div class="content-card full-width">
                    <div class="card-header">
                        <h2><i class="fas fa-tachometer-alt"></i> <span id="dashboardCompanyName">Business Dashboard</span></h2>
                        <div style="font-size: 14px; color: #64748b;">
                            <i class="fas fa-calendar-alt"></i> <span id="currentDate"></span>
                        </div>
                    </div>
                    
                    <!-- Stats Overview -->
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-label">Cash Balance</div>
                            <div class="stat-value" id="cashBalance">RM 0</div>
                            <div class="stat-change positive" id="cashChange">
                                <i class="fas fa-arrow-up"></i> 0%
                            </div>
                        </div>
                        <div class="stat-card income">
                            <div class="stat-label">This Month Income</div>
                            <div class="stat-value" id="monthIncome">RM 0</div>
                            <div class="stat-change positive" id="incomeChange">
                                <i class="fas fa-arrow-up"></i> 0%
                            </div>
                        </div>
                        <div class="stat-card expense">
                            <div class="stat-label">This Month Expenses</div>
                            <div class="stat-value" id="monthExpense">RM 0</div>
                            <div class="stat-change negative" id="expenseChange">
                                <i class="fas fa-arrow-down"></i> 0%
                            </div>
                        </div>
                        <div class="stat-card warning">
                            <div class="stat-label">Unpaid Bills</div>
                            <div class="stat-value" id="billsDue">RM 0</div>
                            <div class="stat-change" id="billsChange" style="color: #fef3c7;">
                                <i class="fas fa-clock"></i> <span id="billsCountLabel">0 bills</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Charts -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px;">
                        <div>
                            <h3 style="margin-bottom: 15px; color: #1e293b;">Monthly Trend (Last 6 Months)</h3>
                            <div class="chart-container">
                                <canvas id="incomeChart"></canvas>
                            </div>
                        </div>
                        <div>
                            <h3 style="margin-bottom: 15px; color: #1e293b;">Income vs Expenses</h3>
                            <div class="chart-container">
                                <canvas id="pieChart"></canvas>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Plan Usage Widget -->
                    <div id="usageWidget" style="margin-top: 20px;">
                        <!-- Rendered by renderUsageWidget() -->
                    </div>
                    
                    <!-- Tips & Suggestions -->
                    <div class="tips-section">
                        <h4><i class="fas fa-lightbulb"></i> Quick Tips for Malaysian Businesses</h4>
                        <div class="tip-item">
                            <i class="fas fa-check-circle"></i>
                            <span>Keep records for at least 7 years for tax purposes</span>
                        </div>
                        <div class="tip-item">
                            <i class="fas fa-check-circle"></i>
                            <span>Submit CP204 tax estimate by 30th of each second month</span>
                        </div>
                        <div class="tip-item">
                            <i class="fas fa-check-circle"></i>
                            <span>Business registration with SSM is required for all companies</span>
                        </div>
                    </div>
                </div>
                
                <!-- Recent Transactions -->
                <div class="content-card">
                    <div class="card-header">
                        <h2><i class="fas fa-history"></i> Recent Transactions</h2>
                        <button class="btn-secondary" onclick="showSection('transactions')">View All</button>
                    </div>
                    <div class="transaction-list" id="recentTransactions">
                        <!-- Transactions will be loaded here -->
                    </div>
                </div>
                
                <!-- Upcoming Bills -->
                <div class="content-card">
                    <div class="card-header">
                        <h2><i class="fas fa-calendar-alt"></i> Upcoming Bills</h2>
                        <button class="btn-secondary" onclick="showSection('bills')">Manage</button>
                    </div>
                    <div id="upcomingBills">
                        <!-- Bills will be loaded here -->
                    </div>
                </div>
            </div>
            
            <!-- ==================== PHASE 2: INVENTORY SECTION ==================== -->
            <div id="inventory" class="content-section">
                <div class="content-card full-width">
                    <div class="card-header">
                        <h2><i class="fas fa-boxes"></i> Inventory Management</h2>
                        <div style="display: flex; gap: 10px;">
                            <button class="btn-outline" onclick="exportInventoryToExcel()" title="Export to Excel">
                                <i class="fas fa-file-excel"></i> Excel
                            </button>
                            <button class="btn-primary" onclick="showProductModal()">
                                <i class="fas fa-plus"></i> Add Product
                            </button>
                        </div>
                    </div>
                    
                    <!-- Inventory Stats -->
                    <div class="stats-grid" style="margin-bottom: 20px;">
                        <div class="stat-card">
                            <div class="stat-label">Total Products</div>
                            <div class="stat-value" id="totalProducts">0</div>
                        </div>
                        <div class="stat-card income">
                            <div class="stat-label">Total Stock Value</div>
                            <div class="stat-value" id="totalStockValue">RM 0</div>
                        </div>
                        <div class="stat-card warning">
                            <div class="stat-label">Low Stock Items</div>
                            <div class="stat-value" id="lowStockCount">0</div>
                        </div>
                        <div class="stat-card expense">
                            <div class="stat-label">Out of Stock</div>
                            <div class="stat-value" id="outOfStockCount">0</div>
                        </div>
                    </div>
                    
                    <!-- Search & Filter -->
                    <div style="display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap;">
                        <input type="text" id="productSearch" placeholder="Search products..." 
                               class="form-control" style="flex: 1; min-width: 200px;" 
                               oninput="searchProducts(this.value)">
                        <select id="inventoryBranchFilter" class="form-control" style="width: 180px;" onchange="filterProducts()">
                            <option value="">All Branches/Outlets</option>
                            <!-- Branches loaded dynamically -->
                        </select>
                        <select id="categoryFilter" class="form-control" style="width: 180px;" onchange="filterProducts()">
                            <option value="">All Categories</option>
                        </select>
                        <select id="stockFilter" class="form-control" style="width: 150px;" onchange="filterProducts()">
                            <option value="">All Stock</option>
                            <option value="instock">In Stock</option>
                            <option value="lowstock">Low Stock</option>
                            <option value="outofstock">Out of Stock</option>
                        </select>
                    </div>
                    
                    <!-- Products Grid/Table Toggle -->
                    <div style="display: flex; justify-content: flex-end; margin-bottom: 15px;">
                        <div class="view-toggle">
                            <button class="view-toggle-btn active" onclick="setInventoryView('grid')">
                                <i class="fas fa-th-large"></i> Grid
                            </button>
                            <button class="view-toggle-btn" onclick="setInventoryView('table')">
                                <i class="fas fa-list"></i> Table
                            </button>
                        </div>
                    </div>
                    
                    <!-- Products Display -->
                    <div id="productsGrid" class="products-grid">
                        <!-- Products will be loaded here -->
                        <div class="empty-state">
                            <i class="fas fa-box-open"></i>
                            <h3>No Products Yet</h3>
                            <p>Add your first product to start managing inventory</p>
                            <button class="btn-primary" onclick="showProductModal()">
                                <i class="fas fa-plus"></i> Add Product
                            </button>
                        </div>
                    </div>
                    
                    <div id="productsTable" class="products-table" style="display: none;">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Product</th>
                                    <th>SKU</th>
                                    <th>Category</th>
                                    <th>Cost</th>
                                    <th>Price</th>
                                    <th>Stock</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="productsTableBody">
                                <!-- Products table rows -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- ==================== PHASE 2: POS SECTION ==================== -->
            <div id="pos" class="content-section">
                <div class="pos-container">
                    <!-- Products Panel -->
                    <div class="pos-products-panel">
                        <div class="pos-panel-header">
                            <h3><i class="fas fa-store"></i> Products</h3>
                            <button class="btn-primary btn-sm" onclick="showSection('inventory'); setTimeout(() => showProductModal(), 100);">
                                <i class="fas fa-plus"></i> Add Product
                            </button>
                        </div>
                        
                        <div class="pos-search" style="display: flex; gap: 8px;">
                            <input type="text" id="posSearch" placeholder="Search products or scan barcode..." 
                                   class="form-control" oninput="searchPOSProducts(this.value)" style="flex: 1;">
                            <button class="btn-outline" onclick="openBarcodeScanner(handlePOSBarcode)" title="Scan Barcode" style="padding: 10px 15px;">
                                <i class="fas fa-barcode"></i>
                            </button>
                        </div>
                        
                        <!-- Outlet Filter -->
                        <div class="pos-outlet-filter" style="margin-bottom: 10px; display: flex; gap: 5px;">
                            <select id="posOutletFilter" class="form-control" onchange="filterPOSByOutlet(this.value)">
                                <option value="all">All Outlets</option>
                                <!-- Outlets loaded dynamically -->
                            </select>
                            <button type="button" class="btn-outline" onclick="showOutletModal()" title="Manage Outlets">
                                <i class="fas fa-cog"></i>
                            </button>
                        </div>
                        
                        <!-- Quick Categories -->
                        <div class="pos-categories" id="posCategories">
                            <button class="pos-category-btn active" onclick="filterPOSCategory('')">All</button>
                            <!-- Categories will be loaded dynamically -->
                        </div>
                        
                        <!-- POS Products Grid -->
                        <div class="pos-products-grid" id="posProductsGrid">
                            <!-- Products will be loaded here -->
                        </div>
                    </div>
                    
                    <!-- Cart Panel -->
                    <div class="pos-cart-panel">
                        <div class="pos-cart-header">
                            <h3><i class="fas fa-shopping-cart"></i> Current Sale</h3>
                            <button class="btn-outline btn-sm" onclick="clearCart()">
                                <i class="fas fa-trash"></i> Clear
                            </button>
                        </div>
                        
                        <!-- Customer Selection -->
                        <div class="pos-customer-select" style="margin-bottom: 10px;">
                            <select id="posCustomer" class="form-control">
                                <option value="">Walk-in Customer</option>
                                <!-- Customers will be loaded here -->
                            </select>
                        </div>
                        
                        <!-- Salesperson/Cashier Selection -->
                        <div class="pos-salesperson-select" style="margin-bottom: 10px;">
                            <select id="posSalesperson" class="form-control" required>
                                <option value="">-- Select Cashier/Staff --</option>
                                <!-- Staff will be loaded dynamically -->
                            </select>
                        </div>
                        
                        <!-- Cart Items -->
                        <div class="pos-cart-items" id="posCartItems">
                            <div class="cart-empty">
                                <i class="fas fa-shopping-basket"></i>
                                <p>Cart is empty</p>
                            </div>
                        </div>
                        
                        <!-- Cart Summary -->
                        <div class="pos-cart-summary">
                            <div class="summary-row">
                                <span>Subtotal</span>
                                <span id="cartSubtotal">RM 0.00</span>
                            </div>
                            <div class="summary-row">
                                <span>Discount</span>
                                <div style="display: flex; align-items: center; gap: 5px;">
                                    <input type="number" id="cartDiscount" value="0" min="0" step="0.01" 
                                           style="width: 80px; text-align: right;" onchange="updateCartTotals()">
                                </div>
                            </div>
                            <div class="summary-row">
                                <span>Tax <small style="color: #64748b;">(per item rate)</small></span>
                                <span id="cartTax">RM 0.00</span>
                            </div>
                            <div class="summary-row total">
                                <span>TOTAL</span>
                                <span id="cartTotal">RM 0.00</span>
                            </div>
                        </div>
                        
                        <!-- Payment Buttons -->
                        <div class="pos-payment-buttons">
                            <button class="btn-primary btn-lg w-full" onclick="showPaymentModal()">
                                <i class="fas fa-credit-card"></i> Process Payment
                            </button>
                            <div style="display: flex; gap: 10px; margin-top: 10px;">
                                <button class="btn-outline flex-1" onclick="holdSale()">
                                    <i class="fas fa-pause"></i> Hold
                                </button>
                                <button class="btn-outline flex-1" onclick="showHeldSales()">
                                    <i class="fas fa-history"></i> Held (<span id="heldCount">0</span>)
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- ==================== PHASE 2: CUSTOMERS SECTION ==================== -->
            <!-- ==================== PHASE 2: STOCK CONTROL SECTION ==================== -->
            <div id="stock" class="content-section">
                <div class="content-card full-width">
                    <div class="card-header">
                        <h2><i class="fas fa-warehouse"></i> Stock Control</h2>
                        <button class="btn-primary" onclick="showStockAdjustmentModal()">
                            <i class="fas fa-edit"></i> Adjust Stock
                        </button>
                    </div>
                    
                    <!-- Stock Tabs -->
                    <div class="view-toggle" style="margin-bottom: 20px;">
                        <button class="view-toggle-btn active" onclick="showStockTab('movements')">
                            <i class="fas fa-history"></i> Stock Movements
                        </button>
                        <button class="view-toggle-btn" onclick="showStockTab('lowstock')">
                            <i class="fas fa-exclamation-triangle"></i> Low Stock Alerts
                        </button>
                        <button class="view-toggle-btn" onclick="showStockTab('valuation')">
                            <i class="fas fa-chart-pie"></i> Stock Valuation
                        </button>
                    </div>
                    
                    <!-- Stock Movements Tab -->
                    <div id="movementsTab" class="stock-tab active">
                        <div style="display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap;">
                            <input type="date" id="stockDateFrom" class="form-control" style="width: 150px;">
                            <input type="date" id="stockDateTo" class="form-control" style="width: 150px;">
                            <select id="movementTypeFilter" class="form-control" style="width: 150px;" onchange="filterStockMovements()">
                                <option value="">All Types</option>
                                <option value="in">Stock In</option>
                                <option value="out">Stock Out</option>
                                <option value="adjustment">Adjustment</option>
                                <option value="sale">Sale</option>
                            </select>
                            <button class="btn-secondary" onclick="filterStockMovements()">
                                <i class="fas fa-filter"></i> Filter
                            </button>
                        </div>
                        
                        <div class="table-responsive">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Product</th>
                                        <th>Type</th>
                                        <th>Quantity</th>
                                        <th>Reference</th>
                                        <th>Notes</th>
                                    </tr>
                                </thead>
                                <tbody id="stockMovementsBody">
                                    <tr>
                                        <td colspan="6" style="text-align: center; padding: 40px; color: #94a3b8;">
                                            <i class="fas fa-exchange-alt" style="font-size: 48px; margin-bottom: 15px; opacity: 0.5;"></i>
                                            <p>No stock movements recorded yet</p>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <!-- Low Stock Tab -->
                    <div id="lowstockTab" class="stock-tab" style="display: none;">
                        <div class="low-stock-grid" id="lowStockGrid">
                            <div class="empty-state">
                                <i class="fas fa-check-circle" style="color: #10b981;"></i>
                                <h3>All Stock Levels OK</h3>
                                <p>No products are below minimum stock level</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Stock Valuation Tab -->
                    <div id="valuationTab" class="stock-tab" style="display: none;">
                        <div class="stats-grid" style="margin-bottom: 20px;">
                            <div class="stat-card income">
                                <div class="stat-label">Total Cost Value</div>
                                <div class="stat-value" id="totalCostValue">RM 0</div>
                            </div>
                            <div class="stat-card" style="background: linear-gradient(135deg, #2563eb, #3b82f6); color: white;">
                                <div class="stat-label" style="color: rgba(255,255,255,0.8);">Total Retail Value</div>
                                <div class="stat-value" id="totalRetailValue">RM 0</div>
                            </div>
                            <div class="stat-card warning">
                                <div class="stat-label">Potential Profit</div>
                                <div class="stat-value" id="potentialProfit">RM 0</div>
                            </div>
                        </div>
                        
                        <div id="stockValuationChart">
                            <!-- Stock valuation breakdown -->
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- ==================== PHASE 2: ORDERS TRACKING SECTION ==================== -->
            <div id="orders" class="content-section">
                <div class="content-card full-width">
                    <div class="card-header">
                        <h2><i class="fas fa-clipboard-list"></i> Order Management</h2>
                        <div style="display: flex; gap: 10px;">
                            <button class="btn-outline" onclick="printTable('ordersTable', 'Orders Report')" title="Print">
                                <i class="fas fa-print"></i>
                            </button>
                            <button class="btn-outline" onclick="exportOrdersToExcel()" title="Export to Excel">
                                <i class="fas fa-file-excel"></i> Excel
                            </button>
                            <button class="btn-outline" onclick="exportOrdersCSV()" title="Export to CSV">
                                <i class="fas fa-file-csv"></i> CSV
                            </button>
                        </div>
                    </div>
                    
                    <!-- Order Stats -->
                    <div class="stats-grid" style="margin-bottom: 20px;">
                        <div class="stat-card">
                            <div class="stat-label">Total Orders</div>
                            <div class="stat-value" id="totalOrders">0</div>
                        </div>
                        <div class="stat-card income">
                            <div class="stat-label">Completed</div>
                            <div class="stat-value" id="completedOrders">0</div>
                        </div>
                        <div class="stat-card warning">
                            <div class="stat-label">Pending</div>
                            <div class="stat-value" id="pendingOrders">0</div>
                        </div>
                        <div class="stat-card expense">
                            <div class="stat-label">Cancelled</div>
                            <div class="stat-value" id="cancelledOrders">0</div>
                        </div>
                    </div>
                    
                    <!-- Order Filters -->
                    <div style="display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap;">
                        <input type="text" id="orderSearch" placeholder="Search by receipt #, customer..." 
                               class="form-control" style="flex: 1; min-width: 200px;" 
                               oninput="searchOrders(this.value)">
                        <input type="date" id="orderDateFrom" class="form-control" style="width: 150px;" onchange="filterOrders()">
                        <input type="date" id="orderDateTo" class="form-control" style="width: 150px;" onchange="filterOrders()">
                        <select id="orderStatusFilter" class="form-control" style="width: 150px;" onchange="filterOrders()">
                            <option value="">All Status</option>
                            <option value="completed">Completed</option>
                            <option value="pending">Pending</option>
                            <option value="processing">Processing</option>
                            <option value="cancelled">Cancelled</option>
                        </select>
                    </div>
                    
                    <!-- Orders Table -->
                    <div class="table-responsive">
                        <table class="data-table" id="ordersTable">
                            <thead>
                                <tr>
                                    <th>Receipt #</th>
                                    <th>Date</th>
                                    <th>Customer</th>
                                    <th>Branch/Outlet</th>
                                    <th>Items</th>
                                    <th>Total</th>
                                    <th>Payment</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="ordersTableBody">
                                <tr>
                                    <td colspan="9" style="text-align: center; padding: 40px; color: #94a3b8;">
                                        <i class="fas fa-clipboard-list" style="font-size: 48px; margin-bottom: 15px; opacity: 0.5;"></i>
                                        <p>No orders yet. Sales from POS will appear here.</p>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- ==================== SUPPLIERS SECTION ==================== -->
            <div id="suppliers" class="content-section">
                <div class="content-card full-width">
                    <div class="card-header">
                        <h2><i class="fas fa-truck"></i> Suppliers & Procurement</h2>
                        <div style="display: flex; gap: 10px;">
                            <button class="btn-outline" onclick="exportSuppliers()">
                                <i class="fas fa-download"></i> Export
                            </button>
                            <button class="btn-primary" onclick="showSupplierModal()">
                                <i class="fas fa-plus"></i> Add Supplier
                            </button>
                        </div>
                    </div>
                    
                    <!-- Tabs -->
                    <div class="tabs" style="margin-bottom: 20px;">
                        <button class="tab active" onclick="showSupplierTab('suppliers')">
                            <i class="fas fa-address-book"></i> Suppliers
                        </button>
                        <button class="tab" onclick="showSupplierTab('purchaseOrders')">
                            <i class="fas fa-file-invoice"></i> Purchase Orders
                        </button>
                        <button class="tab" onclick="showSupplierTab('receiving')">
                            <i class="fas fa-box"></i> Receiving
                        </button>
                    </div>
                    
                    <!-- Suppliers Section -->
                    <div id="suppliersSection">
                        <!-- Supplier Stats -->
                        <div class="stats-grid" style="margin-bottom: 20px;">
                            <div class="stat-card">
                                <div class="stat-label">Total Suppliers</div>
                                <div class="stat-value" id="suppliersTotalCount">0</div>
                            </div>
                            <div class="stat-card income">
                                <div class="stat-label">Active</div>
                                <div class="stat-value" id="suppliersActive">0</div>
                            </div>
                            <div class="stat-card expense">
                                <div class="stat-label">Total Payable</div>
                                <div class="stat-value" id="suppliersTotalPayable">RM 0</div>
                            </div>
                            <div class="stat-card warning">
                                <div class="stat-label">Overdue</div>
                                <div class="stat-value" id="suppliersOverdue">0</div>
                            </div>
                        </div>
                        
                        <!-- Supplier Filters -->
                        <div style="display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap;">
                            <input type="text" id="supplierSearch" placeholder="Search suppliers..." 
                                   class="form-control" style="flex: 1; min-width: 200px;" 
                                   oninput="searchSuppliers(this.value)">
                            <select id="supplierCategoryFilter" class="form-control" style="width: 180px;" onchange="filterSuppliers()">
                                <option value="">All Categories</option>
                                <option value="general">General</option>
                                <option value="raw-materials">Raw Materials</option>
                                <option value="packaging">Packaging</option>
                                <option value="equipment">Equipment</option>
                                <option value="services">Services</option>
                                <option value="logistics">Logistics</option>
                                <option value="office">Office Supplies</option>
                                <option value="utilities">Utilities</option>
                            </select>
                            <select id="supplierStatusFilter" class="form-control" style="width: 150px;" onchange="filterSuppliers()">
                                <option value="">All Status</option>
                                <option value="active">Active</option>
                                <option value="inactive">Inactive</option>
                            </select>
                        </div>
                        
                        <!-- Suppliers List -->
                        <div class="suppliers-grid" id="suppliersList">
                            <div class="empty-state">
                                <i class="fas fa-truck"></i>
                                <p>No suppliers yet</p>
                                <button class="btn-primary" onclick="showSupplierModal()">
                                    <i class="fas fa-plus"></i> Add First Supplier
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Purchase Orders Section -->
                    <div id="purchaseOrdersSection" style="display: none;">
                        <!-- PO Stats -->
                        <div class="stats-grid" style="margin-bottom: 20px;">
                            <div class="stat-card warning">
                                <div class="stat-label">Pending Orders</div>
                                <div class="stat-value" id="poPendingCount">0</div>
                            </div>
                            <div class="stat-card info">
                                <div class="stat-label">Approved</div>
                                <div class="stat-value" id="poApprovedCount">0</div>
                            </div>
                            <div class="stat-card income">
                                <div class="stat-label">Received</div>
                                <div class="stat-value" id="poReceivedCount">0</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">This Month Total</div>
                                <div class="stat-value" id="poMonthTotal">RM 0</div>
                            </div>
                        </div>
                        
                        <!-- PO Actions -->
                        <div style="display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap; align-items: center;">
                            <button class="btn-primary" onclick="showPurchaseOrderModal()">
                                <i class="fas fa-plus"></i> New Purchase Order
                            </button>
                            <select id="poStatusFilter" class="form-control" style="width: 150px;" onchange="loadPurchaseOrders()">
                                <option value="">All Status</option>
                                <option value="draft">Draft</option>
                                <option value="pending">Pending Approval</option>
                                <option value="approved">Approved</option>
                                <option value="ordered">Ordered</option>
                                <option value="partial">Partially Received</option>
                                <option value="received">Received</option>
                                <option value="cancelled">Cancelled</option>
                            </select>
                            <select id="poSupplierFilter" class="form-control" style="width: 200px;" onchange="loadPurchaseOrders()">
                                <option value="">All Suppliers</option>
                            </select>
                            <input type="month" id="poMonthFilter" class="form-control" style="width: 150px;" onchange="loadPurchaseOrders()">
                        </div>
                        
                        <!-- PO Table -->
                        <div class="table-container">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>PO Number</th>
                                        <th>Date</th>
                                        <th>Supplier</th>
                                        <th>Items</th>
                                        <th>Total (RM)</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="purchaseOrdersBody">
                                    <tr>
                                        <td colspan="7" style="text-align: center; color: #64748b; padding: 40px;">
                                            <i class="fas fa-file-invoice" style="font-size: 40px; margin-bottom: 10px; display: block;"></i>
                                            No purchase orders found
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <!-- Receiving Section -->
                    <div id="receivingSection" style="display: none;">
                        <!-- Receiving Stats -->
                        <div class="stats-grid" style="margin-bottom: 20px;">
                            <div class="stat-card warning">
                                <div class="stat-label">Pending Delivery</div>
                                <div class="stat-value" id="rcvPendingCount">0</div>
                            </div>
                            <div class="stat-card income">
                                <div class="stat-label">Received Today</div>
                                <div class="stat-value" id="rcvTodayCount">0</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">This Month Value</div>
                                <div class="stat-value" id="rcvMonthValue">RM 0</div>
                            </div>
                        </div>
                        
                        <!-- Orders Awaiting Delivery -->
                        <h4 style="margin-bottom: 15px;"><i class="fas fa-clock"></i> Orders Awaiting Delivery</h4>
                        <div id="pendingDeliveriesList" class="pending-deliveries">
                            <div class="empty-state">
                                <i class="fas fa-truck-loading"></i>
                                <p>No orders awaiting delivery</p>
                            </div>
                        </div>
                        
                        <!-- Recent Receipts -->
                        <h4 style="margin: 20px 0 15px;"><i class="fas fa-history"></i> Recent Receipts</h4>
                        <div class="table-container">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Receipt Date</th>
                                        <th>PO Number</th>
                                        <th>Supplier</th>
                                        <th>Items Received</th>
                                        <th>Value</th>
                                        <th>Received By</th>
                                    </tr>
                                </thead>
                                <tbody id="recentReceiptsBody">
                                    <tr>
                                        <td colspan="6" style="text-align: center; color: #64748b; padding: 30px;">
                                            No recent receipts
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- ==================== HR & PAYROLL SECTION ==================== -->
            <div id="payroll" class="content-section">
                <div class="content-card full-width">
                    <div class="card-header">
                        <h2><i class="fas fa-users"></i> HR & Payroll</h2>
                        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                            <button class="btn-outline" onclick="exportEmployeesToExcel()" title="Export Employees">
                                <i class="fas fa-file-excel"></i> Employees
                            </button>
                            <button class="btn-outline" onclick="exportPayrollToExcel()" title="Export Payroll">
                                <i class="fas fa-file-excel"></i> Payroll
                            </button>
                            <button class="btn-primary" onclick="showProcessPayrollModal()">
                                <i class="fas fa-calculator"></i> Process Payroll
                            </button>
                            <button class="btn-primary" onclick="showEmployeeModal()">
                                <i class="fas fa-user-plus"></i> Add Employee
                            </button>
                        </div>
                    </div>
                    
                    <!-- Payroll Stats -->
                    <div class="stats-grid" style="margin-bottom: 20px;">
                        <div class="stat-card">
                            <div class="stat-label">Total Employees</div>
                            <div class="stat-value" id="totalEmployees">0</div>
                        </div>
                        <div class="stat-card income">
                            <div class="stat-label">Monthly Salary Bill</div>
                            <div class="stat-value" id="totalMonthlySalary">RM 0</div>
                        </div>
                        <div class="stat-card warning">
                            <div class="stat-label">Processed This Month</div>
                            <div class="stat-value" id="processedThisMonth">0/0</div>
                        </div>
                        <div class="stat-card expense">
                            <div class="stat-label">Total Paid This Month</div>
                            <div class="stat-value" id="totalPaidThisMonth">RM 0</div>
                        </div>
                    </div>
                    
                    <!-- Tabs -->
                    <div class="tabs" style="margin-bottom: 20px;">
                        <button class="tab active" onclick="showPayrollTab('employees')">
                            <i class="fas fa-users"></i> Employees
                        </button>
                        <button class="tab" onclick="showPayrollTab('payroll')">
                            <i class="fas fa-file-invoice-dollar"></i> Payroll
                        </button>
                        <button class="tab" onclick="showPayrollTab('salesReport')">
                            <i class="fas fa-chart-bar"></i> Sales Report
                        </button>
                        <button class="tab" onclick="showPayrollTab('kpi')">
                            <i class="fas fa-chart-line"></i> KPI
                        </button>
                    </div>
                    
                    <!-- Employees Section -->
                    <div id="employeesSection">
                        <!-- Filters -->
                        <div style="display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap;">
                            <input type="text" id="employeeSearch" placeholder="Search employees..." 
                                   class="form-control" style="flex: 1; min-width: 200px;" 
                                   oninput="filterEmployees()">
                            <select id="employeeStatusFilter" class="form-control" style="width: 150px;" onchange="filterEmployees()">
                                <option value="all">All Status</option>
                                <option value="active">Active</option>
                                <option value="inactive">Inactive</option>
                            </select>
                            <select id="employeeDeptFilter" class="form-control" style="width: 180px;" onchange="filterEmployees()">
                                <option value="all">All Departments</option>
                            </select>
                        </div>
                        
                        <!-- Employees Grid -->
                        <div class="employees-grid" id="employeesGrid">
                            <div class="empty-state">
                                <i class="fas fa-users"></i>
                                <h4>No employees yet</h4>
                                <p>Add your first employee to get started</p>
                                <button class="btn-primary" onclick="showEmployeeModal()" style="margin-top: 15px;">
                                    <i class="fas fa-plus"></i> Add Employee
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Payroll History Section -->
                    <div id="payrollSection" style="display: none;">
                        <!-- Filters -->
                        <div style="display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap;">
                            <input type="month" id="payrollMonthFilter" class="form-control" style="width: 200px;" 
                                   onchange="loadPayrollHistory()">
                            <button class="btn-outline" onclick="document.getElementById('payrollMonthFilter').value=''; loadPayrollHistory();">
                                <i class="fas fa-times"></i> Clear Filter
                            </button>
                        </div>
                        
                        <!-- Payroll History -->
                        <div id="payrollHistory">
                            <div class="empty-state">
                                <i class="fas fa-file-invoice-dollar"></i>
                                <h4>No payroll records</h4>
                                <p>Process your first payroll to see history here</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Sales Report Section -->
                    <div id="salesReportSection" style="display: none;">
                        <!-- Filters -->
                        <div style="display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap; align-items: center;">
                            <select id="salesReportEmployee" class="form-control" style="width: 220px;" onchange="loadSalesReport()">
                                <option value="">All Salespersons</option>
                            </select>
                            <input type="month" id="salesReportMonth" class="form-control" style="width: 180px;" onchange="loadSalesReport()">
                            <button class="btn-outline" onclick="clearSalesReportFilters()">
                                <i class="fas fa-times"></i> Clear
                            </button>
                            <button class="btn-primary" onclick="exportSalesReport()">
                                <i class="fas fa-download"></i> Export
                            </button>
                        </div>
                        
                        <!-- Sales Summary Cards -->
                        <div class="stats-grid" style="margin-bottom: 20px;">
                            <div class="stat-card income">
                                <div class="stat-label">Total Sales</div>
                                <div class="stat-value" id="salesReportTotal">RM 0</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">Transactions</div>
                                <div class="stat-value" id="salesReportCount">0</div>
                            </div>
                            <div class="stat-card warning">
                                <div class="stat-label">Commission Earned</div>
                                <div class="stat-value" id="salesReportCommission">RM 0</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">Avg Per Sale</div>
                                <div class="stat-value" id="salesReportAvg">RM 0</div>
                            </div>
                        </div>
                        
                        <!-- Sales Report Table -->
                        <div class="table-container" style="overflow-x: auto;">
                            <table class="data-table" id="salesReportTable">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Receipt/Order</th>
                                        <th>Customer</th>
                                        <th>Salesperson</th>
                                        <th>Items</th>
                                        <th>Total (RM)</th>
                                        <th>Source</th>
                                    </tr>
                                </thead>
                                <tbody id="salesReportBody">
                                    <tr>
                                        <td colspan="7" style="text-align: center; color: #64748b; padding: 40px;">
                                            Select a salesperson or month to view sales report
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <!-- KPI Section -->
                    <div id="kpiSection" style="display: none;">
                        <!-- KPI Stats -->
                        <div class="stats-grid" style="margin-bottom: 20px;">
                            <div class="stat-card">
                                <div class="stat-label">KPI Templates</div>
                                <div class="stat-value" id="kpiTemplatesCount">0</div>
                            </div>
                            <div class="stat-card warning">
                                <div class="stat-label">Pending Scoring</div>
                                <div class="stat-value" id="kpiPendingCount">0</div>
                            </div>
                            <div class="stat-card income">
                                <div class="stat-label">Scored This Period</div>
                                <div class="stat-value" id="kpiScoredCount">0</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">Average Score</div>
                                <div class="stat-value" id="kpiAvgScore">-</div>
                            </div>
                        </div>
                        
                        <!-- KPI Sub-tabs -->
                        <div class="tabs secondary" style="margin-bottom: 20px;">
                            <button class="tab active" onclick="showKPITab('overview')">
                                <i class="fas fa-th-large"></i> Overview
                            </button>
                            <button class="tab" onclick="showKPITab('report')">
                                <i class="fas fa-chart-bar"></i> KPI Report
                            </button>
                            <button class="tab" onclick="showKPITab('templates')">
                                <i class="fas fa-clipboard-list"></i> Templates
                            </button>
                        </div>
                        
                        <!-- KPI Overview Section -->
                        <div id="kpiOverviewSection">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                                <div style="display: flex; gap: 10px; align-items: center;">
                                    <input type="month" id="kpiPeriodFilter" class="form-control" style="width: 180px;" 
                                           onchange="filterKPIByPeriod()">
                                    <button class="btn-outline" onclick="document.getElementById('kpiPeriodFilter').value=''; filterKPIByPeriod();">
                                        <i class="fas fa-times"></i> Clear
                                    </button>
                                </div>
                                <button class="btn-primary" onclick="showAssignKPIModal()">
                                    <i class="fas fa-user-plus"></i> Assign KPI
                                </button>
                            </div>
                            <div class="kpi-overview-grid" id="kpiOverviewGrid">
                                <div class="empty-state" style="grid-column: 1/-1;">
                                    <i class="fas fa-chart-bar"></i>
                                    <h4>No KPI Assignments</h4>
                                    <p>Assign KPIs to employees to track performance</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- KPI Report Section (Auto-Generate) -->
                        <div id="kpiReportSection" style="display: none;">
                            <div class="section-header" style="margin-bottom: 20px;">
                                <h3><i class="fas fa-user-chart"></i> Staff Performance Scorecard</h3>
                                <p style="color: #666; margin-top: 5px;">Comprehensive employee performance evaluation combining sales, attendance, tasks & quality metrics</p>
                            </div>
                            
                            <!-- Report Filters -->
                            <div style="display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap; align-items: center;">
                                <select id="kpiReportEmployee" class="form-control" style="width: 200px;" onchange="loadKPIReport()">
                                    <option value="">All Employees</option>
                                </select>
                                <input type="month" id="kpiReportMonth" class="form-control" style="width: 180px;" onchange="loadKPIReport()">
                                <select id="kpiReportDepartment" class="form-control" style="width: 180px;" onchange="loadKPIReport()">
                                    <option value="">All Departments</option>
                                </select>
                                <button class="btn-primary" onclick="generateStaffScorecard()">
                                    <i class="fas fa-sync"></i> Generate Scorecard
                                </button>
                                <button class="btn-outline" onclick="exportStaffScorecard()">
                                    <i class="fas fa-file-pdf"></i> Export PDF
                                </button>
                            </div>
                            
                            <!-- Performance Summary Stats -->
                            <div class="stats-grid" style="margin-bottom: 20px;">
                                <div class="stat-card income">
                                    <div class="stat-label">Avg Performance</div>
                                    <div class="stat-value" id="kpiAvgPerformance">-</div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-label">Top Performers</div>
                                    <div class="stat-value" id="kpiTopPerformers">0</div>
                                </div>
                                <div class="stat-card warning">
                                    <div class="stat-label">Needs Improvement</div>
                                    <div class="stat-value" id="kpiNeedsImprovement">0</div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-label">Employees Evaluated</div>
                                    <div class="stat-value" id="kpiEmployeesEvaluated">0</div>
                                </div>
                            </div>
                            
                            <!-- Performance Scorecards Container -->
                            <div id="staffScorecardContainer">
                                <div style="text-align: center; padding: 60px; color: #666; background: #f8fafc; border-radius: 12px;">
                                    <i class="fas fa-clipboard-check" style="font-size: 48px; margin-bottom: 15px; display: block; color: #94a3b8;"></i>
                                    <h4 style="margin: 0 0 10px 0; color: #475569;">Generate Staff Scorecards</h4>
                                    <p style="margin: 0;">Select a month and click "Generate Scorecard" to evaluate employee performance</p>
                                </div>
                            </div>
                            
                            <!-- Performance Comparison Table (Hidden by default) -->
                            <div id="performanceComparisonSection" style="display: none; margin-top: 30px;">
                                <h4 style="margin-bottom: 15px;"><i class="fas fa-chart-bar"></i> Performance Comparison</h4>
                                <div class="table-container">
                                    <table class="data-table">
                                        <thead>
                                            <tr>
                                                <th>Rank</th>
                                                <th>Employee</th>
                                                <th>Department</th>
                                                <th>Sales</th>
                                                <th>Attendance</th>
                                                <th>Tasks</th>
                                                <th>Quality</th>
                                                <th>Overall</th>
                                                <th>Rating</th>
                                            </tr>
                                        </thead>
                                        <tbody id="performanceComparisonBody">
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            </div>
                        </div>
                        
                        <!-- KPI Templates Section -->
                        <div id="kpiTemplatesSection" style="display: none;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 20px;">
                                <button class="btn-outline" onclick="resetKPITemplates()">
                                    <i class="fas fa-sync"></i> Load Default Templates
                                </button>
                                <button class="btn-primary" onclick="showKPITemplateModal()">
                                    <i class="fas fa-plus"></i> Create Template
                                </button>
                            </div>
                            <div class="kpi-templates-grid" id="kpiTemplatesGrid">
                                <!-- Templates will be loaded here -->
                            </div>
                        </div>
                    </div>
                </div>
            
            <!-- ==================== EMPLOYEES SECTION ==================== -->
            <div id="employees" class="content-section">
                <div class="content-card full-width">
                    <div class="card-header">
                        <h2><i class="fas fa-users"></i> Employee Directory</h2>
                        <div style="display: flex; gap: 10px;">
                            <button class="btn-outline" onclick="exportEmployeesToExcel()">
                                <i class="fas fa-download"></i> Export
                            </button>
                            <button class="btn-primary" onclick="showEmployeeModal()">
                                <i class="fas fa-user-plus"></i> Add Employee
                            </button>
                        </div>
                    </div>
                    
                    <!-- Employee Stats -->
                    <div class="stats-grid" style="margin-bottom: 20px;">
                        <div class="stat-card">
                            <div class="stat-label">Total Employees</div>
                            <div class="stat-value" id="empTotalCount">0</div>
                        </div>
                        <div class="stat-card income">
                            <div class="stat-label">Active</div>
                            <div class="stat-value" id="empActiveCount">0</div>
                        </div>
                        <div class="stat-card warning">
                            <div class="stat-label">On Leave</div>
                            <div class="stat-value" id="empOnLeaveCount">0</div>
                        </div>
                        <div class="stat-card expense">
                            <div class="stat-label">Inactive</div>
                            <div class="stat-value" id="empInactiveCount">0</div>
                        </div>
                    </div>
                    
                    <!-- Filters -->
                    <div style="display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap;">
                        <input type="text" id="empDirectorySearch" placeholder="Search employees..." 
                               class="form-control" style="flex: 1; min-width: 200px;" 
                               oninput="filterEmployeeDirectory()">
                        <select id="empDirectoryStatus" class="form-control" style="width: 150px;" onchange="filterEmployeeDirectory()">
                            <option value="all">All Status</option>
                            <option value="active">Active</option>
                            <option value="inactive">Inactive</option>
                        </select>
                        <select id="empDirectoryDept" class="form-control" style="width: 180px;" onchange="filterEmployeeDirectory()">
                            <option value="all">All Departments</option>
                        </select>
                    </div>
                    
                    <!-- Employees Grid -->
                    <div class="employees-grid" id="employeeDirectoryGrid">
                        <div class="empty-state">
                            <i class="fas fa-users"></i>
                            <h4>No employees yet</h4>
                            <p>Add your first employee to get started</p>
                            <button class="btn-primary" onclick="showEmployeeModal()" style="margin-top: 15px;">
                                <i class="fas fa-plus"></i> Add Employee
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- ==================== LEAVE & ATTENDANCE SECTION ==================== -->
            <div id="leave-attendance" class="content-section">
                <div class="content-card full-width">
                    <div class="card-header">
                        <h2><i class="fas fa-calendar-check"></i> Leave & Attendance</h2>
                        <div style="display: flex; gap: 10px;">
                            <button class="btn-outline" onclick="showLeaveBalanceModal()">
                                <i class="fas fa-chart-pie"></i> Leave Balances
                            </button>
                            <button class="btn-primary" onclick="showLeaveRequestModal()">
                                <i class="fas fa-plus"></i> New Leave Request
                            </button>
                        </div>
                    </div>
                    
                    <!-- Leave & Attendance Tabs -->
                    <div class="tabs" style="margin-bottom: 20px;">
                        <button class="tab active" onclick="showLATab('leave')">
                            <i class="fas fa-calendar-alt"></i> Leave Requests
                        </button>
                        <button class="tab" onclick="showLATab('attendance')">
                            <i class="fas fa-clock"></i> Attendance
                        </button>
                        <button class="tab" onclick="showLATab('calendar')">
                            <i class="fas fa-calendar"></i> Calendar
                        </button>
                    </div>
                    
                    <!-- Leave Tab -->
                    <div id="laLeaveTab">
                        <!-- Leave Stats -->
                        <div class="stats-grid" style="margin-bottom: 20px;">
                            <div class="stat-card warning">
                                <div class="stat-label">Pending Requests</div>
                                <div class="stat-value" id="laPendingCount">0</div>
                            </div>
                            <div class="stat-card income">
                                <div class="stat-label">Approved This Month</div>
                                <div class="stat-value" id="laApprovedCount">0</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">On Leave Today</div>
                                <div class="stat-value" id="laOnTodayCount">0</div>
                            </div>
                            <div class="stat-card expense">
                                <div class="stat-label">Rejected</div>
                                <div class="stat-value" id="laRejectedCount">0</div>
                            </div>
                        </div>
                        
                        <!-- Leave Filters -->
                        <div style="display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap; align-items: center;">
                            <select id="laLeaveStatusFilter" class="form-control" style="width: 150px;" onchange="loadLALeaveRequests()">
                                <option value="">All Status</option>
                                <option value="pending">Pending</option>
                                <option value="approved">Approved</option>
                                <option value="rejected">Rejected</option>
                            </select>
                            <select id="laLeaveEmployeeFilter" class="form-control" style="width: 200px;" onchange="loadLALeaveRequests()">
                                <option value="">All Employees</option>
                            </select>
                            <input type="month" id="laLeaveMonthFilter" class="form-control" style="width: 150px;" onchange="loadLALeaveRequests()">
                        </div>
                        
                        <!-- Leave Requests Table -->
                        <div class="table-container">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Employee</th>
                                        <th>Leave Type</th>
                                        <th>From</th>
                                        <th>To</th>
                                        <th>Days</th>
                                        <th>Reason</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="laLeaveRequestsBody">
                                    <tr>
                                        <td colspan="8" style="text-align: center; color: #64748b; padding: 40px;">
                                            <i class="fas fa-calendar-times" style="font-size: 40px; margin-bottom: 10px; display: block;"></i>
                                            No leave requests found
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <!-- Attendance Tab -->
                    <div id="laAttendanceTab" style="display: none;">
                        <!-- Attendance Stats -->
                        <div class="stats-grid" style="margin-bottom: 20px;">
                            <div class="stat-card income">
                                <div class="stat-label">Present Today</div>
                                <div class="stat-value" id="laPresentCount">0</div>
                            </div>
                            <div class="stat-card warning">
                                <div class="stat-label">Late Today</div>
                                <div class="stat-value" id="laLateCount">0</div>
                            </div>
                            <div class="stat-card expense">
                                <div class="stat-label">Absent Today</div>
                                <div class="stat-value" id="laAbsentCount">0</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">On Leave</div>
                                <div class="stat-value" id="laOnLeaveAttCount">0</div>
                            </div>
                        </div>
                        
                        <!-- Quick Clock Section -->
                        <div class="attendance-clock-section" style="background: linear-gradient(135deg, #f8fafc, #f1f5f9); border-radius: 12px; padding: 20px; margin-bottom: 20px; display: flex; gap: 20px; align-items: center; flex-wrap: wrap;">
                            <div style="flex: 1; min-width: 200px;">
                                <h4 style="margin: 0 0 10px;"><i class="fas fa-clock"></i> Quick Clock In/Out</h4>
                                <select id="laClockEmployee" class="form-control" style="width: 100%;">
                                    <option value="">Select Employee</option>
                                </select>
                            </div>
                            <div style="display: flex; gap: 10px;">
                                <button class="btn-primary" onclick="clockInLA()">
                                    <i class="fas fa-sign-in-alt"></i> Clock In
                                </button>
                                <button class="btn-outline" onclick="clockOutLA()">
                                    <i class="fas fa-sign-out-alt"></i> Clock Out
                                </button>
                            </div>
                        </div>
                        
                        <!-- Attendance Table -->
                        <div class="table-container">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Employee</th>
                                        <th>Date</th>
                                        <th>Clock In</th>
                                        <th>Clock Out</th>
                                        <th>Hours</th>
                                        <th>Status</th>
                                        <th>Notes</th>
                                    </tr>
                                </thead>
                                <tbody id="laAttendanceBody">
                                    <tr>
                                        <td colspan="7" style="text-align: center; color: #64748b; padding: 40px;">
                                            <i class="fas fa-clock" style="font-size: 40px; margin-bottom: 10px; display: block;"></i>
                                            No attendance records found
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <!-- Calendar Tab -->
                    <div id="laCalendarTab" style="display: none;">
                        <div style="background: #f8fafc; border-radius: 12px; padding: 20px; text-align: center;">
                            <i class="fas fa-calendar" style="font-size: 60px; color: #0d6efd; margin-bottom: 15px;"></i>
                            <h4>Leave & Attendance Calendar</h4>
                            <p style="color: #64748b;">Visual calendar showing leave and attendance overview</p>
                            <div id="laCalendarView" style="margin-top: 20px;">
                                <!-- Calendar will be rendered here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- ==================== CRM SECTION ==================== -->
            <div id="crm" class="content-section">
                <div class="content-card full-width">
                    <div class="card-header">
                        <h2><i class="fas fa-users"></i> Customer Relationship Management</h2>
                        <div style="display: flex; gap: 10px;">
                            <button class="btn-outline" onclick="exportCustomersToExcel()" title="Export to Excel">
                                <i class="fas fa-file-excel"></i> Excel
                            </button>
                            <button class="btn-primary" onclick="showCRMCustomerModal()">
                                <i class="fas fa-plus"></i> Add Customer
                            </button>
                        </div>
                    </div>
                    
                    <!-- CRM Stats -->
                    <div class="stats-grid" style="margin-bottom: 20px;">
                        <div class="stat-card">
                            <div class="stat-label">Total Customers</div>
                            <div class="stat-value" id="crmTotalCustomers">0</div>
                        </div>
                        <div class="stat-card income">
                            <div class="stat-label">VIP Customers</div>
                            <div class="stat-value" id="crmVIPCustomers">0</div>
                        </div>
                        <div class="stat-card warning">
                            <div class="stat-label">Outstanding Balance</div>
                            <div class="stat-value" id="crmOutstandingBalance">RM 0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">This Month Sales</div>
                            <div class="stat-value" id="crmThisMonthSales">RM 0</div>
                        </div>
                    </div>
                    
                    <!-- CRM Filters -->
                    <div style="display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap;">
                        <input type="text" id="crmSearch" placeholder="Search customers..." 
                               class="form-control" style="flex: 1; min-width: 200px;" 
                               oninput="searchCRMCustomers(this.value)">
                        <select id="crmGroupFilter" class="form-control" style="width: 150px;" onchange="filterCRMCustomers()">
                            <option value="">All Groups</option>
                            <option value="vip">VIP</option>
                            <option value="b2b">B2B</option>
                            <option value="regular">Regular</option>
                            <option value="new">New</option>
                        </select>
                        <select id="crmStatusFilter" class="form-control" style="width: 150px;" onchange="filterCRMCustomers()">
                            <option value="">All Status</option>
                            <option value="active">Active</option>
                            <option value="inactive">Inactive</option>
                        </select>
                    </div>
                    
                    <!-- Customer Cards View -->
                    <div class="crm-customer-grid" id="crmCustomerGrid">
                        <!-- Customer cards will be loaded here -->
                        <div class="crm-empty">
                            <i class="fas fa-users"></i>
                            <p>No customers yet. Add your first customer!</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- ==================== QUOTATIONS SECTION ==================== -->
            <div id="quotations" class="content-section">
                <div class="content-card full-width">
                    <div class="card-header">
                        <h2><i class="fas fa-file-invoice"></i> Quotations</h2>
                        <button class="btn-primary" onclick="showQuotationModal()">
                            <i class="fas fa-plus"></i> New Quotation
                        </button>
                    </div>
                    
                    <!-- Quotations Stats -->
                    <div class="stats-grid" style="margin-bottom: 20px;">
                        <div class="stat-card">
                            <div class="stat-icon" style="background: linear-gradient(135deg, #3b82f6, #2563eb);">
                                <i class="fas fa-file-alt"></i>
                            </div>
                            <div class="stat-info">
                                <div class="stat-value" id="quotationsTotalCount">0</div>
                                <div class="stat-label">Total Quotations</div>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon" style="background: linear-gradient(135deg, #f59e0b, #d97706);">
                                <i class="fas fa-clock"></i>
                            </div>
                            <div class="stat-info">
                                <div class="stat-value" id="quotationsPending">0</div>
                                <div class="stat-label">Pending</div>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon" style="background: linear-gradient(135deg, #10b981, #059669);">
                                <i class="fas fa-check-circle"></i>
                            </div>
                            <div class="stat-info">
                                <div class="stat-value" id="quotationsAccepted">0</div>
                                <div class="stat-label">Accepted</div>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon" style="background: linear-gradient(135deg, #8b5cf6, #7c3aed);">
                                <i class="fas fa-dollar-sign"></i>
                            </div>
                            <div class="stat-info">
                                <div class="stat-value" id="quotationsTotalValue">RM 0</div>
                                <div class="stat-label">Total Value</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Quotations Filters -->
                    <div class="quotations-filters" style="display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap;">
                        <input type="text" id="quotationSearch" class="form-control" placeholder="Search quotations..." 
                               oninput="searchQuotations(this.value)" style="flex: 1; min-width: 200px;">
                        <select id="quotationStatusFilter" class="form-control" onchange="filterQuotationsByStatus()" style="width: 150px;">
                            <option value="">All Status</option>
                            <option value="draft">Draft</option>
                            <option value="sent">Sent</option>
                            <option value="accepted">Accepted</option>
                            <option value="rejected">Rejected</option>
                            <option value="expired">Expired</option>
                        </select>
                    </div>
                    
                    <!-- Quotations Grid -->
                    <div class="quotations-grid" id="quotationsGrid">
                        <div class="quotations-empty">
                            <i class="fas fa-file-invoice"></i>
                            <p>No quotations yet. Create your first quotation!</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- ==================== INVOICES SECTION ==================== -->
            <div id="invoices" class="content-section">
                <div class="content-card full-width">
                    <div class="card-header">
                        <h2><i class="fas fa-file-invoice-dollar"></i> Invoices</h2>
                        <div style="display: flex; gap: 10px;">
                            <button class="btn-secondary" onclick="showInvoiceTemplateSelector()" title="Choose PDF Template">
                                <i class="fas fa-palette"></i> Template
                            </button>
                            <button class="btn-primary" onclick="showNewInvoiceModal()">
                                <i class="fas fa-plus"></i> New Invoice
                            </button>
                        </div>
                    </div>
                    
                    <!-- Invoice Stats -->
                    <div class="stats-grid" style="margin-bottom: 20px;">
                        <div class="stat-card">
                            <div class="stat-icon" style="background: linear-gradient(135deg, #3b82f6, #2563eb);">
                                <i class="fas fa-file-invoice"></i>
                            </div>
                            <div class="stat-info">
                                <div class="stat-value" id="invoicesTotalCount">0</div>
                                <div class="stat-label">Total Invoices</div>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon" style="background: linear-gradient(135deg, #f59e0b, #d97706);">
                                <i class="fas fa-clock"></i>
                            </div>
                            <div class="stat-info">
                                <div class="stat-value" id="invoicesUnpaid">0</div>
                                <div class="stat-label">Unpaid</div>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon" style="background: linear-gradient(135deg, #ef4444, #dc2626);">
                                <i class="fas fa-exclamation-triangle"></i>
                            </div>
                            <div class="stat-info">
                                <div class="stat-value" id="invoicesOverdue">0</div>
                                <div class="stat-label">Overdue</div>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon" style="background: linear-gradient(135deg, #10b981, #059669);">
                                <i class="fas fa-check-circle"></i>
                            </div>
                            <div class="stat-info">
                                <div class="stat-value" id="invoicesPaid">0</div>
                                <div class="stat-label">Paid</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Outstanding Summary -->
                    <div style="display: flex; gap: 20px; margin-bottom: 20px; flex-wrap: wrap;">
                        <div style="background: linear-gradient(135deg, #1e3a5f 0%, #0f172a 100%); padding: 15px 25px; border-radius: 10px; flex: 1; min-width: 200px;">
                            <div style="color: #94a3b8; font-size: 12px; margin-bottom: 5px;">Total Invoiced</div>
                            <div style="color: #f8fafc; font-size: 24px; font-weight: 700;" id="invoicesTotalValue">RM 0.00</div>
                        </div>
                        <div style="background: linear-gradient(135deg, #7c2d12 0%, #450a0a 100%); padding: 15px 25px; border-radius: 10px; flex: 1; min-width: 200px;">
                            <div style="color: #fca5a5; font-size: 12px; margin-bottom: 5px;">Outstanding Amount</div>
                            <div style="color: #fef2f2; font-size: 24px; font-weight: 700;" id="invoicesOutstanding">RM 0.00</div>
                        </div>
                    </div>
                    
                    <!-- Invoices Filters -->
                    <div style="display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap; align-items: center;">
                        <input type="text" id="invoiceSearch" class="form-control" placeholder="Search invoices..." 
                               oninput="renderInvoices()" style="flex: 1; min-width: 200px;">
                        <select id="invoiceStatusFilter" class="form-control" onchange="renderInvoices()" style="width: 130px;">
                            <option value="">All Status</option>
                            <option value="unpaid">Unpaid</option>
                            <option value="partial">Partial</option>
                            <option value="paid">Paid</option>
                            <option value="cancelled">Cancelled</option>
                            <option value="draft">Draft</option>
                        </select>
                        <input type="date" id="invoiceDateFrom" class="form-control" onchange="renderInvoices()" style="width: 140px;" title="From Date">
                        <input type="date" id="invoiceDateTo" class="form-control" onchange="renderInvoices()" style="width: 140px;" title="To Date">
                    </div>
                    
                    <!-- Invoices Table -->
                    <div class="table-responsive">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Invoice #</th>
                                    <th>Customer</th>
                                    <th>Date</th>
                                    <th>Due Date</th>
                                    <th style="text-align: right;">Total</th>
                                    <th style="text-align: right;">Outstanding</th>
                                    <th>Status</th>
                                    <th style="width: 180px;">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="invoicesTableBody">
                                <tr>
                                    <td colspan="8" style="text-align: center; padding: 40px; color: #94a3b8;">
                                        <i class="fas fa-file-invoice" style="font-size: 48px; margin-bottom: 15px; opacity: 0.5;"></i>
                                        <p>No invoices yet. Click "New Invoice" to create one.</p>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- ==================== PROJECTS SECTION ==================== -->
            <div id="projects" class="content-section">
                <div class="content-card full-width">
                    <div class="card-header">
                        <h2><i class="fas fa-project-diagram"></i> Project Invoices</h2>
                        <button class="btn-primary" onclick="showProjectModal()">
                            <i class="fas fa-plus"></i> New Project
                        </button>
                    </div>
                    
                    <!-- Projects Stats -->
                    <div class="stats-grid" style="margin-bottom: 20px;">
                        <div class="stat-card">
                            <div class="stat-icon" style="background: linear-gradient(135deg, #2563eb, #1d4ed8);">
                                <i class="fas fa-briefcase"></i>
                            </div>
                            <div class="stat-info">
                                <div class="stat-value" id="projectsActive">0</div>
                                <div class="stat-label">Active Projects</div>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon" style="background: linear-gradient(135deg, #8b5cf6, #7c3aed);">
                                <i class="fas fa-coins"></i>
                            </div>
                            <div class="stat-info">
                                <div class="stat-value" id="projectsTotalValue">RM 0</div>
                                <div class="stat-label">Total Value</div>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon" style="background: linear-gradient(135deg, #10b981, #059669);">
                                <i class="fas fa-check-circle"></i>
                            </div>
                            <div class="stat-info">
                                <div class="stat-value" id="projectsReceived">RM 0</div>
                                <div class="stat-label">Received</div>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon" style="background: linear-gradient(135deg, #f59e0b, #d97706);">
                                <i class="fas fa-clock"></i>
                            </div>
                            <div class="stat-info">
                                <div class="stat-value" id="projectsPending">RM 0</div>
                                <div class="stat-label">Pending</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Projects Filters -->
                    <div class="projects-filters" style="display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap;">
                        <input type="text" id="projectSearch" class="form-control" placeholder="Search projects..." 
                               oninput="searchProjects(this.value)" style="flex: 1; min-width: 200px;">
                        <select id="projectStatusFilter" class="form-control" onchange="filterProjects()" style="width: 150px;">
                            <option value="">All Status</option>
                            <option value="quotation">Quotation</option>
                            <option value="confirmed">Confirmed</option>
                            <option value="in-progress">In Progress</option>
                            <option value="completed">Completed</option>
                            <option value="cancelled">Cancelled</option>
                        </select>
                    </div>
                    
                    <!-- Projects Grid -->
                    <div class="projects-grid" id="projectsGrid">
                        <div class="projects-empty">
                            <i class="fas fa-project-diagram"></i>
                            <p>No projects yet. Create your first project!</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Chart of Accounts Section -->
            <div id="chart-of-accounts" class="content-section">
                <div class="content-card full-width">
                    <div id="chartOfAccountsContent">
                        <!-- Chart of Accounts will be rendered here -->
                        <div style="padding: 60px; text-align: center; color: #94a3b8;">
                            <i class="fas fa-sitemap" style="font-size: 48px; margin-bottom: 15px;"></i>
                            <p>Loading Chart of Accounts...</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Journal Entries Section -->
            <div id="journal-entries" class="content-section">
                <div class="content-card full-width">
                    <div id="journalEntriesContent">
                        <!-- Journal Entries will be rendered here -->
                        <div style="padding: 60px; text-align: center; color: #94a3b8;">
                            <i class="fas fa-book" style="font-size: 48px; margin-bottom: 15px;"></i>
                            <p>Loading Journal Entries...</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Aging Reports Section -->
            <div id="aging-reports" class="content-section">
                <div class="content-card full-width">
                    <div id="agingReportsContent">
                        <!-- Aging Reports will be rendered here -->
                        <div style="padding: 60px; text-align: center; color: #94a3b8;">
                            <i class="fas fa-clock" style="font-size: 48px; margin-bottom: 15px;"></i>
                            <p>Loading Aging Reports...</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Transactions Section -->
            <div id="transactions" class="content-section">
                <div class="content-card full-width">
                    <div class="card-header">
                        <h2><i class="fas fa-exchange-alt"></i> All Transactions</h2>
                        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                            <select id="filterCategory" onchange="filterTransactions()" style="width: 150px;">
                                <option value="">All Categories</option>
                                <option value="income">Income</option>
                                <option value="expense">Expense</option>
                            </select>
                            <input type="month" id="filterMonth" onchange="filterTransactions()" style="width: 150px;">
                            <button class="btn-secondary" onclick="clearFilters()">Clear Filters</button>
                            <button class="btn-outline" onclick="exportTransactionsToExcel()" title="Export to Excel">
                                <i class="fas fa-file-excel"></i> Excel
                            </button>
                            <button class="btn-outline" onclick="exportTransactionsCSV()" title="Export to CSV">
                                <i class="fas fa-file-csv"></i> CSV
                            </button>
                        </div>
                    </div>
                    
                    <div class="transaction-list" id="allTransactions">
                        <!-- All transactions will be loaded here -->
                    </div>
                </div>
            </div>
            
            <!-- Record Income Section -->
            <div id="income" class="content-section">
                <div class="content-card full-width">
                    <div class="card-header">
                        <h2><i class="fas fa-money-bill-wave"></i> Record Income</h2>
                        <div style="font-size: 14px; color: #10b981;">
                            <i class="fas fa-info-circle"></i> Money coming into your business (RM)
                        </div>
                    </div>
                    
                    <div class="transaction-form">
                        <div class="form-row">
                            <div class="form-group">
                                <label>Date <span class="help-tooltip" title="When did you receive this money?">?</span></label>
                                <input type="date" id="incomeDate" value="">
                            </div>
                            <div class="form-group">
                                <label>Amount (RM) <span class="help-tooltip" title="How much money did you receive?">?</span></label>
                                <input type="number" id="incomeAmount" placeholder="0.00" step="0.01">
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>Description <span class="help-tooltip" title="What was this income for? (e.g., 'Product sales', 'Service fee')">?</span></label>
                            <input type="text" id="incomeDescription" placeholder="e.g., Product sales for March">
                        </div>
                        
                        <div class="form-group">
                            <label>Category <span class="help-tooltip" title="What type of income is this?">?</span></label>
                            <select id="incomeCategory">
                                <option value="sales">Sales Revenue</option>
                                <option value="service">Service Income</option>
                                <option value="rental">Rental Income</option>
                                <option value="interest">Interest Income</option>
                                <option value="other">Other Income</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label>Payment Method <span class="help-tooltip" title="How did you receive this money?">?</span></label>
                            <select id="incomeMethod">
                                <option value="cash">Cash</option>
                                <option value="bank">Bank Transfer</option>
                                <option value="card">Credit/Debit Card</option>
                                <option value="ewallet">E-Wallet (Touch n Go, GrabPay)</option>
                                <option value="check">Check</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label>Customer Name (Optional)</label>
                            <input type="text" id="incomeCustomer" placeholder="e.g., ABC Sdn Bhd">
                        </div>
                        
                        <!-- Success Message Container -->
                        <div id="incomeSuccessMessage" style="display: none; padding: 15px; background: linear-gradient(135deg, #10b981, #059669); color: white; border-radius: 10px; margin-bottom: 15px; text-align: center; animation: slideIn 0.3s ease;">
                            <i class="fas fa-check-circle" style="font-size: 24px; margin-bottom: 8px; display: block;"></i>
                            <strong id="incomeSuccessText">Income recorded successfully!</strong>
                        </div>
                        
                        <button class="btn-primary" onclick="addIncome()">
                            <i class="fas fa-check-circle"></i> Record Income
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Record Expenses Section -->
            <div id="expenses" class="content-section">
                <div class="content-card full-width">
                    <div class="card-header">
                        <h2><i class="fas fa-receipt"></i> Record Expenses</h2>
                        <div style="font-size: 14px; color: #ef4444;">
                            <i class="fas fa-info-circle"></i> Money going out of your business (RM)
                        </div>
                    </div>
                    
                    <div class="transaction-form">
                        <div class="form-row">
                            <div class="form-group">
                                <label>Date <span class="help-tooltip" title="When did you make this payment?">?</span></label>
                                <input type="date" id="expenseDate" value="">
                            </div>
                            <div class="form-group">
                                <label>Amount (RM) <span class="help-tooltip" title="How much did you spend?">?</span></label>
                                <input type="number" id="expenseAmount" placeholder="0.00" step="0.01">
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>Description <span class="help-tooltip" title="What did you spend money on?">?</span></label>
                            <input type="text" id="expenseDescription" placeholder="e.g., Office supplies for March">
                        </div>
                        
                        <div class="form-group">
                            <label>Category <span class="help-tooltip" title="What type of expense is this?">?</span></label>
                            <select id="expenseCategory">
                                <option value="rent">Rent</option>
                                <option value="utilities">Utilities (TNB, Water, Internet)</option>
                                <option value="supplies">Office Supplies</option>
                                <option value="salary">Salaries & EPF</option>
                                <option value="marketing">Marketing & Advertising</option>
                                <option value="travel">Travel & Transportation</option>
                                <option value="entertainment">Entertainment</option>
                                <option value="professional">Professional Fees</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label>Vendor/Payee <span class="help-tooltip" title="Who did you pay this money to?">?</span></label>
                            <input type="text" id="expenseVendor" placeholder="e.g., ABC Supplies Sdn Bhd">
                        </div>
                        
                        <div class="form-group">
                            <label>Payment Method <span class="help-tooltip" title="How did you make this payment?">?</span></label>
                            <select id="expenseMethod">
                                <option value="cash">Cash</option>
                                <option value="bank">Bank Transfer</option>
                                <option value="card">Credit/Debit Card</option>
                                <option value="ewallet">E-Wallet</option>
                                <option value="check">Check</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        
                        <!-- Success Message Container -->
                        <div id="expenseSuccessMessage" style="display: none; padding: 15px; background: linear-gradient(135deg, #ef4444, #dc2626); color: white; border-radius: 10px; margin-bottom: 15px; text-align: center; animation: slideIn 0.3s ease;">
                            <i class="fas fa-check-circle" style="font-size: 24px; margin-bottom: 8px; display: block;"></i>
                            <strong id="expenseSuccessText">Expense recorded successfully!</strong>
                        </div>
                        
                        <button class="btn-primary" onclick="addExpense()">
                            <i class="fas fa-check-circle"></i> Record Expense
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Bills to Pay Section -->
            <div id="bills" class="content-section">
                <div class="content-card full-width">
                    <div class="card-header">
                        <h2><i class="fas fa-file-invoice-dollar"></i> Bills to Pay (RM)</h2>
                        <div style="display: flex; gap: 10px;">
                            <button class="btn-outline" onclick="exportBillsToExcel()" title="Export to Excel">
                                <i class="fas fa-file-excel"></i> Excel
                            </button>
                            <button class="btn-primary" onclick="showAddBillModal()">
                                <i class="fas fa-plus"></i> Add Bill
                            </button>
                        </div>
                    </div>
                    
                    <div class="tabs">
                        <button class="tab active" onclick="showBillTab('upcoming')">Upcoming</button>
                        <button class="tab" onclick="showBillTab('overdue')">Overdue</button>
                        <button class="tab" onclick="showBillTab('paid')">Paid</button>
                        <button class="tab" onclick="showBillTab('all')">All Bills</button>
                    </div>
                    
                    <div id="billsContent">
                        <!-- Bills will be loaded here -->
                    </div>
                </div>
            </div>
            
            <!-- Monthly Reports Section -->
            <div id="monthly-reports" class="content-section">
                <div class="content-card full-width">
                    <div class="card-header">
                        <h2><i class="fas fa-chart-bar"></i> Monthly Financial Reports</h2>
                        <div class="chart-controls">
                            <select id="monthlyYearSelect" onchange="updateMonthlyCharts()">
                                <!-- Year options will be populated by JavaScript -->
                            </select>
                            <select id="monthlyChartType" onchange="updateMonthlyCharts()">
                                <option value="bar">Bar Chart</option>
                                <option value="line">Line Chart</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Monthly Revenue vs Expenses Chart -->
                    <div style="margin-bottom: 30px;">
                        <h3 style="margin-bottom: 15px; color: #1e293b;">Monthly Revenue vs Expenses</h3>
                        <div class="monthly-chart-container">
                            <canvas id="monthlyChart"></canvas>
                        </div>
                    </div>
                    
                    <!-- Monthly Breakdown Table -->
                    <div>
                        <h3 style="margin-bottom: 15px; color: #1e293b;">Monthly Breakdown</h3>
                        <div id="monthlyBreakdownTable">
                            <!-- Monthly breakdown table will be loaded here -->
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Financial Reports Section -->
            <div id="reports" class="content-section">
                <div class="content-card full-width">
                    <div class="card-header">
                        <h2><i class="fas fa-chart-pie"></i> Financial Reports</h2>
                        <div style="display: flex; gap: 10px;">
                            <button class="btn-outline" onclick="showEmailReportModal()" title="Email Daily Report">
                                <i class="fas fa-envelope"></i> Email Report
                            </button>
                            <button class="btn-outline" onclick="exportFullFinancialReport()" title="Export Full Report to Excel">
                                <i class="fas fa-file-excel"></i> Excel Report
                            </button>
                            <button class="btn-primary" onclick="exportToPDF()">
                                <i class="fas fa-file-pdf"></i> Export PDF
                            </button>
                        </div>
                    </div>
                    
                    <div class="reports-container">
                        <div class="report-card">
                            <div class="report-header">
                                <h3>Profit & Loss</h3>
                                <select id="reportPeriod" onchange="updateReports()">
                                    <option value="month">This Month</option>
                                    <option value="quarter">This Quarter</option>
                                    <option value="year">This Year</option>
                                </select>
                            </div>
                            <div class="report-value" id="profitLoss">RM 0</div>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: 0%"></div>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-top: 10px;">
                                <span style="color: #10b981;">Revenue: <span id="reportIncome">RM 0</span></span>
                                <span style="color: #ef4444;">Expenses: <span id="reportExpenses">RM 0</span></span>
                            </div>
                        </div>
                        
                        <div class="report-card">
                            <div class="report-header">
                                <h3>Cash Flow</h3>
                                <span style="font-size: 12px; color: #64748b;">Last 6 Months</span>
                            </div>
                            <div class="chart-container">
                                <canvas id="cashFlowChart"></canvas>
                            </div>
                        </div>
                        
                        <div class="report-card">
                            <div class="report-header">
                                <h3>Expense Breakdown</h3>
                                <span style="font-size: 12px; color: #64748b;">Top Categories</span>
                            </div>
                            <div id="expenseBreakdown">
                                <!-- Expense breakdown will be loaded here -->
                            </div>
                        </div>
                        
                        <div class="report-card">
                            <div class="report-header">
                                <h3>Revenue Sources</h3>
                                <span style="font-size: 12px; color: #64748b;">This Year</span>
                            </div>
                            <div id="incomeSources">
                                <!-- Income sources will be loaded here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Balance Sheet Section -->
            <div id="balance-sheet" class="content-section">
                <div class="content-card full-width">
                    <div class="card-header">
                        <h2><i class="fas fa-chart-line"></i> My Financial Position</h2>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <select id="balanceSheetDate" onchange="updateSimpleBalanceSheet()">
                                <option value="current">Now</option>
                                <option value="last-month">Last Month</option>
                                <option value="last-quarter">Last 3 Months</option>
                                <option value="last-year">Last Year</option>
                            </select>
                            <button class="btn-primary" onclick="exportSimpleBalanceSheet()">
                                <i class="fas fa-download"></i> Save
                            </button>
                        </div>
                    </div>
                    
                    <!-- View Toggle - Simple/Double-Entry/History -->
                    <div class="view-toggle" style="margin-bottom: 20px;">
                        <button class="view-toggle-btn active" onclick="setBalanceSheetView('simple')">
                            <i class="fas fa-eye"></i> Simple View
                        </button>
                        <button class="view-toggle-btn" onclick="setBalanceSheetView('double-entry'); displayEnhancedBalanceSheet();">
                            <i class="fas fa-balance-scale-left"></i> Double-Entry
                        </button>
                        <button class="view-toggle-btn" onclick="setBalanceSheetView('history')">
                            <i class="fas fa-history"></i> History
                        </button>
                    </div>
                    
                    <!-- Combined Balance Sheet View (Simple + Detailed) -->
                    <div id="simpleBalanceView" class="balance-view active">
                        <!-- Simple Summary will be populated by JavaScript -->
                        <div id="simpleBalanceSummary"></div>
                        
                        <!-- Detailed Balance Sheet Below -->
                        <div class="detailed-balance-sheet" style="margin-top: 30px;">
                            <h3 style="margin-bottom: 20px; color: #334155;"><i class="fas fa-table"></i> Detailed Breakdown</h3>
                            <div class="balance-sheet-grid">
                                <!-- Assets Column -->
                                <div class="balance-column assets-column">
                                    <h3><i class="fas fa-wallet"></i> What I Have (Assets)</h3>
                                    
                                    <!-- Current Assets -->
                                    <div class="balance-section">
                                        <h4>Cash & Bank</h4>
                                        <div class="balance-items" id="bankAccountsList">
                                            <div class="balance-item">
                                                <span>Cash in Hand</span>
                                                <span class="balance-amount" id="bs-cash">RM 0.00</span>
                                            </div>
                                            <!-- Bank accounts will be loaded dynamically -->
                                        </div>
                                        <button class="add-balance-btn" onclick="showAddBankAccountModal()" style="margin-top: 10px;">
                                            <i class="fas fa-plus"></i> Add Bank Account
                                        </button>
                                    </div>
                                    
                                    <!-- Fixed Assets -->
                                    <div class="balance-section">
                                        <h4>Fixed Assets</h4>
                                        <div class="balance-items" id="fixedAssetsList">
                                            <div class="balance-item">
                                                <span>Equipment</span>
                                                <span class="balance-amount">RM <input type="number" class="balance-input" id="bs-equipment" placeholder="0.00" step="0.01" oninput="updateDetailedBalanceTotals()"></span>
                                            </div>
                                            <div class="balance-item">
                                                <span>Vehicle</span>
                                                <span class="balance-amount">RM <input type="number" class="balance-input" id="bs-vehicle" placeholder="0.00" step="0.01" oninput="updateDetailedBalanceTotals()"></span>
                                            </div>
                                            <div class="balance-item">
                                                <span>Furniture</span>
                                                <span class="balance-amount">RM <input type="number" class="balance-input" id="bs-furniture" placeholder="0.00" step="0.01" oninput="updateDetailedBalanceTotals()"></span>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="balance-total">
                                        <span>TOTAL ASSETS</span>
                                        <span class="total-amount" id="detailed-total-assets">RM 0.00</span>
                                    </div>
                                </div>
                                
                                <!-- Liabilities Column -->
                                <div class="balance-column liabilities-column">
                                    <h3><i class="fas fa-credit-card"></i> What I Owe (Liabilities)</h3>
                                    
                                    <!-- Current Liabilities -->
                                    <div class="balance-section">
                                        <h4>Short-term Debts</h4>
                                        <div class="balance-items" id="currentLiabilities">
                                            <!-- Bills from system will appear here -->
                                        </div>
                                    </div>
                                    
                                    <!-- Long-term Liabilities -->
                                    <div class="balance-section">
                                        <h4>Long-term Loans</h4>
                                        <div class="balance-items">
                                            <div class="balance-item">
                                                <span>Business Loan</span>
                                                <span class="balance-amount">RM <input type="number" class="balance-input" id="bs-loan" placeholder="0.00" step="0.01" oninput="updateDetailedBalanceTotals()"></span>
                                            </div>
                                            <div class="balance-item">
                                                <span>Car Loan</span>
                                                <span class="balance-amount">RM <input type="number" class="balance-input" id="bs-car-loan" placeholder="0.00" step="0.01" oninput="updateDetailedBalanceTotals()"></span>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Credit Cards -->
                                    <div class="balance-section">
                                        <h4>Credit Cards</h4>
                                        <div class="balance-items" id="creditCardsList">
                                            <!-- Credit cards will be loaded dynamically -->
                                        </div>
                                        <button class="add-balance-btn" onclick="showAddCreditCardModal()" style="margin-top: 10px;">
                                            <i class="fas fa-plus"></i> Add Credit Card
                                        </button>
                                    </div>
                                    
                                    <div class="balance-total">
                                        <span>TOTAL LIABILITIES</span>
                                        <span class="total-amount" id="detailed-total-liabilities">RM 0.00</span>
                                    </div>
                                </div>
                                
                                <!-- Equity Column -->
                                <div class="balance-column equity-column">
                                    <h3><i class="fas fa-chart-line"></i> My Business Value (Equity)</h3>
                                    
                                    <div class="balance-section">
                                        <h4>Owner's Capital</h4>
                                        <div class="balance-items">
                                            <div class="balance-item">
                                                <span>Starting Capital</span>
                                                <span class="balance-amount">RM <input type="number" class="balance-input" id="bs-starting-capital" placeholder="0.00" step="0.01" oninput="updateDetailedBalanceTotals()"></span>
                                            </div>
                                            <div class="balance-item">
                                                <span>Additional Investment</span>
                                                <span class="balance-amount">RM <input type="number" class="balance-input" id="bs-additional-investment" placeholder="0.00" step="0.01" oninput="updateDetailedBalanceTotals()"></span>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="balance-section">
                                        <h4>Profits & Losses</h4>
                                        <div class="balance-items">
                                            <div class="balance-item">
                                                <span>This Year's Profit</span>
                                                <span class="balance-amount">RM <input type="number" class="balance-input" id="bs-current-profit" placeholder="0.00" step="0.01" oninput="updateDetailedBalanceTotals()"></span>
                                            </div>
                                            <div class="balance-item">
                                                <span>Accumulated Profit</span>
                                                <span class="balance-amount">RM <input type="number" class="balance-input" id="bs-accumulated-profit" placeholder="0.00" step="0.01" oninput="updateDetailedBalanceTotals()"></span>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="balance-total">
                                        <span>TOTAL EQUITY</span>
                                        <span class="total-amount" id="detailed-total-equity">RM 0.00</span>
                                    </div>
                                    
                                    <!-- Equation Check -->
                                    <div class="equation-check" style="margin-top: 20px; padding: 15px; background: #f8fafc; border-radius: 8px; text-align: center;">
                                        <div style="margin-bottom: 10px; color: #64748b;">
                                            <i class="fas fa-calculator"></i> Balance Check
                                        </div>
                                        <div style="font-size: 18px; font-weight: 600; color: #10b981;" id="balance-check-result">
                                             Balanced
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Save Button -->
                            <div style="text-align: center; margin-top: 30px;">
                                <button class="btn-primary" onclick="saveDetailedBalanceSheet()">
                                    <i class="fas fa-save"></i> Save All Changes
                                </button>
                                <button class="btn-secondary" onclick="resetBalanceSheetInputs()" style="margin-left: 10px;">
                                    <i class="fas fa-undo"></i> Reset Changes
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Historical Balance Sheet View -->
                    <div id="historyBalanceView" class="balance-view">
                        <div class="balance-history">
                            <h3><i class="fas fa-history"></i> Balance Sheet History</h3>
                            <div style="margin-bottom: 20px;">
                                <select id="historyPeriod" onchange="loadBalanceHistory()">
                                    <option value="monthly">Monthly (Last 12 months)</option>
                                    <option value="quarterly">Quarterly (Last 4 quarters)</option>
                                    <option value="yearly">Yearly (Last 5 years)</option>
                                </select>
                            </div>
                            
                            <div id="balanceHistoryChart" style="height: 300px; margin-bottom: 30px;">
                                <!-- Chart will be loaded here -->
                            </div>
                            
                            <div id="balanceHistoryTable">
                                <!-- Table will be loaded here -->
                            </div>
                        </div>
                    </div>
                    
                    <!-- Simple Equation -->
                    <div class="simple-equation" style="margin-top: 30px;">
                        <div class="equation-item assets">
                            <div class="equation-label">Money I Have</div>
                            <div class="equation-value" style="color: #2563eb;">RM <span id="bs-assets">0.00</span></div>
                        </div>
                        
                        <div class="equation-operator">-</div>
                        
                        <div class="equation-item liabilities">
                            <div class="equation-label">Money I Owe</div>
                            <div class="equation-value" style="color: #ef4444;">RM <span id="bs-liabilities">0.00</span></div>
                        </div>
                        
                        <div class="equation-operator">=</div>
                        
                        <div class="equation-item equity">
                            <div class="equation-label">My Net Worth</div>
                            <div class="equation-value" style="color: #10b981;">RM <span id="bs-equity">0.00</span></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Malaysian Taxes Section -->
            <div id="taxes" class="content-section">
                <div class="content-card full-width">
                    <div class="card-header">
                        <h2><i class="fas fa-calculator"></i> Malaysian Tax Center</h2>
                        <div style="font-size: 14px; color: #64748b;">
                            <i class="fas fa-exclamation-triangle"></i> Estimates only - consult a tax professional
                        </div>
                    </div>
                    
                    <!-- Tax Tabs -->
                    <div class="tax-tabs">
                        <div class="tabs">
                            <button class="tab active" onclick="showTaxTab('corporate')">Corporate Tax</button>
                            <button class="tab" onclick="showTaxTab('personal')">Personal Income Tax</button>
                            <button class="tab" onclick="showTaxTab('sst')">SST Calculator</button>
                            <button class="tab" onclick="showTaxTab('einvoice')">
                                <i class="fas fa-file-invoice"></i> e-Invoice
                            </button>
                        </div>
                    </div>
                    
                    <!-- Corporate Tax Tab -->
                    <div id="corporate-tax" class="tax-tab-content active">
                        <div class="tax-estimator">
                            <h3>Estimated Corporate Tax Liability (RM)</h3>
                            <div class="tax-amount" id="corporateTaxAmount">RM 0</div>
                            <div style="text-align: center; margin-bottom: 20px; opacity: 0.9;">
                                Based on Year-to-Date Income
                            </div>
                            
                            <div class="tax-breakdown">
                                <div style="margin-bottom: 10px;">
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                        <span>Total Revenue:</span>
                                        <span id="corporateTaxIncome">RM 0</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                        <span>Total Expenses:</span>
                                        <span id="corporateTaxExpenses">RM 0</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px; font-weight: 600;">
                                        <span>Taxable Profit:</span>
                                        <span id="corporateTaxProfit">RM 0</span>
                                    </div>
                                    <hr style="margin: 10px 0; border-color: rgba(255,255,255,0.2);">
                                    
                                    <div class="tax-slider-container">
                                        <div class="tax-slider-label">
                                            <span>Tax Rate:</span>
                                            <span id="corporateTaxRateValue">17%</span>
                                        </div>
                                        <input type="range" id="corporateTaxRate" min="0" max="30" value="17" step="0.5" style="width: 100%;">
                                        <div style="display: flex; justify-content: space-between; font-size: 12px; margin-top: 5px;">
                                            <span>0%</span>
                                            <span>Malaysian Corporate Tax Range: 0-24%</span>
                                            <span>30%</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Malaysian Corporate Tax Rates Table -->
                        <div style="margin-top: 20px;">
                            <h3 style="margin-bottom: 15px;">Malaysian Corporate Tax Rates 2024</h3>
                            <table class="tax-rate-table">
                                <thead>
                                    <tr>
                                        <th>Taxable Income (RM)</th>
                                        <th>Tax Rate</th>
                                        <th>Tax Amount (RM)</th>
                                    </tr>
                                </thead>
                                <tbody id="malaysianTaxTable">
                                    <!-- Will be populated by JavaScript -->
                                </tbody>
                            </table>
                            <div style="font-size: 12px; color: #64748b; margin-top: 10px; text-align: center;">
                                <i class="fas fa-info-circle"></i> Rates for companies with paid-up capital  RM2.5 million
                            </div>
                        </div>
                        
                        <!-- Tax Planning -->
                        <div style="margin-top: 20px;">
                            <h3 style="margin-bottom: 15px;">Tax Planning</h3>
                            <div style="background: #f8fafc; padding: 15px; border-radius: 8px;">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                                    <span>Estimated Monthly Instalment (CP204):</span>
                                    <span style="font-weight: 600;" id="cp204Payment">RM 0</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                                    <span>Next Due Date:</span>
                                    <span style="font-weight: 600;" id="nextTaxDate">-</span>
                                </div>
                                <div style="font-size: 12px; color: #64748b; margin-top: 10px;">
                                    <i class="fas fa-info-circle"></i> CP204 instalments due by 30th of each second month
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Personal Tax Tab -->
                    <div id="personal-tax" class="tax-tab-content">
                        <div class="personal-tax-grid">
                            <div class="content-card">
                                <h3><i class="fas fa-calculator"></i> Income & Reliefs (Year 2024/25)</h3>
                                
                                <div style="margin-top:15px; background: #eff6ff; padding:15px; border-radius:8px;">
                                    <div class="relief-item">
                                        <label><strong>Business Net Profit (Auto)</strong></label>
                                        <input type="text" id="tax-biz-profit" disabled value="0.00" style="background:#e2e8f0; font-weight:bold;">
                                    </div>
                                    <div class="relief-item">
                                        <label>Employment Income (Gross)</label>
                                        <input type="number" id="tax-employment" value="0" min="0" max="10000000" oninput="validateTaxInput(this, 10000000)">
                                    </div>
                                </div>

                                <h4 style="margin:15px 0 10px; color:#2563eb;">Tax Reliefs (Pelepasan Cukai)</h4>
                                
                                <div class="relief-item">
                                    <label>Individual (Self)</label>
                                    <input type="number" value="9000" disabled style="background:#f1f5f9;">
                                </div>
                                <div class="relief-item">
                                    <label>EPF / KWSP (Max 4,000)</label>
                                    <input type="number" id="relief-epf" placeholder="0" max="4000" min="0" oninput="validateTaxInput(this, 4000)">
                                </div>
                                <div class="relief-item">
                                    <label>Life Insurance (Max 3,000)</label>
                                    <input type="number" id="relief-life" placeholder="0" max="3000" min="0" oninput="validateTaxInput(this, 3000)">
                                </div>
                                <div class="relief-item">
                                    <label>Lifestyle (Books, Gym, Tech) (Max 2,500)</label>
                                    <input type="number" id="relief-lifestyle" placeholder="0" max="2500" min="0" oninput="validateTaxInput(this, 2500)">
                                </div>
                                <div class="relief-item">
                                    <label>Medical (Parents/Self) (Max 10,000)</label>
                                    <input type="number" id="relief-medical" placeholder="0" max="10000" min="0" oninput="validateTaxInput(this, 10000)">
                                </div>
                                 <div class="relief-item">
                                    <label>Zakat / Fitrah (Rebate)</label>
                                    <input type="number" id="tax-zakat" placeholder="0" style="border-color:#10b981;" min="0" oninput="validateTaxInput(this, 1000000)">
                                </div>
                            </div>

                            <div class="content-card tax-summary-card">
                                <h3>Estimated Personal Tax Payable</h3>
                                <div style="font-size: 36px; font-weight: 700; margin: 10px 0 20px; color: white;">
                                    RM <span id="personal-tax-amount">0.00</span>
                                </div>
                                
                                <div class="progress-container">
                                    <div style="display:flex; justify-content:space-between; font-size:12px; margin-bottom:5px;">
                                        <span>Tax Bracket Usage</span>
                                        <span id="bracket-percent">0%</span>
                                    </div>
                                    <div class="progress-bar-dark">
                                        <div class="progress-fill-dark" id="tax-progress"></div>
                                    </div>
                                </div>

                                <div class="tax-row">
                                    <span>Total Gross Income:</span>
                                    <span id="personal-summary-gross">0.00</span>
                                </div>
                                <div class="tax-row">
                                    <span>Total Reliefs Claimed:</span>
                                    <span id="personal-summary-relief">0.00</span>
                                </div>
                                <div class="tax-row" style="font-weight:bold; color:#fff;">
                                    <span>Chargeable Income:</span>
                                    <span id="personal-summary-chargeable">0.00</span>
                                </div>
                                <div class="tax-row">
                                    <span>(-) Zakat Rebate:</span>
                                    <span id="personal-summary-zakat">0.00</span>
                                </div>
                                <div class="tax-total">
                                    <span>TOTAL PAYABLE</span>
                                    <span>RM <span id="personal-summary-payable">0.00</span></span>
                                </div>
                                <p style="font-size:11px; margin-top:20px; color:#94a3b8; text-align:center;">
                                    * Estimate only based on LHDN progressive rates.
                                </p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- SST Calculator Tab -->
                    <div id="sst-tax" class="tax-tab-content">
                        <div class="balance-sheet-grid" style="grid-template-columns: 1fr 1fr;">
                            <!-- SST Calculator Form -->
                            <div class="content-card">
                                <h3><i class="fas fa-calculator" style="color: #f59e0b;"></i> SST Calculator</h3>
                                <p style="color: #64748b; font-size: 13px; margin-bottom: 20px;">
                                    Calculate Sales Tax (10%) and Service Tax (6%) for Malaysian businesses
                                </p>
                                
                                <div class="form-group">
                                    <label>Amount (RM)</label>
                                    <input type="number" id="sstAmount" placeholder="Enter amount" step="0.01" min="0">
                                </div>
                                
                                <div class="form-row">
                                    <div class="form-group">
                                        <label>Tax Type</label>
                                        <select id="sstType" onchange="updateSSTCategories()">
                                            <option value="sales">Sales Tax (Goods) - 10%</option>
                                            <option value="service">Service Tax - 6%</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label>Category</label>
                                        <select id="sstCategory">
                                            <option value="standard">Standard (10%)</option>
                                            <option value="exempt">Exempt (0%)</option>
                                            <option value="zeroRated">Zero-Rated (0%)</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <div class="form-group" style="margin: 15px 0;">
                                    <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                                        <input type="checkbox" id="sstInclusive" style="width: auto;">
                                        <span>Amount already includes SST (Inclusive)</span>
                                    </label>
                                </div>
                                
                                <button class="btn-primary" onclick="calculateAndDisplaySST()" style="width: 100%;">
                                    <i class="fas fa-calculator"></i> Calculate SST
                                </button>
                                
                                <!-- SST Result -->
                                <div id="sstResult" style="margin-top: 20px;"></div>
                            </div>
                            
                            <!-- SST Information Panel -->
                            <div class="content-card">
                                <h3><i class="fas fa-info-circle" style="color: #2563eb;"></i> SST Information</h3>
                                
                                <div style="margin-top: 15px;">
                                    <h4 style="color: #10b981; margin-bottom: 10px;">Sales Tax (10%)</h4>
                                    <p style="color: #64748b; font-size: 13px; margin-bottom: 15px;">
                                        Imposed on manufactured goods sold or disposed in Malaysia. 
                                        Registration required if taxable sales exceed <strong>RM 500,000</strong> annually.
                                    </p>
                                    
                                    <div style="background: #f0fdf4; padding: 10px; border-radius: 6px; margin-bottom: 15px;">
                                        <div style="font-size: 12px; color: #065f46;">
                                            <strong>Taxable goods include:</strong> Electronics, vehicles, alcohol, tobacco, cosmetics
                                        </div>
                                    </div>
                                </div>
                                
                                <div style="margin-top: 20px;">
                                    <h4 style="color: #f59e0b; margin-bottom: 10px;">Service Tax (6%)</h4>
                                    <p style="color: #64748b; font-size: 13px; margin-bottom: 15px;">
                                        Imposed on prescribed taxable services. 
                                        Registration required if taxable services exceed <strong>RM 500,000</strong> annually.
                                    </p>
                                    
                                    <div style="background: #fffbeb; padding: 10px; border-radius: 6px; margin-bottom: 15px;">
                                        <div style="font-size: 12px; color: #92400e;">
                                            <strong>Taxable services include:</strong> F&B, accommodation, professional services, telecommunications, digital services
                                        </div>
                                    </div>
                                </div>
                                
                                <div style="margin-top: 20px; padding: 15px; background: #f8fafc; border-radius: 8px; border: 1px solid #e2e8f0;">
                                    <h4 style="color: #1e293b; margin-bottom: 10px; font-size: 14px;">
                                        <i class="fas fa-exclamation-triangle" style="color: #f59e0b;"></i> Important Deadlines
                                    </h4>
                                    <ul style="font-size: 12px; color: #64748b; margin: 0; padding-left: 20px;">
                                        <li>SST-02 Return: Within 30 days after end of taxable period</li>
                                        <li>Payment: Same deadline as SST-02 submission</li>
                                        <li>Taxable period: Bi-monthly (every 2 months)</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        
                        <!-- SST Summary for Business -->
                        <div class="content-card" style="margin-top: 20px;">
                            <h3><i class="fas fa-chart-bar" style="color: #2563eb;"></i> Your SST Summary (This Year)</h3>
                            <div id="sstSummaryContent">
                                <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-top: 15px;">
                                    <div style="background: linear-gradient(135deg, #10b981, #059669); color: white; padding: 20px; border-radius: 10px; text-align: center;">
                                        <div style="font-size: 12px; opacity: 0.9;">Total Sales (Taxable)</div>
                                        <div style="font-size: 24px; font-weight: 700; margin-top: 5px;" id="sstTotalSales">RM 0</div>
                                    </div>
                                    <div style="background: linear-gradient(135deg, #f59e0b, #d97706); color: white; padding: 20px; border-radius: 10px; text-align: center;">
                                        <div style="font-size: 12px; opacity: 0.9;">Sales Tax Collected</div>
                                        <div style="font-size: 24px; font-weight: 700; margin-top: 5px;" id="sstSalesTax">RM 0</div>
                                    </div>
                                    <div style="background: linear-gradient(135deg, #3b82f6, #2563eb); color: white; padding: 20px; border-radius: 10px; text-align: center;">
                                        <div style="font-size: 12px; opacity: 0.9;">Service Tax Collected</div>
                                        <div style="font-size: 24px; font-weight: 700; margin-top: 5px;" id="sstServiceTax">RM 0</div>
                                    </div>
                                    <div style="background: linear-gradient(135deg, #ef4444, #dc2626); color: white; padding: 20px; border-radius: 10px; text-align: center;">
                                        <div style="font-size: 12px; opacity: 0.9;">Total SST Payable</div>
                                        <div style="font-size: 24px; font-weight: 700; margin-top: 5px;" id="sstTotalPayable">RM 0</div>
                                    </div>
                                </div>
                                
                                <!-- SST Threshold Status -->
                                <div id="sst-threshold-status" style="margin-top: 15px; padding: 12px 15px; background: #f0fdf4; border-radius: 6px; font-size: 13px;">
                                    <span style="color: #10b981;"><i class="fas fa-check-circle"></i> Below threshold. Check your registration status.</span>
                                </div>
                                
                                <div style="margin-top: 15px; padding: 10px; background: #fef3c7; border-radius: 6px; font-size: 12px; color: #92400e;">
                                    <i class="fas fa-lightbulb"></i> <strong>Tip:</strong> Track your SST separately by categorizing income transactions with SST tags. Consult your accountant for accurate SST filing.
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- e-Invoice Tab -->
                    <div id="einvoice-tax" class="tax-tab-content">
                        <div class="balance-sheet-grid" style="grid-template-columns: 1fr;">
                            <!-- e-Invoice Header -->
                            <div class="content-card">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                                    <div>
                                        <h3><i class="fas fa-file-invoice" style="color: #2563eb;"></i> LHDN MyInvois e-Invoice</h3>
                                        <p style="color: #64748b; font-size: 13px; margin: 5px 0 0;">
                                            Electronic invoicing compliance for Malaysian businesses
                                        </p>
                                    </div>
                                    <button class="btn-outline" onclick="showEInvoiceSettings()">
                                        <i class="fas fa-cog"></i> Settings
                                    </button>
                                </div>
                                
                                <!-- Demo Mode Banner -->
                                <div id="einvoiceDemoBanner" style="padding: 15px; border-radius: 8px; margin-bottom: 15px; background: linear-gradient(135deg, #8b5cf6, #6366f1); color: white;">
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <div style="display: flex; align-items: center; gap: 10px;">
                                            <i class="fas fa-flask" style="font-size: 20px;"></i>
                                            <div>
                                                <strong>Demo Mode Available</strong>
                                                <p style="margin: 5px 0 0; opacity: 0.9; font-size: 13px;">
                                                    Test e-Invoice workflow without real LHDN credentials
                                                </p>
                                            </div>
                                        </div>
                                        <button class="btn-primary" onclick="runEInvoiceDemo()" style="background: white; color: #6366f1; border: none;">
                                            <i class="fas fa-play"></i> Run Demo
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- e-Invoice Status Banner -->
                                <div id="einvoiceStatusBanner" style="padding: 15px; border-radius: 8px; margin-bottom: 20px; background: #fef3c7;">
                                    <div style="display: flex; align-items: center; gap: 10px;">
                                        <i class="fas fa-exclamation-circle" style="color: #f59e0b; font-size: 20px;"></i>
                                        <div>
                                            <strong style="color: #92400e;">e-Invoice Not Configured</strong>
                                            <p style="margin: 5px 0 0; color: #a16207; font-size: 13px;">
                                                Configure your LHDN credentials to enable e-Invoice submission.
                                            </p>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- e-Invoice Stats -->
                                <div class="stats-grid" style="margin-bottom: 20px;">
                                    <div class="stat-card">
                                        <div class="stat-label">Total Submissions</div>
                                        <div class="stat-value" id="einvTotalCount">0</div>
                                    </div>
                                    <div class="stat-card income">
                                        <div class="stat-label">Valid</div>
                                        <div class="stat-value" id="einvValidCount">0</div>
                                    </div>
                                    <div class="stat-card warning">
                                        <div class="stat-label">Pending</div>
                                        <div class="stat-value" id="einvPendingCount">0</div>
                                    </div>
                                    <div class="stat-card expense">
                                        <div class="stat-label">Invalid</div>
                                        <div class="stat-value" id="einvInvalidCount">0</div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- e-Invoice Submissions Table -->
                            <div class="content-card">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                    <h3 style="margin: 0;"><i class="fas fa-list"></i> Recent Submissions</h3>
                                    <div style="display: flex; gap: 10px;">
                                        <button class="btn-outline" onclick="generateDemoInvoice()" title="Create a demo invoice submission">
                                            <i class="fas fa-plus"></i> Demo Invoice
                                        </button>
                                        <button class="btn-outline" onclick="clearDemoData()" title="Clear all demo data" style="color: #ef4444; border-color: #fca5a5;">
                                            <i class="fas fa-trash"></i> Clear Demo
                                        </button>
                                    </div>
                                </div>
                                <div class="table-container">
                                    <table class="data-table">
                                        <thead>
                                            <tr>
                                                <th>Invoice #</th>
                                                <th>UUID</th>
                                                <th>Submitted</th>
                                                <th>Status</th>
                                                <th>Environment</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="eInvoiceSubmissionsBody">
                                            <tr>
                                                <td colspan="6" style="text-align: center; color: #64748b; padding: 40px;">
                                                    <i class="fas fa-file-invoice" style="font-size: 40px; margin-bottom: 10px; display: block;"></i>
                                                    No e-Invoice submissions yet
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            
                            <!-- e-Invoice Information -->
                            <div class="content-card" style="margin-top: 20px;">
                                <h3 style="margin-bottom: 15px;"><i class="fas fa-info-circle" style="color: #2563eb;"></i> e-Invoice Timeline Malaysia</h3>
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
                                    <div style="padding: 15px; background: #f0fdf4; border-radius: 8px; border-left: 4px solid #10b981;">
                                        <strong style="color: #059669;">Phase 1 - Aug 2024</strong>
                                        <p style="margin: 5px 0 0; color: #047857; font-size: 13px;">
                                            Taxpayers with revenue > RM100 million
                                        </p>
                                    </div>
                                    <div style="padding: 15px; background: #dbeafe; border-radius: 8px; border-left: 4px solid #3b82f6;">
                                        <strong style="color: #2563eb;">Phase 2 - Jan 2025</strong>
                                        <p style="margin: 5px 0 0; color: #1d4ed8; font-size: 13px;">
                                            Taxpayers with revenue > RM25 million
                                        </p>
                                    </div>
                                    <div style="padding: 15px; background: #fef3c7; border-radius: 8px; border-left: 4px solid #f59e0b;">
                                        <strong style="color: #d97706;">Phase 3 - Jul 2025</strong>
                                        <p style="margin: 5px 0 0; color: #b45309; font-size: 13px;">
                                            All remaining taxpayers
                                        </p>
                                    </div>
                                </div>
                                <div style="margin-top: 15px; padding: 15px; background: #f8fafc; border-radius: 8px;">
                                    <h4 style="margin-bottom: 10px; font-size: 14px;">
                                        <i class="fas fa-link"></i> Useful Links
                                    </h4>
                                    <ul style="list-style: none; padding: 0; margin: 0; font-size: 13px;">
                                        <li style="margin-bottom: 8px;">
                                            <a href="https://myinvois.hasil.gov.my" target="_blank" style="color: #2563eb; text-decoration: none;">
                                                <i class="fas fa-external-link-alt"></i> MyInvois Portal
                                            </a>
                                        </li>
                                        <li style="margin-bottom: 8px;">
                                            <a href="https://www.hasil.gov.my/en/e-invoice/" target="_blank" style="color: #2563eb; text-decoration: none;">
                                                <i class="fas fa-external-link-alt"></i> LHDN e-Invoice Guidelines
                                            </a>
                                        </li>
                                        <li>
                                            <a href="https://sdk.myinvois.hasil.gov.my/api-reference/" target="_blank" style="color: #2563eb; text-decoration: none;">
                                                <i class="fas fa-external-link-alt"></i> API Documentation
                                            </a>
                                        </li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Intelligent AI Assistant Section -->
            <div id="ai-chatbot" class="content-section">
                <div class="content-card full-width">
                    <!-- AI Dashboard Header -->
                    <div class="ai-dashboard">
                        <div class="ai-header">
                            <h2>
                                <i class="fas fa-brain"></i> A Lazy Human AI Assistant
                                <span style="font-size: 14px; color: #94a3b8; margin-left: 10px;">
                                    Intelligent Accounting Partner
                                </span>
                            </h2>
                            <div class="ai-mode-toggle">
                                <button class="mode-btn active" onclick="setAIMode('assistant')">
                                    <i class="fas fa-robot"></i> Assistant
                                </button>
                                <button class="mode-btn" onclick="setAIMode('analyst')">
                                    <i class="fas fa-chart-line"></i> Analyst
                                </button>
                                <button class="mode-btn" onclick="setAIMode('teacher')">
                                    <i class="fas fa-graduation-cap"></i> Teacher
                                </button>
                            </div>
                        </div>

                        <!-- AI Stats Overview -->
                        <div class="ai-stats-overview" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-top: 20px;">
                            <div class="stat-card" style="background: rgba(255,255,255,0.05); padding: 20px; border-radius: 10px; text-align: center;">
                                <div class="stat-icon" style="font-size: 24px; color: #f59e0b; margin-bottom: 10px;">
                                    <i class="fas fa-lightbulb"></i>
                                </div>
                                <div class="stat-value" id="aiInsightsCount" style="font-size: 28px; font-weight: 700; color: white;">0</div>
                                <div class="stat-label" style="color: #94a3b8; font-size: 12px;">Active Insights</div>
                            </div>
                            <div class="stat-card" style="background: rgba(255,255,255,0.05); padding: 20px; border-radius: 10px; text-align: center;">
                                <div class="stat-icon" style="font-size: 24px; color: #10b981; margin-bottom: 10px;">
                                    <i class="fas fa-check-circle"></i>
                                </div>
                                <div class="stat-value" id="aiTasksCompleted" style="font-size: 28px; font-weight: 700; color: white;">0</div>
                                <div class="stat-label" style="color: #94a3b8; font-size: 12px;">Tasks Automated</div>
                            </div>
                            <div class="stat-card" style="background: rgba(255,255,255,0.05); padding: 20px; border-radius: 10px; text-align: center;">
                                <div class="stat-icon" style="font-size: 24px; color: #3b82f6; margin-bottom: 10px;">
                                    <i class="fas fa-chart-line"></i>
                                </div>
                                <div class="stat-value" id="aiAccuracy" style="font-size: 28px; font-weight: 700; color: white;">--</div>
                                <div class="stat-label" style="color: #94a3b8; font-size: 12px;">Prediction Accuracy</div>
                            </div>
                            <div class="stat-card" style="background: rgba(255,255,255,0.05); padding: 20px; border-radius: 10px; text-align: center;">
                                <div class="stat-icon" style="font-size: 24px; color: #8b5cf6; margin-bottom: 10px;">
                                    <i class="fas fa-clock"></i>
                                </div>
                                <div class="stat-value" id="aiTimeSaved" style="font-size: 28px; font-weight: 700; color: white;">0h</div>
                                <div class="stat-label" style="color: #94a3b8; font-size: 12px;">Time Saved</div>
                            </div>
                        </div>
                    </div>

                    <!-- Proactive Insights -->
                    <div style="padding: 20px;">
                        <div class="card-header" style="margin-bottom: 15px;">
                            <h3><i class="fas fa-bell" style="color: #f59e0b;"></i> Proactive Insights</h3>
                            <button class="btn-secondary" onclick="refreshInsights()">
                                <i class="fas fa-sync-alt"></i> Refresh
                            </button>
                        </div>
                        <div class="ai-insights-grid" id="aiInsightsContainer">
                            <!-- AI-generated insights will appear here -->
                            <div style="text-align: center; padding: 40px; color: #94a3b8;">
                                <i class="fas fa-spinner fa-spin" style="font-size: 24px; margin-bottom: 10px;"></i>
                                <p>Analyzing your business data...</p>
                            </div>
                        </div>
                    </div>

                    <!-- Beginner's Tutorial Banner -->
                    <div id="beginnerTutorialBanner" class="beginner-tutorial-banner" style="background: linear-gradient(135deg, rgba(59, 130, 246, 0.4), rgba(139, 92, 246, 0.4)); border-radius: 15px; padding: 25px; margin: 20px; border: 1px solid rgba(255,255,255,0.2);">
                        <div style="display: flex; align-items: flex-start; gap: 20px; flex-wrap: wrap;">
                            <div style="flex: 1; min-width: 280px;">
                                <h3 style="color: #ffffff; font-size: 20px; margin-bottom: 10px; text-shadow: 0 1px 2px rgba(0,0,0,0.3);">
                                    <i class="fas fa-user-graduate" style="color: #93c5fd;"></i> New to Accounting? Start Here!
                                </h3>
                                <p style="color: #f1f5f9; margin-bottom: 15px; line-height: 1.6;">
                                    No worries! Our AI will guide you step-by-step. Learn accounting basics in simple language and set up your business in minutes.
                                </p>
                                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                                    <button class="btn-primary" onclick="startBeginnerTutorial()" style="padding: 12px 24px; font-size: 14px;">
                                        <i class="fas fa-play-circle"></i> Start Tutorial (5 mins)
                                    </button>
                                    <button class="btn-secondary" onclick="askAIExample('What is accounting and why do I need it?')" style="padding: 12px 16px;">
                                        <i class="fas fa-question-circle"></i> What is Accounting?
                                    </button>
                                </div>
                            </div>
                            <div style="background: rgba(0,0,0,0.3); border-radius: 10px; padding: 15px; min-width: 200px;">
                                <div style="color: #fcd34d; font-size: 12px; text-transform: uppercase; margin-bottom: 8px; font-weight: 600;">You'll Learn:</div>
                                <ul style="color: #e2e8f0; font-size: 13px; padding-left: 18px; margin: 0;">
                                    <li style="margin-bottom: 5px;">Income vs Expenses (Money In vs Out)</li>
                                    <li style="margin-bottom: 5px;">How to track your business money</li>
                                    <li style="margin-bottom: 5px;">Simple tax basics for Malaysia</li>
                                    <li>Generate reports like a pro</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <!-- Natural Language Interface - Enhanced with Guided Setup -->
                    <div class="ai-query-interface">
                        <h3><i class="fas fa-robot" style="color: #3b82f6;"></i> AI Assistant</h3>
                        <p style="color: #94a3b8; margin-bottom: 15px;">
                            I can guide you through setup, answer questions, and help manage your business
                        </p>
                        
                        <div class="query-input-container">
                            <input type="text" class="query-input" 
                                   id="aiQueryInput" 
                                   placeholder="Ask me anything... e.g., 'How do I get started?' or 'Help me set up my account'"
                                   onkeypress="handleAIQueryKeyPress(event)">
                            <button class="query-mic" id="aiVoiceButton" onclick="toggleVoiceInput()">
                                <i class="fas fa-microphone"></i>
                            </button>
                        </div>
                        
                        <!-- Quick Start Guide -->
                        <div style="margin-top: 20px; margin-bottom: 15px;">
                            <h4 style="color: #60a5fa; font-size: 14px; margin-bottom: 12px;">
                                <i class="fas fa-rocket"></i> Quick Start Guide
                            </h4>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px;">
                                <div class="query-example" onclick="askAIExample('How do I set up my business profile?')" style="text-align: center; padding: 12px;">
                                    <i class="fas fa-building" style="display: block; font-size: 20px; margin-bottom: 8px;"></i>
                                    Setup Business Profile
                                </div>
                                <div class="query-example" onclick="askAIExample('How do I add my first income?')" style="text-align: center; padding: 12px;">
                                    <i class="fas fa-plus-circle" style="display: block; font-size: 20px; margin-bottom: 8px;"></i>
                                    Add First Transaction
                                </div>
                                <div class="query-example" onclick="askAIExample('How do I set up recurring bills?')" style="text-align: center; padding: 12px;">
                                    <i class="fas fa-calendar-check" style="display: block; font-size: 20px; margin-bottom: 8px;"></i>
                                    Setup Bills & Reminders
                                </div>
                                <div class="query-example" onclick="askAIExample('How do I understand the dashboard?')" style="text-align: center; padding: 12px;">
                                    <i class="fas fa-tachometer-alt" style="display: block; font-size: 20px; margin-bottom: 8px;"></i>
                                    Understand Dashboard
                                </div>
                            </div>
                        </div>
                        
                        <!-- Accounting 101 for Beginners -->
                        <div style="background: rgba(16, 185, 129, 0.1); border-radius: 10px; padding: 15px; margin-bottom: 15px; border: 1px solid rgba(16, 185, 129, 0.2);">
                            <h4 style="color: #6ee7b7; font-size: 13px; margin-bottom: 12px;">
                                <i class="fas fa-lightbulb"></i> Accounting 101 - Learn the Basics
                            </h4>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 8px;">
                                <div class="query-example" onclick="askAIExample('Explain income and expenses in simple terms')" style="padding: 10px; font-size: 12px;">
                                    <i class="fas fa-coins" style="color: #10b981;"></i> Income vs Expenses
                                </div>
                                <div class="query-example" onclick="askAIExample('What is profit and how do I calculate it?')" style="padding: 10px; font-size: 12px;">
                                    <i class="fas fa-piggy-bank" style="color: #f59e0b;"></i> What is Profit?
                                </div>
                                <div class="query-example" onclick="askAIExample('Explain assets and liabilities simply')" style="padding: 10px; font-size: 12px;">
                                    <i class="fas fa-balance-scale" style="color: #3b82f6;"></i> Assets & Liabilities
                                </div>
                                <div class="query-example" onclick="askAIExample('Simple guide to Malaysian business tax')" style="padding: 10px; font-size: 12px;">
                                    <i class="fas fa-file-invoice-dollar" style="color: #ef4444;"></i> Tax Basics
                                </div>
                                <div class="query-example" onclick="askAIExample('What receipts should I keep?')" style="padding: 10px; font-size: 12px;">
                                    <i class="fas fa-receipt" style="color: #8b5cf6;"></i> Receipt Keeping
                                </div>
                                <div class="query-example" onclick="askAIExample('How often should I update my accounts?')" style="padding: 10px; font-size: 12px;">
                                    <i class="fas fa-calendar-alt" style="color: #ec4899;"></i> Best Practices
                                </div>
                            </div>
                        </div>

                        <!-- Common Tasks -->
                        <div style="border-top: 1px solid rgba(255,255,255,0.1); padding-top: 15px;">
                            <h4 style="color: #94a3b8; font-size: 12px; margin-bottom: 10px; text-transform: uppercase;">
                                Common Questions
                            </h4>
                            <div class="query-examples" style="margin-top: 0;">
                                <div class="query-example" onclick="askAIExample('How can I reduce my tax?')">
                                    <i class="fas fa-percentage"></i> Reduce Tax
                                </div>
                                <div class="query-example" onclick="askAIExample('What bills are due soon?')">
                                    <i class="fas fa-bell"></i> Bills Due
                                </div>
                                <div class="query-example" onclick="askAIExample('Show my profit this month')">
                                    <i class="fas fa-chart-line"></i> Monthly Profit
                                </div>
                                <div class="query-example" onclick="askAIExample('Help me categorize expenses')">
                                    <i class="fas fa-tags"></i> Categorize
                                </div>
                                <div class="query-example" onclick="askAIExample('Generate a report')">
                                    <i class="fas fa-file-alt"></i> Reports
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- AI Response Area -->
                    <div class="ai-response-container" id="aiResponseContainer">
                        <div class="ai-response">
                            <div class="ai-avatar">
                                <img src="images/ai-logo.png" alt="AI Assistant" class="ai-logo-img">
                            </div>
                            <div class="response-content">
                                <div class="response-text">
                                    Hello! I'm your intelligent accounting assistant. I can:
                                    <ul style="margin-top: 10px; padding-left: 20px; color: #cbd5e1;">
                                        <li>Analyze your business finances proactively</li>
                                        <li>Detect anomalies and potential issues</li>
                                        <li>Optimize your taxes automatically</li>
                                        <li>Predict future cash flow</li>
                                        <li>Teach you accounting concepts</li>
                                        <li>Automate repetitive tasks</li>
                                    </ul>
                                    What would you like to do?
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- AI Automation Panel -->
                    <div class="ai-automation-panel">
                        <div class="automation-header">
                            <h3><i class="fas fa-cogs" style="color: #8b5cf6;"></i> Smart Automation</h3>
                            <button class="btn-secondary" onclick="runAllAutomations()">
                                <i class="fas fa-play"></i> Run All
                            </button>
                        </div>
                        
                        <div class="automation-tasks">
                            <div class="automation-task" onclick="runAutomation('categorize')">
                                <div class="task-icon"><i class="fas fa-tags"></i></div>
                                <div class="task-title">Smart Categorization</div>
                                <div class="task-description">Auto-categorize all transactions</div>
                                <div class="task-status active">Ready</div>
                            </div>
                            
                            <div class="automation-task" onclick="runAutomation('duplicates')">
                                <div class="task-icon"><i class="fas fa-copy"></i></div>
                                <div class="task-title">Find Duplicates</div>
                                <div class="task-description">Detect duplicate entries</div>
                                <div class="task-status scheduled">Scheduled</div>
                            </div>
                            
                            <div class="automation-task" onclick="runAutomation('receipts')">
                                <div class="task-icon"><i class="fas fa-receipt"></i></div>
                                <div class="task-title">Receipt Analysis</div>
                                <div class="task-description">Extract data from receipts</div>
                                <div class="task-status active">Ready</div>
                            </div>
                            
                            <div class="automation-task" onclick="runAutomation('tax-optimize')">
                                <div class="task-icon"><i class="fas fa-percentage"></i></div>
                                <div class="task-title">Tax Optimization</div>
                                <div class="task-description">Maximize tax deductions</div>
                                <div class="task-status active">Ready</div>
                            </div>
                            
                            <div class="automation-task" onclick="runAutomation('report-generate')">
                                <div class="task-icon"><i class="fas fa-file-alt"></i></div>
                                <div class="task-title">Report Generation</div>
                                <div class="task-description">Create monthly reports</div>
                                <div class="task-status scheduled">Scheduled</div>
                            </div>
                            
                            <div class="automation-task" onclick="runAutomation('predict-cashflow')">
                                <div class="task-icon"><i class="fas fa-chart-area"></i></div>
                                <div class="task-title">Cash Flow Prediction</div>
                                <div class="task-description">Forecast next 30 days</div>
                                <div class="task-status active">Ready</div>
                            </div>
                        </div>
                    </div>

                    <!-- AI Learning Section -->
                    <div class="ai-learning-module">
                        <div class="learning-progress">
                            <div class="progress-header">
                                <h3><i class="fas fa-graduation-cap" style="color: #10b981;"></i> Learning Progress</h3>
                                <span style="color: #60a5fa;" id="learningProgressPercent">0% Complete</span>
                            </div>
                            <div class="progress-bar-container">
                                <div class="progress-bar-fill" id="learningProgressBar" style="width: 0%"></div>
                            </div>
                        </div>
                        
                        <div class="learning-steps">
                            <div class="learning-step" onclick="startLearning('basic-accounting')">
                                <div class="step-number">1</div>
                                <div class="step-content">
                                    <div class="step-title">Accounting Basics</div>
                                    <div class="step-description">Learn assets, liabilities, and equity</div>
                                </div>
                                <i class="fas fa-play-circle" style="color: #3b82f6;"></i>
                            </div>
                            
                            <div class="learning-step" onclick="startLearning('malaysian-tax')">
                                <div class="step-number">2</div>
                                <div class="step-content">
                                    <div class="step-title">Malaysian Taxes</div>
                                    <div class="step-description">Understand SST, income tax, deductions</div>
                                </div>
                                <i class="fas fa-play-circle" style="color: #10b981;"></i>
                            </div>
                            
                            <div class="learning-step" onclick="startLearning('cash-flow')">
                                <div class="step-number">3</div>
                                <div class="step-content">
                                    <div class="step-title">Cash Flow Management</div>
                                    <div class="step-description">Master cash flow forecasting</div>
                                </div>
                                <i class="fas fa-play-circle" style="color: #f59e0b;"></i>
                            </div>
                        </div>
                    </div>

                    <!-- AI Analytics Dashboard - Compact/Collapsible -->
                    <div class="ai-analytics" style="padding: 15px;">
                        <div class="analytics-header" style="margin-bottom: 15px; cursor: pointer;" onclick="toggleAnalyticsPanel()">
                            <h3 style="display: flex; align-items: center; gap: 10px;">
                                <i class="fas fa-chart-bar" style="color: #f59e0b;"></i> Business Analytics
                                <i class="fas fa-chevron-down" id="analyticsToggleIcon" style="font-size: 12px; color: #94a3b8; transition: transform 0.3s;"></i>
                            </h3>
                            <div class="analytics-filters" onclick="event.stopPropagation()">
                                <button class="analytics-filter active" onclick="setAnalyticsPeriod('month')" style="padding: 5px 10px; font-size: 12px;">Month</button>
                                <button class="analytics-filter" onclick="setAnalyticsPeriod('quarter')" style="padding: 5px 10px; font-size: 12px;">Quarter</button>
                                <button class="analytics-filter" onclick="setAnalyticsPeriod('year')" style="padding: 5px 10px; font-size: 12px;">Year</button>
                            </div>
                        </div>
                        
                        <div id="analyticsContent" style="display: block;">
                            <div class="analytics-grid" style="grid-template-columns: repeat(4, 1fr); gap: 10px;">
                                <div class="analytics-card" style="padding: 12px;">
                                    <div class="analytics-value" id="aiProfitMargin" style="font-size: 22px;">--%</div>
                                    <div class="analytics-label" style="font-size: 11px;">Profit Margin</div>
                                </div>
                                <div class="analytics-card" style="padding: 12px;">
                                    <div class="analytics-value" id="aiExpenseRatio" style="font-size: 22px;">--%</div>
                                    <div class="analytics-label" style="font-size: 11px;">Expense Ratio</div>
                                </div>
                                <div class="analytics-card" style="padding: 12px;">
                                    <div class="analytics-value" id="aiCashFlowHealth" style="font-size: 22px;">--</div>
                                    <div class="analytics-label" style="font-size: 11px;">Health Score</div>
                                </div>
                                <div class="analytics-card" style="padding: 12px;">
                                    <div class="analytics-value" id="aiTaxEfficiency" style="font-size: 22px;">--%</div>
                                    <div class="analytics-label" style="font-size: 11px;">Tax Efficiency</div>
                                </div>
                            </div>
                            <!-- Hidden trend elements for JS compatibility -->
                            <div style="display: none;">
                                <span id="aiProfitTrend"></span>
                                <span id="aiExpenseTrend"></span>
                                <span id="aiCashFlowTrend"></span>
                                <span id="aiTaxTrend"></span>
                            </div>
                            <canvas id="aiAnalyticsChart" style="width: 100%; height: 180px; margin-top: 15px;"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- ==================== BANK RECONCILIATION SECTION ==================== -->
            <div id="bank-reconciliation" class="content-section">
                <div class="content-card full-width">
                    <div class="card-header">
                        <h2><i class="fas fa-university"></i> Bank Reconciliation</h2>
                        <span style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); 
                                     color: white; padding: 4px 12px; border-radius: 6px; 
                                     font-size: 11px; font-weight: 600;">
                             ADMIN ACCESS
                        </span>
                    </div>
                    
                    <div id="bankReconciliationContent">
                        <!-- Reconciliation content loaded by JS -->
                    </div>
                </div>
            </div>
            
            <!-- ==================== BRANCHES SECTION (Phase 5) ==================== -->
            <div id="branches" class="content-section">
                <div class="content-card full-width">
                    <div class="card-header">
                        <h2><i class="fas fa-building"></i> Multi-Branch Management</h2>
                        <div class="header-actions" style="display: flex; gap: 10px; align-items: center;">
                            <select id="globalBranchSelector" class="form-control" style="min-width: 200px;" onchange="switchBranch(this.value)">
                                <option value="all">All Branches</option>
                            </select>
                            <button class="btn-primary" onclick="showBranchModal()">
                                <i class="fas fa-plus"></i> Add Branch
                            </button>
                        </div>
                    </div>
                
                    <!-- Branch Stats -->
                    <div class="stats-row" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 20px;">
                        <div class="stat-card branches-stat blue">
                            <div class="stat-icon"><i class="fas fa-building"></i></div>
                            <div class="stat-info">
                                <div class="stat-value" id="totalBranches">0</div>
                                <div class="stat-label">Total Branches</div>
                            </div>
                        </div>
                        <div class="stat-card branches-stat green">
                            <div class="stat-icon"><i class="fas fa-check-circle"></i></div>
                            <div class="stat-info">
                                <div class="stat-value" id="activeBranches">0</div>
                                <div class="stat-label">Active Branches</div>
                            </div>
                        </div>
                        <div class="stat-card branches-stat orange">
                            <div class="stat-icon"><i class="fas fa-exchange-alt"></i></div>
                            <div class="stat-info">
                                <div class="stat-value" id="pendingTransfers">0</div>
                                <div class="stat-label">Pending Transfers</div>
                            </div>
                        </div>
                        <div class="stat-card branches-stat purple">
                            <div class="stat-icon"><i class="fas fa-users"></i></div>
                            <div class="stat-info">
                                <div class="stat-value" id="totalBranchStaff">0</div>
                                <div class="stat-label">Total Staff</div>
                            </div>
                        </div>
                    </div>
                
                    <!-- Branch Tabs -->
                    <div class="tabs">
                        <button class="tab active" onclick="showBranchTab('list')">
                            <i class="fas fa-list"></i> Branch List
                        </button>
                        <button class="tab" onclick="showBranchTab('inventory')">
                            <i class="fas fa-boxes"></i> Branch Inventory
                        </button>
                        <button class="tab" onclick="showBranchTab('transfers')">
                            <i class="fas fa-exchange-alt"></i> Stock Transfers
                        </button>
                        <button class="tab" onclick="showBranchTab('reports')">
                            <i class="fas fa-chart-bar"></i> Branch Reports
                        </button>
                    </div>
                
                    <!-- Branch List Tab -->
                    <div id="branchListTab" class="tab-content">
                        <div class="filter-bar">
                            <input type="text" id="branchSearch" placeholder="Search branches..." 
                                   class="search-input" oninput="filterBranches(this.value)">
                            <select id="branchTypeFilter" class="form-control" style="width: 150px;" onchange="filterBranches()">
                                <option value="">All Types</option>
                                <option value="headquarters">Headquarters</option>
                                <option value="retail">Retail Store</option>
                                <option value="warehouse">Warehouse</option>
                                <option value="office">Office</option>
                            </select>
                            <select id="branchStatusFilter" class="form-control" style="width: 120px;" onchange="filterBranches()">
                                <option value="">All Status</option>
                                <option value="active">Active</option>
                                <option value="inactive">Inactive</option>
                            </select>
                        </div>
                    
                        <div id="branchesGrid" class="branches-grid">
                            <!-- Branch cards rendered dynamically -->
                        </div>
                    </div>
                
                    <!-- Branch Inventory Tab -->
                    <div id="branchInventoryTab" class="tab-content" style="display: none;">
                        <div class="card-header" style="margin-bottom: 15px;">
                            <h3><i class="fas fa-boxes"></i> Stock by Branch</h3>
                            <div style="display: flex; gap: 10px;">
                                <select id="branchInventoryBranch" class="form-control" style="width: 200px;" onchange="renderBranchInventory()">
                                    <option value="all">All Branches</option>
                                    <!-- Branch options populated dynamically -->
                                </select>
                                <input type="text" id="branchInventorySearch" placeholder="Search products..." 
                                       class="search-input" oninput="renderBranchInventory()">
                            </div>
                        </div>
                        
                        <div id="branchInventoryContent">
                            <!-- Branch inventory rendered dynamically -->
                        </div>
                    </div>
                
                    <!-- Stock Transfers Tab -->
                    <div id="branchTransfersTab" class="tab-content" style="display: none;">
                        <div class="card-header" style="margin-bottom: 15px;">
                            <h3><i class="fas fa-exchange-alt"></i> Stock Transfers</h3>
                            <button class="btn-primary" onclick="showTransferModal()">
                                <i class="fas fa-plus"></i> New Transfer
                            </button>
                        </div>
                        
                        <div class="filter-bar" style="margin-bottom: 15px;">
                            <input type="text" id="transferSearch" placeholder="Search transfers..." 
                                   class="search-input" oninput="filterTransfers(this.value)">
                            <select id="transferStatusFilter" class="form-control" style="width: 150px;" onchange="filterTransfers()">
                                <option value="">All Status</option>
                                <option value="pending">Pending</option>
                                <option value="intransit">In Transit</option>
                                <option value="completed">Completed</option>
                                <option value="cancelled">Cancelled</option>
                            </select>
                        </div>
                        
                        <div class="table-container">
                            <table id="transfersTable">
                                <thead>
                                    <tr>
                                        <th>Transfer #</th>
                                        <th>Date</th>
                                        <th>From Branch</th>
                                        <th>To Branch</th>
                                        <th>Items</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="transfersTableBody">
                                    <!-- Transfers rendered dynamically -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                
                    <!-- Branch Reports Tab -->
                    <div id="branchReportsTab" class="tab-content" style="display: none;">
                        <div class="card-header" style="margin-bottom: 15px;">
                            <h3><i class="fas fa-chart-bar"></i> Branch Performance</h3>
                            <div>
                                <select id="branchReportPeriod" class="form-control" style="width: 150px;" onchange="renderBranchReports()">
                                    <option value="today">Today</option>
                                    <option value="week">This Week</option>
                                    <option value="month" selected>This Month</option>
                                    <option value="year">This Year</option>
                                </select>
                            </div>
                        </div>
                        
                        <div id="branchReportsContent">
                            <!-- Reports rendered dynamically -->
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- ==================== USER MANAGEMENT SECTION ==================== -->
            <div id="user-management" class="content-section">
                <div class="content-card full-width">
                    <div class="card-header">
                        <h2><i class="fas fa-users-cog"></i> User Management</h2>
                    </div>
                    <div id="userManagementContent">
                        <!-- Rendered by users.js -->
                    </div>
                </div>
            </div>
            
            <!-- ==================== PLATFORM CONTROL SECTION ==================== -->
            <div id="platform-control" class="content-section">
                <div class="content-card full-width">
                    <div class="card-header">
                        <h2><i class="fas fa-server"></i> Platform Control</h2>
                        <div style="display: flex; gap: 10px;">
                            <button class="btn-outline" onclick="showRegistrationModal()">
                                <i class="fas fa-user-plus"></i> Manual Signup
                            </button>
                        </div>
                    </div>
                    <div id="platformControlContent">
                        <!-- Rendered by platform-control.js -->
                    </div>
                </div>
            </div>
            
            <!-- ==================== PURCHASE ORDERS SECTION ==================== -->
            <div id="purchase-orders" class="content-section">
                <div class="content-card full-width">
                    <div class="card-header">
                        <h2><i class="fas fa-shopping-cart"></i> Purchase Orders</h2>
                        <div style="display: flex; gap: 10px;">
                            <button class="btn-outline" onclick="exportPurchaseOrders()">
                                <i class="fas fa-download"></i> Export
                            </button>
                            <button class="btn-primary" onclick="showCreatePOModal()">
                                <i class="fas fa-plus"></i> New Purchase Order
                            </button>
                        </div>
                    </div>
                    
                    <!-- PO Stats -->
                    <div class="stats-grid" style="margin-bottom: 20px;">
                        <div class="stat-card">
                            <div class="stat-label">Total POs</div>
                            <div class="stat-value" id="poTotalCount">0</div>
                        </div>
                        <div class="stat-card warning">
                            <div class="stat-label">Pending</div>
                            <div class="stat-value" id="poPendingCount2">0</div>
                        </div>
                        <div class="stat-card info">
                            <div class="stat-label">Approved</div>
                            <div class="stat-value" id="poApprovedCount2">0</div>
                        </div>
                        <div class="stat-card income">
                            <div class="stat-label">Received</div>
                            <div class="stat-value" id="poReceivedCount2">0</div>
                        </div>
                    </div>
                    
                    <!-- PO Filters -->
                    <div style="display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap; align-items: center;">
                        <input type="text" id="poSearchInput" placeholder="Search PO number, supplier..." 
                               class="form-control" style="flex: 1; min-width: 200px;" oninput="filterPOList()">
                        <select id="poStatusFilter2" class="form-control" style="width: 150px;" onchange="filterPOList()">
                            <option value="">All Status</option>
                            <option value="draft">Draft</option>
                            <option value="pending">Pending</option>
                            <option value="approved">Approved</option>
                            <option value="ordered">Ordered</option>
                            <option value="partial">Partial</option>
                            <option value="received">Received</option>
                            <option value="closed">Closed</option>
                            <option value="cancelled">Cancelled</option>
                        </select>
                        <select id="poSupplierFilter2" class="form-control" style="width: 180px;" onchange="filterPOList()">
                            <option value="">All Suppliers</option>
                        </select>
                    </div>
                    
                    <!-- PO List -->
                    <div id="purchaseOrdersList">
                        <!-- Rendered by JS -->
                    </div>
                </div>
            </div>
            
            <!-- ==================== DELIVERY ORDERS SECTION ==================== -->
            <div id="delivery-orders" class="content-section">
                <div class="content-card full-width">
                    <div class="card-header">
                        <h2><i class="fas fa-shipping-fast"></i> Delivery Orders</h2>
                        <div style="display: flex; gap: 10px;">
                            <button class="btn-outline" onclick="exportDeliveryOrders()">
                                <i class="fas fa-download"></i> Export
                            </button>
                            <button class="btn-primary" onclick="showCreateDOModal()">
                                <i class="fas fa-plus"></i> New Delivery Order
                            </button>
                        </div>
                    </div>
                    
                    <!-- DO Stats -->
                    <div class="stats-grid" style="margin-bottom: 20px;">
                        <div class="stat-card">
                            <div class="stat-label">Total DOs</div>
                            <div class="stat-value" id="doTotalCount">0</div>
                        </div>
                        <div class="stat-card warning">
                            <div class="stat-label">Pending</div>
                            <div class="stat-value" id="doPendingCount">0</div>
                        </div>
                        <div class="stat-card info">
                            <div class="stat-label">In Transit</div>
                            <div class="stat-value" id="doInTransitCount">0</div>
                        </div>
                        <div class="stat-card income">
                            <div class="stat-label">Delivered</div>
                            <div class="stat-value" id="doDeliveredCount">0</div>
                        </div>
                    </div>
                    
                    <!-- Tabs -->
                    <div class="tabs" style="margin-bottom: 20px;">
                        <button class="tab active" onclick="showDOTab('outgoing')">
                            <i class="fas fa-sign-out-alt"></i> Outgoing (Sales)
                        </button>
                        <button class="tab" onclick="showDOTab('incoming')">
                            <i class="fas fa-sign-in-alt"></i> Incoming (Purchase)
                        </button>
                    </div>
                    
                    <!-- DO Filters -->
                    <div style="display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap; align-items: center;">
                        <input type="text" id="doSearchInput" placeholder="Search DO number, customer..." 
                               class="form-control" style="flex: 1; min-width: 200px;" oninput="filterDOList()">
                        <select id="doStatusFilter" class="form-control" style="width: 150px;" onchange="filterDOList()">
                            <option value="">All Status</option>
                            <option value="draft">Draft</option>
                            <option value="confirmed">Confirmed</option>
                            <option value="shipped">Shipped</option>
                            <option value="in_transit">In Transit</option>
                            <option value="delivered">Delivered</option>
                            <option value="cancelled">Cancelled</option>
                        </select>
                        <input type="date" id="doDateFilter" class="form-control" style="width: 150px;" onchange="filterDOList()">
                    </div>
                    
                    <!-- DO List -->
                    <div id="deliveryOrdersList">
                        <!-- Rendered by JS -->
                    </div>
                </div>
            </div>
            
            <!-- ==================== LHDN & AUDIT EXPORT SECTION ==================== -->
            <div id="lhdn-export" class="content-section">
                <div id="lhdnExportContent">
                    <!-- Content will be rendered by JavaScript -->
                </div>
            </div>
            
            <!-- ==================== AUDIT LOG SECTION ==================== -->
            <div id="audit-log" class="content-section">
                <div class="content-card full-width">
                    <div class="card-header">
                        <h2><i class="fas fa-clipboard-list"></i> Audit Log</h2>
                        <button class="btn-primary" onclick="exportAuditLogs()">
                            <i class="fas fa-download"></i> Export Log
                        </button>
                    </div>
                    
                    <p style="color: #64748b; margin-bottom: 20px;">
                        <i class="fas fa-info-circle"></i> Track all changes made in your ERP system. View who created, edited, or deleted records.
                    </p>
                    
                    <!-- Audit Log Stats -->
                    <div class="stats-grid" style="margin-bottom: 20px;">
                        <div class="stat-card income">
                            <div class="stat-value" id="auditStatCreates">0</div>
                            <div class="stat-label"><i class="fas fa-plus-circle"></i> Create</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="auditStatUpdates">0</div>
                            <div class="stat-label"><i class="fas fa-edit"></i> Update</div>
                        </div>
                        <div class="stat-card expense">
                            <div class="stat-value" id="auditStatDeletes">0</div>
                            <div class="stat-label"><i class="fas fa-trash"></i> Delete</div>
                        </div>
                        <div class="stat-card warning">
                            <div class="stat-value" id="auditStatVoids">0</div>
                            <div class="stat-label"><i class="fas fa-ban"></i> Void</div>
                        </div>
                    </div>
                    
                    <!-- Audit Log Filters -->
                    <div class="filter-bar" style="margin-bottom: 20px;">
                        <div class="form-row" style="flex-wrap: wrap; gap: 10px;">
                            <div class="form-group" style="flex: 1; min-width: 140px;">
                                <label>Start Date</label>
                                <input type="date" id="auditLogStartDate" onchange="filterAuditLogs()">
                            </div>
                            <div class="form-group" style="flex: 1; min-width: 140px;">
                                <label>End Date</label>
                                <input type="date" id="auditLogEndDate" onchange="filterAuditLogs()">
                            </div>
                            <div class="form-group" style="flex: 1; min-width: 150px;">
                                <label>User</label>
                                <select id="auditLogUserFilter" onchange="filterAuditLogs()">
                                    <option value="">All Users</option>
                                </select>
                            </div>
                            <div class="form-group" style="flex: 1; min-width: 150px;">
                                <label>Action</label>
                                <select id="auditLogActionFilter" onchange="filterAuditLogs()">
                                    <option value="">All Actions</option>
                                    <option value="create">Created</option>
                                    <option value="update">Updated</option>
                                    <option value="delete">Deleted</option>
                                    <option value="void">Voided</option>
                                    <option value="restore">Restored</option>
                                    <option value="export">Exported</option>
                                    <option value="login">Login</option>
                                    <option value="logout">Logout</option>
                                </select>
                            </div>
                            <div class="form-group" style="flex: 1; min-width: 150px;">
                                <label>Module</label>
                                <select id="auditLogModuleFilter" onchange="filterAuditLogs()">
                                    <option value="">All Modules</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-row" style="margin-top: 10px;">
                            <div class="form-group" style="flex: 1;">
                                <label>Search</label>
                                <div style="display: flex; gap: 10px;">
                                    <input type="text" id="auditLogSearch" placeholder="Search by description, record name, or user..." 
                                           onkeyup="filterAuditLogs()" style="flex: 1;">
                                    <button class="btn-outline" onclick="filterAuditLogs()">
                                        <i class="fas fa-search"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Audit Log Count -->
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <span id="auditLogCountInfo" style="color: #64748b; font-size: 13px;">0 entries</span>
                    </div>
                    
                    <!-- Audit Log Table -->
                    <div class="table-responsive">
                        <table class="data-table audit-log-table">
                            <thead>
                                <tr>
                                    <th style="width: 140px;">Date & Time</th>
                                    <th style="width: 150px;">User</th>
                                    <th style="width: 100px;">Action</th>
                                    <th style="width: 120px;">Module</th>
                                    <th>Description</th>
                                    <th style="width: 60px;">Details</th>
                                </tr>
                            </thead>
                            <tbody id="auditLogTableBody">
                                <tr>
                                    <td colspan="6" class="text-center" style="padding: 40px;">
                                        <i class="fas fa-clipboard-list" style="font-size: 48px; color: #ddd;"></i>
                                        <p style="margin-top: 10px; color: #888;">No audit logs yet. Actions will be recorded as you use the system.</p>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- Settings Section -->
            <div id="settings" class="content-section">
                <div class="content-card full-width">
                    <div class="card-header">
                        <h2><i class="fas fa-cog"></i> Company Settings</h2>
                    </div>
                    
                    <div class="transaction-form">
                        <!-- Company Logo Upload -->
                        <div class="form-group">
                            <label>
                                <i class="fas fa-image"></i> Company Logo
                                <span style="font-size: 11px; color: #64748b; margin-left: 5px;">(For quotations, invoices & reports)</span>
                            </label>
                            <div style="display: flex; gap: 15px; align-items: center; margin-top: 10px;">
                                <div id="logoPreviewContainer" style="width: 120px; height: 120px; border: 2px dashed #cbd5e1; border-radius: 12px; 
                                            display: flex; align-items: center; justify-content: center; overflow: hidden; background: #f8fafc;">
                                    <img id="logoPreview" src="" alt="Logo" style="max-width: 100%; max-height: 100%; display: none;">
                                    <span id="logoPlaceholder" style="color: #94a3b8; font-size: 12px; text-align: center;">
                                        <i class="fas fa-building" style="font-size: 32px; display: block; margin-bottom: 5px;"></i>
                                        No logo
                                    </span>
                                </div>
                                <div>
                                    <input type="file" id="companyLogoInput" accept="image/*" style="display: none;" onchange="handleLogoUpload(event)">
                                    <button type="button" class="btn-secondary" onclick="document.getElementById('companyLogoInput').click()">
                                        <i class="fas fa-upload"></i> Upload Logo
                                    </button>
                                    <button type="button" class="btn-outline" onclick="removeCompanyLogo()" style="margin-left: 5px;">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                    <p style="font-size: 11px; color: #64748b; margin-top: 8px;">
                                        Recommended: 200x200px, PNG or JPG
                                    </p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>
                                Business Name
                                <i class="fas fa-question-circle" style="color: #60a5fa; cursor: pointer; margin-left: 5px;" 
                                   onclick="toggleHelpTooltip('businessNameHelp')" 
                                   title="Click for more info"></i>
                            </label>
                            <div id="businessNameHelp" class="help-tooltip-box" style="display: none;">
                                <div style="color: #60a5fa; font-weight: 600; margin-bottom: 8px;">
                                    <i class="fas fa-info-circle"></i> Business Name
                                </div>
                                <p style="color: #e2e8f0; margin: 0;">Your company or business name that will appear on:</p>
                                <ul style="color: #cbd5e1; padding-left: 20px; margin: 8px 0 0 0; font-size: 12px;">
                                    <li>All reports and statements</li>
                                    <li>PDF exports and invoices</li>
                                    <li>Dashboard welcome message</li>
                                </ul>
                            </div>
                            <input type="text" id="businessName" placeholder="Your Business Name">
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label>
                                    Business Registration No. (SSM)
                                    <i class="fas fa-question-circle" style="color: #60a5fa; cursor: pointer; margin-left: 5px;" 
                                       onclick="toggleHelpTooltip('ssmHelp')" 
                                       title="Click for more info"></i>
                                </label>
                                <div id="ssmHelp" class="help-tooltip-box" style="display: none;">
                                    <div style="color: #60a5fa; font-weight: 600; margin-bottom: 8px;">
                                        <i class="fas fa-info-circle"></i> SSM Number
                                    </div>
                                    <p style="color: #e2e8f0; margin: 0;">Your company registration number from Suruhanjaya Syarikat Malaysia (SSM).</p>
                                    <div style="color: #94a3b8; font-size: 11px; margin-top: 8px;">
                                         Format examples: <strong>1234567-X</strong> (old) or <strong>202101234567</strong> (new)
                                    </div>
                                </div>
                                <input type="text" id="ssmNumber" placeholder="e.g., 1234567-X">
                            </div>
                            <div class="form-group">
                                <label>
                                    TIN Number (Tax Identification)
                                    <i class="fas fa-question-circle" style="color: #60a5fa; cursor: pointer; margin-left: 5px;" 
                                       onclick="toggleHelpTooltip('tinHelp')" 
                                       title="Click for more info"></i>
                                </label>
                                <div id="tinHelp" class="help-tooltip-box" style="display: none;">
                                    <div style="color: #60a5fa; font-weight: 600; margin-bottom: 8px;">
                                        <i class="fas fa-info-circle"></i> TIN Number
                                    </div>
                                    <p style="color: #e2e8f0; margin: 0;">Tax Identification Number issued by LHDN (Lembaga Hasil Dalam Negeri).</p>
                                    <div style="color: #94a3b8; font-size: 11px; margin-top: 8px;">
                                         Format: <strong>C1234567890</strong> (Company) or <strong>IG1234567890</strong> (Individual)
                                    </div>
                                </div>
                                <input type="text" id="tinNumber" placeholder="e.g., C12345678X">
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label>
                                    GST/SST Number (Optional)
                                    <i class="fas fa-question-circle" style="color: #60a5fa; cursor: pointer; margin-left: 5px;" 
                                       onclick="toggleHelpTooltip('sstHelp')" 
                                       title="Click for more info"></i>
                                </label>
                                <div id="sstHelp" class="help-tooltip-box" style="display: none;">
                                    <div style="color: #60a5fa; font-weight: 600; margin-bottom: 8px;">
                                        <i class="fas fa-info-circle"></i> SST Registration
                                    </div>
                                    <p style="color: #e2e8f0; margin: 0;">Sales & Service Tax registration number (if registered).</p>
                                    <div style="color: #f59e0b; font-size: 11px; margin-top: 8px;">
                                         Only required if your annual turnover exceeds RM 500,000
                                    </div>
                                </div>
                                <input type="text" id="gstNumber" placeholder="e.g., GST-12345678">
                            </div>
                            <div class="form-group">
                                <label>
                                    Financial Year Start
                                    <i class="fas fa-question-circle" style="color: #60a5fa; cursor: pointer; margin-left: 5px;" 
                                       onclick="toggleHelpTooltip('fyHelp')" 
                                       title="Click for more info"></i>
                                </label>
                                <div id="fyHelp" class="help-tooltip-box" style="display: none;">
                                    <div style="color: #60a5fa; font-weight: 600; margin-bottom: 8px;">
                                        <i class="fas fa-info-circle"></i> Financial Year
                                    </div>
                                    <p style="color: #e2e8f0; margin: 0;">The start date of your company's financial year.</p>
                                    <ul style="color: #cbd5e1; padding-left: 20px; margin: 8px 0 0 0; font-size: 12px;">
                                        <li>Most companies use <strong>1st January</strong></li>
                                        <li>Or the month your company was incorporated</li>
                                    </ul>
                                </div>
                                <input type="date" id="financialYearStart">
                            </div>
                        </div>
                        
                        <!-- Company Contact Information for Quotations/Invoices -->
                        <div style="margin: 20px 0; padding: 15px; background: #f8fafc; border-radius: 10px; border: 1px solid #e2e8f0;">
                            <h4 style="margin: 0 0 15px; color: #334155; font-size: 14px;">
                                <i class="fas fa-address-card" style="color: #2563eb;"></i> Company Contact Details
                                <span style="font-size: 11px; color: #64748b; font-weight: normal;">(Shown on quotations & invoices)</span>
                            </h4>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Business Address</label>
                                    <textarea id="businessAddress" rows="2" placeholder="123 Jalan ABC, 50000 Kuala Lumpur" style="resize: vertical;"></textarea>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Phone Number</label>
                                    <input type="text" id="businessPhone" placeholder="03-1234 5678">
                                </div>
                                <div class="form-group">
                                    <label>Email Address</label>
                                    <input type="email" id="businessEmail" placeholder="info@company.com">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Website (Optional)</label>
                                    <input type="text" id="businessWebsite" placeholder="www.company.com">
                                </div>
                                <div class="form-group">
                                    <label>Bank Account (for payment)</label>
                                    <input type="text" id="businessBankAccount" placeholder="Maybank 1234-5678-9012">
                                </div>
                            </div>
                        </div>
                        
                        <!-- Company Code for Staff Device Sync -->
                        <div id="companyCodeSection" style="margin: 20px 0; padding: 15px; background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); border-radius: 10px; border: 1px solid #7dd3fc; display: none;">
                            <h4 style="margin: 0 0 10px; color: #0369a1; font-size: 14px;">
                                <i class="fas fa-key" style="color: #0ea5e9;"></i> Company Code
                                <span style="background: linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%); 
                                             color: white; padding: 2px 8px; border-radius: 4px; 
                                             font-size: 10px; margin-left: 8px; font-weight: 600;">
                                    FOR STAFF SYNC
                                </span>
                            </h4>
                            <p style="font-size: 12px; color: #64748b; margin: 0 0 12px;">
                                Share this code with your staff so they can sync their devices to login.
                            </p>
                            <div style="display: flex; gap: 10px; align-items: center;">
                                <div style="flex: 1; background: white; border: 2px dashed #7dd3fc; border-radius: 8px; padding: 12px 16px; text-align: center;">
                                    <span id="companyCodeDisplay" style="font-family: 'SF Mono', Monaco, monospace; font-size: 20px; font-weight: 700; letter-spacing: 3px; color: #0369a1;">
                                        ----
                                    </span>
                                </div>
                                <button type="button" onclick="copyCompanyCode()" class="btn-secondary" style="background: #0ea5e9; color: white; border: none; padding: 12px 16px;">
                                    <i class="fas fa-copy"></i> Copy
                                </button>
                                <button type="button" onclick="regenerateCompanyCodeUI()" class="btn-secondary" style="background: #f59e0b; color: white; border: none; padding: 12px 16px;" title="Generate new code (invalidates old one)">
                                    <i class="fas fa-sync-alt"></i>
                                </button>
                            </div>
                            <p style="font-size: 11px; color: #94a3b8; margin: 10px 0 0;">
                                <i class="fas fa-info-circle"></i> Staff enter this code on the login page  "Sync from another device?"  Enter Company Code
                            </p>
                        </div>
                        
                        <div class="form-group">
                            <label>
                                Default Corporate Tax Rate (%)
                                <i class="fas fa-question-circle" style="color: #60a5fa; cursor: pointer; margin-left: 5px;" 
                                   onclick="toggleHelpTooltip('taxRateHelp')" 
                                   title="Click for more info"></i>
                            </label>
                            <div id="taxRateHelp" class="help-tooltip-box" style="display: none;">
                                <div style="color: #60a5fa; font-weight: 600; margin-bottom: 8px;">
                                    <i class="fas fa-info-circle"></i> Corporate Tax Rate
                                </div>
                                <p style="color: #e2e8f0; margin: 0 0 8px 0;">Malaysian corporate tax rates (2024/2025):</p>
                                <table style="width: 100%; color: #cbd5e1; font-size: 12px;">
                                    <tr><td>First RM 150,000</td><td style="text-align: right; color: #10b981;"><strong>15%</strong></td></tr>
                                    <tr><td>RM 150,001 - RM 600,000</td><td style="text-align: right; color: #f59e0b;"><strong>17%</strong></td></tr>
                                    <tr><td>Above RM 600,000</td><td style="text-align: right; color: #ef4444;"><strong>24%</strong></td></tr>
                                </table>
                            </div>
                            <input type="number" id="defaultTaxRate" min="0" max="30" step="0.5" value="17">
                        </div>
                        
                        <div class="form-group">
                            <label>
                                System Backup & Restore
                                <span style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); 
                                             color: white; padding: 2px 8px; border-radius: 4px; 
                                             font-size: 10px; margin-left: 8px; font-weight: 600;">
                                     FOUNDER + ADMIN ONLY
                                </span>
                                <i class="fas fa-question-circle" style="color: #60a5fa; cursor: pointer; margin-left: 5px;" 
                                   onclick="showBackupHelpTooltip()" 
                                   title="Click for more info"></i>
                            </label>
                            <div id="backupHelpTooltip" style="display: none; background: #1e293b; border: 1px solid #3b82f6; border-radius: 8px; padding: 12px; margin-bottom: 10px; font-size: 13px;">
                                <div style="color: #60a5fa; font-weight: 600; margin-bottom: 8px;">
                                    <i class="fas fa-shield-alt"></i> Backup & Restore System
                                </div>
                                <div style="color: #e2e8f0; font-size: 12px;">
                                    <strong>Export Data:</strong>
                                    <ul style="padding-left: 20px; margin: 5px 0;">
                                        <li><strong>Founder:</strong> Can export all platform data OR specific tenant</li>
                                        <li><strong>Business Admin:</strong> Can export only their tenant data</li>
                                    </ul>
                                    <strong style="margin-top: 8px; display: block;">Import Data:</strong>
                                    <ul style="padding-left: 20px; margin: 5px 0;">
                                        <li>Restore from .json backup file</li>
                                        <li> Will overwrite existing data - use carefully!</li>
                                    </ul>
                                </div>
                                <div style="color: #10b981; font-size: 11px; margin-top: 8px; border-top: 1px solid #334155; padding-top: 8px;">
                                     Tip: Export regularly to protect your data. Keep backups in a safe location.
                                </div>
                            </div>
                            <div style="display: flex; gap: 10px;">
                                <button class="btn-secondary" onclick="exportBackup()" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; border: none;">
                                    <i class="fas fa-download"></i> Export Backup
                                </button>
                                <button class="btn-secondary" onclick="importBackup()" style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white; border: none;">
                                    <i class="fas fa-upload"></i> Import Backup
                                </button>
                            </div>
                            <div id="backupInfo"></div>
                            
                            <!-- Auto-Backup Section -->
                            <div style="margin-top: 20px; padding: 15px; background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%); border-radius: 10px; border: 1px solid #334155;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                                    <div>
                                        <h4 style="margin: 0; color: #f8fafc; font-size: 14px;">
                                            <i class="fas fa-clock" style="color: #10b981;"></i> Auto-Backup
                                        </h4>
                                        <p style="margin: 4px 0 0; color: #94a3b8; font-size: 12px;">Automatic backups every 24 hours</p>
                                    </div>
                                    <span id="autoBackupStatus" style="background: #10b981; color: white; padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: 600;">
                                         Active
                                    </span>
                                </div>
                                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                                    <button class="btn-secondary" onclick="triggerAutoBackup()" style="background: #334155; color: white; border: 1px solid #475569; font-size: 13px;">
                                        <i class="fas fa-save"></i> Backup Now
                                    </button>
                                    <button class="btn-secondary" onclick="showAutoBackupRestore()" style="background: #334155; color: white; border: 1px solid #475569; font-size: 13px;">
                                        <i class="fas fa-history"></i> Restore from Auto-Backup
                                    </button>
                                </div>
                                <div id="lastAutoBackupInfo" style="margin-top: 10px; color: #94a3b8; font-size: 12px;"></div>
                            </div>
                            
                            <!-- Cloud Sync Section -->
                            <div style="margin-top: 20px; padding: 15px; background: linear-gradient(135deg, #1e3a5f 0%, #0c1f33 100%); border-radius: 10px; border: 1px solid #2563eb;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                                    <div>
                                        <h4 style="margin: 0; color: #f8fafc; font-size: 14px;">
                                            <i class="fas fa-cloud" style="color: #3b82f6;"></i> Cloud Sync
                                        </h4>
                                        <p style="margin: 4px 0 0; color: #94a3b8; font-size: 12px;">Sync data across devices with Supabase</p>
                                    </div>
                                    <span id="cloudSyncStatus" style="background: #475569; color: white; padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: 600;">
                                        <i class="fas fa-circle" style="color: #fbbf24;"></i> Offline
                                    </span>
                                </div>
                                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                                    <button class="btn-secondary" onclick="cloudSignIn()" id="cloudSignInBtn" style="background: #2563eb; color: white; border: none; font-size: 13px;">
                                        <i class="fas fa-sign-in-alt"></i> Sign In to Cloud
                                    </button>
                                    <button class="btn-secondary" onclick="cloudSyncNow()" id="cloudSyncBtn" style="background: #334155; color: white; border: 1px solid #475569; font-size: 13px; display: none;">
                                        <i class="fas fa-sync"></i> Sync Now
                                    </button>
                                    <button class="btn-secondary" onclick="cloudSignOut()" id="cloudSignOutBtn" style="background: #dc2626; color: white; border: none; font-size: 13px; display: none;">
                                        <i class="fas fa-sign-out-alt"></i> Sign Out
                                    </button>
                                </div>
                                <div id="cloudSyncInfo" style="margin-top: 10px; color: #94a3b8; font-size: 12px;"></div>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>
                                Import Old Business Data
                                <i class="fas fa-question-circle" style="color: #60a5fa; cursor: pointer; margin-left: 5px;" 
                                   onclick="toggleHelpTooltip('importOldHelp')" 
                                   title="Click for more info"></i>
                            </label>
                            <div id="importOldHelp" class="help-tooltip-box" style="display: none;">
                                <div style="color: #60a5fa; font-weight: 600; margin-bottom: 8px;">
                                    <i class="fas fa-info-circle"></i> Import Options Explained
                                </div>
                                <ul style="color: #e2e8f0; padding-left: 20px; margin: 0; font-size: 12px;">
                                    <li style="margin-bottom: 6px;"><strong>Opening Balances</strong> - Set your starting amounts (cash, bank, receivables, payables) if starting mid-year</li>
                                    <li style="margin-bottom: 6px;"><strong>Import Old Transactions</strong> - Upload Excel/CSV files with past transactions</li>
                                    <li><strong>Bulk Entry</strong> - Quickly enter multiple transactions at once</li>
                                </ul>
                                <div style="color: #10b981; font-size: 11px; margin-top: 8px; border-top: 1px solid #334155; padding-top: 8px;">
                                     Perfect for businesses migrating from spreadsheets or other software
                                </div>
                            </div>
                            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                                <button class="btn-secondary" onclick="showOpeningBalanceWizard()">
                                    <i class="fas fa-history"></i> Set Opening Balances
                                </button>
                                <button class="btn-secondary" onclick="importOldTransactions()">
                                    <i class="fas fa-file-import"></i> Import Old Transactions
                                </button>
                                <button class="btn-secondary" onclick="showBulkEntryModal()">
                                    <i class="fas fa-edit"></i> Bulk Entry
                                </button>
                            </div>
                        </div>

                        <!-- Document Numbering Section -->
                        <div style="margin: 20px 0; padding: 15px; background: linear-gradient(135deg, #1a1f35 0%, #0f172a 100%); border-radius: 10px; border: 1px solid #334155;">
                            <h4 style="margin: 0 0 15px; color: #f8fafc; font-size: 14px; display: flex; align-items: center; justify-content: space-between;">
                                <span>
                                    <i class="fas fa-hashtag" style="color: #3b82f6;"></i> Document Numbering
                                    <span style="font-size: 11px; color: #64748b; font-weight: normal; margin-left: 8px;">(Customize invoice/quotation numbers)</span>
                                </span>
                                <i class="fas fa-question-circle" style="color: #60a5fa; cursor: pointer;" 
                                   onclick="toggleHelpTooltip('docNumberingHelp')" 
                                   title="Click for more info"></i>
                            </h4>
                            <div id="docNumberingHelp" class="help-tooltip-box" style="display: none;">
                                <div style="color: #60a5fa; font-weight: 600; margin-bottom: 8px;">
                                    <i class="fas fa-info-circle"></i> Document Numbering
                                </div>
                                <p style="color: #e2e8f0; margin: 0 0 8px 0;">Customize how your document numbers are generated:</p>
                                <ul style="color: #cbd5e1; padding-left: 20px; margin: 0; font-size: 12px;">
                                    <li><strong>Prefix</strong> - Code at the start (e.g., INV, QUO, RCP)</li>
                                    <li><strong>Year</strong> - Optionally include year in number</li>
                                    <li><strong>Sequence</strong> - Auto-incrementing number</li>
                                </ul>
                                <div style="color: #10b981; font-size: 11px; margin-top: 8px;">
                                    Example: INV-2512-0001
                                </div>
                            </div>

                            <!-- Global Settings -->
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; margin-bottom: 15px;">
                                <div class="form-group" style="margin-bottom: 0;">
                                    <label style="font-size: 11px; color: #94a3b8;">Separator</label>
                                    <select id="docNumSeparator" onchange="updateDocNumberPreview()" style="font-size: 13px;">
                                        <option value="-">Dash (-)</option>
                                        <option value="/">Slash (/)</option>
                                        <option value="_">Underscore (_)</option>
                                        <option value="">None</option>
                                    </select>
                                </div>
                                <div class="form-group" style="margin-bottom: 0;">
                                    <label style="font-size: 11px; color: #94a3b8;">Year Format</label>
                                    <select id="docNumYearFormat" onchange="updateDocNumberPreview()" style="font-size: 13px;">
                                        <option value="YYMM">YYMM (2512)</option>
                                        <option value="YY">YY (25)</option>
                                        <option value="YYYY">YYYY (2025)</option>
                                        <option value="">None</option>
                                    </select>
                                </div>
                                <div class="form-group" style="margin-bottom: 0;">
                                    <label style="font-size: 11px; color: #94a3b8;">Number Padding</label>
                                    <select id="docNumPadding" onchange="updateDocNumberPreview()" style="font-size: 13px;">
                                        <option value="4">4 digits (0001)</option>
                                        <option value="5">5 digits (00001)</option>
                                        <option value="6">6 digits (000001)</option>
                                        <option value="7">7 digits (0000001)</option>
                                        <option value="8">8 digits (00000001)</option>
                                        <option value="3">3 digits (001)</option>
                                        <option value="2">2 digits (01)</option>
                                    </select>
                                </div>
                                <div class="form-group" style="margin-bottom: 0;">
                                    <label style="font-size: 11px; color: #94a3b8;">Reset Sequence</label>
                                    <select id="docNumReset" style="font-size: 13px;">
                                        <option value="never">Never</option>
                                        <option value="yearly">Yearly</option>
                                        <option value="monthly">Monthly</option>
                                    </select>
                                </div>
                            </div>

                            <!-- Per-Document Type Settings -->
                            <div style="background: #0f172a; border-radius: 8px; overflow: hidden;">
                                <table style="width: 100%; border-collapse: collapse; font-size: 13px;">
                                    <thead>
                                        <tr style="background: #1e293b;">
                                            <th style="padding: 10px; text-align: left; color: #94a3b8; font-weight: 500;">Document Type</th>
                                            <th style="padding: 10px; text-align: center; color: #94a3b8; font-weight: 500; width: 100px;">Prefix</th>
                                            <th style="padding: 10px; text-align: center; color: #94a3b8; font-weight: 500; width: 100px;">Next #</th>
                                            <th style="padding: 10px; text-align: left; color: #94a3b8; font-weight: 500;">Preview</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr style="border-bottom: 1px solid #1e293b;">
                                            <td style="padding: 8px 10px; color: #e2e8f0;"> Quotation</td>
                                            <td style="padding: 8px 10px;"><input type="text" id="docPrefixQuotation" value="QUO" onchange="updateDocNumberPreview()" style="width: 70px; text-align: center; padding: 5px; font-size: 12px; text-transform: uppercase;"></td>
                                            <td style="padding: 8px 10px;"><input type="number" id="docNextQuotation" value="1" min="1" style="width: 70px; text-align: center; padding: 5px; font-size: 12px;" onchange="updateDocNumberPreview()"></td>
                                            <td style="padding: 8px 10px; color: #10b981; font-family: monospace;" id="previewQuotation">QUO-2512-0001</td>
                                        </tr>
                                        <tr style="border-bottom: 1px solid #1e293b;">
                                            <td style="padding: 8px 10px; color: #e2e8f0;"> Invoice</td>
                                            <td style="padding: 8px 10px;"><input type="text" id="docPrefixInvoice" value="INV" onchange="updateDocNumberPreview()" style="width: 70px; text-align: center; padding: 5px; font-size: 12px; text-transform: uppercase;"></td>
                                            <td style="padding: 8px 10px;"><input type="number" id="docNextInvoice" value="1" min="1" style="width: 70px; text-align: center; padding: 5px; font-size: 12px;" onchange="updateDocNumberPreview()"></td>
                                            <td style="padding: 8px 10px; color: #10b981; font-family: monospace;" id="previewInvoice">INV-2512-0001</td>
                                        </tr>
                                        <tr style="border-bottom: 1px solid #1e293b;">
                                            <td style="padding: 8px 10px; color: #e2e8f0;"> Receipt (POS)</td>
                                            <td style="padding: 8px 10px;"><input type="text" id="docPrefixReceipt" value="RCP" onchange="updateDocNumberPreview()" style="width: 70px; text-align: center; padding: 5px; font-size: 12px; text-transform: uppercase;"></td>
                                            <td style="padding: 8px 10px;"><input type="number" id="docNextReceipt" value="1" min="1" style="width: 70px; text-align: center; padding: 5px; font-size: 12px;" onchange="updateDocNumberPreview()"></td>
                                            <td style="padding: 8px 10px; color: #10b981; font-family: monospace;" id="previewReceipt">RCP-2512-0001</td>
                                        </tr>
                                        <tr style="border-bottom: 1px solid #1e293b;">
                                            <td style="padding: 8px 10px; color: #e2e8f0;"> Purchase Order</td>
                                            <td style="padding: 8px 10px;"><input type="text" id="docPrefixPurchaseOrder" value="PO" onchange="updateDocNumberPreview()" style="width: 70px; text-align: center; padding: 5px; font-size: 12px; text-transform: uppercase;"></td>
                                            <td style="padding: 8px 10px;"><input type="number" id="docNextPurchaseOrder" value="1" min="1" style="width: 70px; text-align: center; padding: 5px; font-size: 12px;" onchange="updateDocNumberPreview()"></td>
                                            <td style="padding: 8px 10px; color: #10b981; font-family: monospace;" id="previewPurchaseOrder">PO-2512-0001</td>
                                        </tr>
                                        <tr style="border-bottom: 1px solid #1e293b;">
                                            <td style="padding: 8px 10px; color: #e2e8f0;"> Delivery Order</td>
                                            <td style="padding: 8px 10px;"><input type="text" id="docPrefixDeliveryOrder" value="DO" onchange="updateDocNumberPreview()" style="width: 70px; text-align: center; padding: 5px; font-size: 12px; text-transform: uppercase;"></td>
                                            <td style="padding: 8px 10px;"><input type="number" id="docNextDeliveryOrder" value="1" min="1" style="width: 70px; text-align: center; padding: 5px; font-size: 12px;" onchange="updateDocNumberPreview()"></td>
                                            <td style="padding: 8px 10px; color: #10b981; font-family: monospace;" id="previewDeliveryOrder">DO-2512-0001</td>
                                        </tr>
                                        <tr>
                                            <td style="padding: 8px 10px; color: #e2e8f0;"> Sales Order</td>
                                            <td style="padding: 8px 10px;"><input type="text" id="docPrefixSalesOrder" value="SO" onchange="updateDocNumberPreview()" style="width: 70px; text-align: center; padding: 5px; font-size: 12px; text-transform: uppercase;"></td>
                                            <td style="padding: 8px 10px;"><input type="number" id="docNextSalesOrder" value="1" min="1" style="width: 70px; text-align: center; padding: 5px; font-size: 12px;" onchange="updateDocNumberPreview()"></td>
                                            <td style="padding: 8px 10px; color: #10b981; font-family: monospace;" id="previewSalesOrder">SO-2512-0001</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <div class="form-group">
                            <label>
                                Reset Data
                                <i class="fas fa-question-circle" style="color: #ef4444; cursor: pointer; margin-left: 5px;" 
                                   onclick="toggleHelpTooltip('resetHelp')" 
                                   title="Click for more info"></i>
                            </label>
                            <div id="resetHelp" class="help-tooltip-box" style="display: none; border-color: #ef4444;">
                                <div style="color: #ef4444; font-weight: 600; margin-bottom: 8px;">
                                    <i class="fas fa-exclamation-triangle"></i> Warning - Data Deletion
                                </div>
                                <ul style="color: #e2e8f0; padding-left: 20px; margin: 0; font-size: 12px;">
                                    <li style="margin-bottom: 6px;"><strong style="color: #f59e0b;">Clear Transactions Only</strong> - Deletes all income & expenses, keeps settings</li>
                                    <li><strong style="color: #ef4444;">Clear All Data</strong> - Deletes EVERYTHING including settings (full reset)</li>
                                </ul>
                                <div style="color: #fca5a5; font-size: 11px; margin-top: 8px; border-top: 1px solid #334155; padding-top: 8px;">
                                     This action cannot be undone! Export your data first as backup.
                                </div>
                            </div>
                            <div style="display: flex; gap: 10px;">
                                <button class="btn-secondary" style="background: #f59e0b; color: white; border-color: #f59e0b;" onclick="confirmResetTransactions()">
                                    <i class="fas fa-trash"></i> Clear Transactions Only
                                </button>
                                <button class="btn-secondary" style="background: #ef4444; color: white; border-color: #ef4444;" onclick="confirmResetAll()">
                                    <i class="fas fa-trash-alt"></i> Clear All Data
                                </button>
                            </div>
                        </div>
                        
                        <button class="btn-primary" onclick="saveSettings()">
                            <i class="fas fa-save"></i> Save Settings
                        </button>
                    </div>
                </div>
            </div>
        </div>
    
    <!-- Add Bill Modal -->
    <div class="modal" id="addBillModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Add New Bill (RM)</h3>
                <button class="close-modal" onclick="closeAddBillModal()">&times;</button>
            </div>
            <div class="transaction-form">
                <div class="form-group">
                    <label>Bill Name/Description</label>
                    <input type="text" id="billName" placeholder="e.g., Rent, Utilities, Supplies">
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>Amount (RM)</label>
                        <input type="number" id="billAmount" placeholder="0.00" step="0.01">
                    </div>
                    <div class="form-group">
                        <label>Due Date</label>
                        <input type="date" id="billDueDate">
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Category</label>
                    <select id="billCategory">
                        <option value="rent">Rent</option>
                        <option value="utilities">Utilities (TNB, Water, etc.)</option>
                        <option value="supplies">Supplies</option>
                        <option value="salary">Salaries & EPF</option>
                        <option value="loan">Loan Payment</option>
                        <option value="tax">Tax Payment</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Vendor</label>
                    <input type="text" id="billVendor" placeholder="Who is this bill from?">
                </div>
                
                <div class="form-group">
                    <label>Status</label>
                    <select id="billStatus">
                        <option value="upcoming">Upcoming</option>
                        <option value="overdue">Overdue</option>
                        <option value="paid">Paid</option>
                    </select>
                </div>
                
                <!-- Recurring Settings -->
                <div class="recurring-section">
                    <label class="recurring-toggle">
                        <input type="checkbox" id="billRecurring" onchange="toggleRecurringOptions()">
                        <span><i class="fas fa-redo"></i> Make this a recurring bill</span>
                    </label>
                    <div id="recurringOptions" style="display: none;">
                        <div class="form-row">
                            <div class="form-group">
                                <label>Repeat Every</label>
                                <select id="billRecurringFrequency">
                                    <option value="weekly">Weekly</option>
                                    <option value="monthly" selected>Monthly</option>
                                    <option value="quarterly">Quarterly</option>
                                    <option value="yearly">Yearly</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>End Date (Optional)</label>
                                <input type="date" id="billRecurringEnd" placeholder="Leave empty for no end">
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="form-actions" style="display: flex; gap: 10px; margin-top: 20px;">
                    <button class="btn-primary" style="flex: 1;" onclick="saveBill()">Save Bill</button>
                    <button class="btn-secondary" style="flex: 1;" onclick="closeAddBillModal()">Cancel</button>
                </div>
            </div>
        </div>
    </div>
        
    <!-- Edit Transaction Modal -->
    <div class="modal" id="editTransactionModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Edit Transaction (RM)</h3>
                <button class="close-modal" onclick="closeEditTransactionModal()">&times;</button>
            </div>
            <div class="transaction-form">
                <input type="hidden" id="editTransactionId">
                <input type="hidden" id="editTransactionType">
                
                <div class="form-row">
                    <div class="form-group">
                        <label>Date</label>
                        <input type="date" id="editTransactionDate">
                    </div>
                    <div class="form-group">
                        <label>Amount (RM)</label>
                        <input type="number" id="editTransactionAmount" placeholder="0.00" step="0.01">
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Description</label>
                    <input type="text" id="editTransactionDescription" placeholder="e.g., Product sales for March">
                </div>
                
                <div class="form-group">
                    <label>Category</label>
                    <select id="editTransactionCategory">
                        <!-- Options will be populated based on transaction type -->
                    </select>
                </div>
                
                <div id="editTransactionCustomerField" class="form-group" style="display: none;">
                    <label>Customer Name (Optional)</label>
                    <input type="text" id="editTransactionCustomer" placeholder="e.g., ABC Sdn Bhd">
                </div>
                
                <div id="editTransactionVendorField" class="form-group" style="display: none;">
                    <label>Vendor/Payee</label>
                    <input type="text" id="editTransactionVendor" placeholder="e.g., ABC Supplies Sdn Bhd">
                </div>
                
                <div class="form-group">
                    <label>Payment Method</label>
                    <select id="editTransactionMethod">
                        <option value="cash">Cash</option>
                        <option value="bank">Bank Transfer</option>
                        <option value="card">Credit/Debit Card</option>
                        <option value="ewallet">E-Wallet</option>
                        <option value="check">Check</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                
                <div class="form-actions" style="display: flex; gap: 10px; margin-top: 20px;">
                    <button class="btn-primary" style="flex: 1;" onclick="saveEditedTransaction()">Save Changes</button>
                    <button class="btn-secondary" style="flex: 1;" onclick="closeEditTransactionModal()">Cancel</button>
                    <button class="btn-danger" style="flex: 1;" onclick="deleteTransaction()">Delete</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Import Data Modal -->
    <div class="modal" id="importModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Import Data</h3>
                <button class="close-modal" onclick="closeImportModal()">&times;</button>
            </div>
            <div class="transaction-form">
                <div class="form-group">
                    <label>Select Backup File</label>
                    <input type="file" id="importFile" accept=".json">
                </div>
                <div class="form-group">
                    <label>Import Type</label>
                    <select id="importType">
                        <option value="replace">Replace All Data</option>
                        <option value="merge">Merge with Existing Data</option>
                    </select>
                </div>
                <div class="form-actions" style="display: flex; gap: 10px; margin-top: 20px;">
                    <button class="btn-primary" style="flex: 1;" onclick="processImport()">Import</button>
                    <button class="btn-secondary" style="flex: 1;" onclick="closeImportModal()">Cancel</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- ==================== PHASE 2: PRODUCT MODAL ==================== -->
    <div class="modal" id="productModal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h3 class="modal-title" id="productModalTitle">Add Product</h3>
                <button class="modal-close" onclick="closeModal('productModal')">&times;</button>
            </div>
            <form id="productForm" onsubmit="saveProduct(event)">
                <input type="hidden" id="productId">
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label">Product Name *</label>
                        <input type="text" id="productName" class="form-control" required placeholder="e.g., Nasi Lemak Special">
                    </div>
                    <div class="form-group">
                        <label class="form-label">SKU Code</label>
                        <div style="display: flex; gap: 5px; align-items: center;">
                            <input type="text" id="productSKUPrefix" class="form-control" placeholder="EZ" style="width: 80px; text-transform: uppercase;" oninput="this.value = this.value.toUpperCase(); updateCombinedSKU();">
                            <span style="color: #64748b; font-weight: 600;">-</span>
                            <input type="text" id="productSKUNumber" class="form-control" placeholder="001" style="flex: 1;" oninput="updateCombinedSKU();">
                            <button type="button" class="btn-outline" onclick="generateSKU()" title="Auto-generate">
                                <i class="fas fa-sync"></i>
                            </button>
                        </div>
                        <input type="hidden" id="productSKU">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Category *</label>
                        <select id="productCategory" class="form-control" required>
                            <option value="">Select Category</option>
                            <option value="Food">Food</option>
                            <option value="Beverage">Beverage</option>
                            <option value="Electronics">Electronics</option>
                            <option value="Clothing">Clothing</option>
                            <option value="Services">Services</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Preferred Supplier</label>
                        <select id="productSupplier" class="form-control">
                            <option value="">-- No Supplier --</option>
                            <!-- Suppliers loaded dynamically -->
                        </select>
                    </div>
                    <div class="form-group full-width">
                        <label class="form-label">Available at Outlets</label>
                        <div style="display: flex; gap: 5px; align-items: flex-start;">
                            <div id="productOutletCheckboxes" class="outlet-checkbox-container">
                                <!-- Outlet checkboxes loaded dynamically from branches -->
                            </div>
                            <!-- Outlets managed in Branches section - button hidden -->
                            <button type="button" class="btn-outline" onclick="showOutletModal()" title="Manage Outlets" style="height: 36px; display: none;">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Unit</label>
                        <select id="productUnit" class="form-control">
                            <option value="pcs">Pieces (pcs)</option>
                            <option value="kg">Kilogram (kg)</option>
                            <option value="g">Gram (g)</option>
                            <option value="l">Liter (l)</option>
                            <option value="ml">Milliliter (ml)</option>
                            <option value="cup">Cup</option>
                            <option value="box">Box</option>
                            <option value="pack">Pack</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Cost Price (RM) *</label>
                        <div class="cost-input-wrapper">
                            <input type="number" id="productCost" class="form-control" required step="0.01" min="0" placeholder="0.00" oninput="calculateProfitMargin()">
                            <div class="cost-suggestion" id="costSuggestion" style="display: none;">
                                <small><i class="fas fa-lightbulb"></i> <span id="costSuggestionText"></span></small>
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Selling Price (RM) *</label>
                        <input type="number" id="productPrice" class="form-control" required step="0.01" min="0" placeholder="0.00" oninput="suggestCostFromPrice()">
                        <div class="margin-display" id="marginDisplay" style="display: none; margin-top: 5px;">
                            <small style="color: #10b981;"><i class="fas fa-chart-line"></i> Profit Margin: <strong id="profitMarginText">0%</strong> (RM <span id="profitAmountText">0.00</span>)</small>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Target Margin %</label>
                        <div style="display: flex; gap: 5px; align-items: center;">
                            <input type="number" id="targetMargin" class="form-control" min="0" max="100" step="1" value="30" placeholder="30" oninput="suggestCostFromPrice()" style="width: 80px;">
                            <button type="button" class="btn-outline" onclick="applySuggestedCost()" title="Auto-calculate cost from selling price & margin">
                                <i class="fas fa-calculator"></i> Auto Cost
                            </button>
                        </div>
                    </div>
                    
                    <!-- Branch-Specific Stock Section -->
                    <div class="form-group full-width">
                        <label class="form-label"><i class="fas fa-warehouse"></i> Stock by Branch/Outlet</label>
                        <div id="branchStockInputs" class="branch-stock-grid">
                            <!-- Branch stock inputs loaded dynamically -->
                        </div>
                        <input type="hidden" id="productStock" value="0">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Minimum Stock Level (per branch)</label>
                        <input type="number" id="productMinStock" class="form-control" min="0" value="5">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Tax Rate (%)</label>
                        <div style="display: flex; gap: 5px; align-items: center;">
                            <input type="number" id="productTax" class="form-control" min="0" max="100" step="0.1" value="6" placeholder="0 for tax-exempt">
                            <span style="color: #64748b; font-size: 12px; white-space: nowrap;">0 = No Tax</span>
                        </div>
                    </div>
                    <div class="form-group full-width">
                        <label class="form-label">Description</label>
                        <textarea id="productDescription" class="form-control" rows="2" placeholder="Optional product description"></textarea>
                    </div>
                    <div class="form-group full-width">
                        <label class="form-label">Product Image</label>
                        <div class="image-upload-container">
                            <div class="image-preview" id="productImagePreview">
                                <i class="fas fa-image"></i>
                                <span>No image</span>
                            </div>
                            <div class="image-upload-actions">
                                <input type="file" id="productImage" accept="image/*" style="display: none;" onchange="previewProductImage(this)">
                                <button type="button" class="btn-outline" onclick="document.getElementById('productImage').click()">
                                    <i class="fas fa-upload"></i> Upload Image
                                </button>
                                <button type="button" class="btn-outline danger" onclick="clearProductImage()" style="display: none;" id="clearImageBtn">
                                    <i class="fas fa-trash"></i> Remove
                                </button>
                            </div>
                        </div>
                        <input type="hidden" id="productImageData">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn-secondary" onclick="closeModal('productModal')">Cancel</button>
                    <button type="submit" class="btn-primary">Save Product</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- ==================== PHASE 2: CUSTOMER MODAL ==================== -->
    <!-- ==================== PHASE 2: STOCK ADJUSTMENT MODAL ==================== -->
    <div class="modal" id="stockAdjustmentModal">
        <div class="modal-content" style="max-width: 450px;">
            <div class="modal-header">
                <h3 class="modal-title">Adjust Stock</h3>
                <button class="modal-close" onclick="closeModal('stockAdjustmentModal')">&times;</button>
            </div>
            <form id="stockAdjustmentForm" onsubmit="saveStockAdjustment(event)">
                <div class="form-group">
                    <label class="form-label">Product *</label>
                    <select id="adjustProductId" class="form-control" required onchange="showCurrentStock()">
                        <option value="">Select Product</option>
                        <!-- Products loaded dynamically -->
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Current Stock</label>
                    <input type="text" id="currentStockDisplay" class="form-control" readonly disabled placeholder="Select a product">
                </div>
                <div class="form-group">
                    <label class="form-label">Adjustment Type *</label>
                    <select id="adjustmentType" class="form-control" required>
                        <option value="in">Stock In (+)</option>
                        <option value="out">Stock Out (-)</option>
                        <option value="set">Set Exact Quantity</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Quantity *</label>
                    <input type="number" id="adjustQuantity" class="form-control" required min="0" value="0">
                </div>
                <div class="form-group">
                    <label class="form-label">Reason *</label>
                    <select id="adjustReason" class="form-control" required>
                        <option value="">Select Reason</option>
                        <option value="purchase">New Purchase/Restock</option>
                        <option value="return">Customer Return</option>
                        <option value="damaged">Damaged/Expired</option>
                        <option value="lost">Lost/Missing</option>
                        <option value="correction">Stock Correction</option>
                        <option value="transfer">Transfer</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Notes</label>
                    <textarea id="adjustNotes" class="form-control" rows="2" placeholder="Additional details"></textarea>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn-secondary" onclick="closeModal('stockAdjustmentModal')">Cancel</button>
                    <button type="submit" class="btn-primary">Save Adjustment</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- ==================== OUTLET MANAGEMENT MODAL ==================== -->
    <div class="modal" id="outletModal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h3 class="modal-title">Manage Outlets</h3>
                <button class="modal-close" onclick="closeModal('outletModal')">&times;</button>
            </div>
            <div style="padding: 20px;">
                <!-- Add New Outlet -->
                <div style="margin-bottom: 20px;">
                    <label class="form-label">Add New Outlet</label>
                    <div style="display: flex; gap: 8px;">
                        <input type="text" id="newOutletName" class="form-control" placeholder="e.g., Main Branch, Outlet KL">
                        <button type="button" class="btn-primary" onclick="addOutlet()">
                            <i class="fas fa-plus"></i> Add
                        </button>
                    </div>
                </div>
                
                <!-- Outlet List -->
                <div>
                    <label class="form-label">Your Outlets</label>
                    <div id="outletList" style="max-height: 300px; overflow-y: auto;">
                        <!-- Outlets will be listed here -->
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-secondary" onclick="closeModal('outletModal')">Close</button>
            </div>
        </div>
    </div>
    
    <!-- ==================== SUPPLIER MODAL ==================== -->
    <div class="modal" id="supplierModal">
        <div class="modal-content" style="max-width: 650px;">
            <div class="modal-header">
                <h3 class="modal-title" id="supplierModalTitle">Add Supplier</h3>
                <button class="modal-close" onclick="closeSupplierModal()">&times;</button>
            </div>
            <form id="supplierForm" onsubmit="saveSupplier(event)">
                <input type="hidden" id="supplierId">
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label">Contact Person</label>
                        <input type="text" id="supplierName" class="form-control" placeholder="Contact name">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Company Name *</label>
                        <input type="text" id="supplierCompany" class="form-control" placeholder="Company/Business name" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Email</label>
                        <input type="email" id="supplierEmail" class="form-control" placeholder="supplier@company.com">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Phone</label>
                        <input type="tel" id="supplierPhone" class="form-control" placeholder="012-345 6789">
                    </div>
                    <div class="form-group full-width">
                        <label class="form-label">Address</label>
                        <textarea id="supplierAddress" class="form-control" rows="2" placeholder="Full address"></textarea>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Category</label>
                        <select id="supplierCategory" class="form-control">
                            <option value="general">General</option>
                            <option value="raw-materials">Raw Materials</option>
                            <option value="packaging">Packaging</option>
                            <option value="equipment">Equipment</option>
                            <option value="services">Services</option>
                            <option value="logistics">Logistics</option>
                            <option value="office">Office Supplies</option>
                            <option value="utilities">Utilities</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Payment Terms</label>
                        <select id="supplierPaymentTerms" class="form-control">
                            <option value="0">Immediate / COD</option>
                            <option value="7">Net 7 days</option>
                            <option value="14">Net 14 days</option>
                            <option value="30" selected>Net 30 days</option>
                            <option value="45">Net 45 days</option>
                            <option value="60">Net 60 days</option>
                            <option value="90">Net 90 days</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Credit Limit (RM)</label>
                        <input type="number" id="supplierCreditLimit" class="form-control" step="0.01" min="0" placeholder="0 = No limit">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Status</label>
                        <select id="supplierStatus" class="form-control">
                            <option value="active">Active</option>
                            <option value="inactive">Inactive</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Bank Name</label>
                        <input type="text" id="supplierBankName" class="form-control" placeholder="e.g., Maybank, CIMB">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Bank Account No.</label>
                        <input type="text" id="supplierBankAccount" class="form-control" placeholder="Account number">
                    </div>
                    <div class="form-group full-width">
                        <label class="form-label">Notes</label>
                        <textarea id="supplierNotes" class="form-control" rows="2" placeholder="Additional notes about this supplier"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn-secondary" onclick="closeSupplierModal()">Cancel</button>
                    <button type="submit" class="btn-primary">
                        <i class="fas fa-save"></i> Save Supplier
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- ==================== PURCHASE ORDER MODAL ==================== -->
    <div class="modal" id="purchaseOrderModal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h3 class="modal-title" id="poModalTitle"><i class="fas fa-file-invoice"></i> New Purchase Order</h3>
                <button class="modal-close" onclick="closePurchaseOrderModal()">&times;</button>
            </div>
            <form id="purchaseOrderForm" onsubmit="event.preventDefault(); savePurchaseOrder();">
                <input type="hidden" id="poId">
                
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label">PO Number</label>
                        <input type="text" id="poNumber" class="form-control" readonly placeholder="Auto-generated">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Date *</label>
                        <input type="date" id="poDate" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Supplier *</label>
                        <select id="poSupplier" class="form-control" required onchange="onPOSupplierChange()">
                            <option value="">Select Supplier</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Expected Delivery</label>
                        <input type="date" id="poExpectedDelivery" class="form-control">
                    </div>
                </div>
                
                <!-- PO Items -->
                <div style="margin: 20px 0;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <h4 style="margin: 0;"><i class="fas fa-list"></i> Order Items</h4>
                        <button type="button" class="btn-secondary" onclick="addPOItem()">
                            <i class="fas fa-plus"></i> Add Item
                        </button>
                    </div>
                    <div class="po-items-header" style="display: grid; grid-template-columns: 2fr 100px 100px 120px 40px; gap: 10px; padding: 10px; background: #f1f5f9; border-radius: 8px 8px 0 0; font-weight: 600; font-size: 13px;">
                        <span>Product/Description</span>
                        <span>Quantity</span>
                        <span>Unit Price</span>
                        <span>Total</span>
                        <span></span>
                    </div>
                    <div id="poItemsContainer" style="border: 1px solid #e2e8f0; border-top: none; border-radius: 0 0 8px 8px; max-height: 250px; overflow-y: auto;">
                        <!-- PO items will be added here -->
                    </div>
                </div>
                
                <!-- PO Totals -->
                <div style="display: flex; justify-content: flex-end; gap: 30px; margin: 20px 0; padding: 15px; background: #f8fafc; border-radius: 8px;">
                    <div>
                        <span style="color: #64748b;">Subtotal:</span>
                        <strong id="poSubtotal" style="margin-left: 10px;">RM 0.00</strong>
                    </div>
                    <div>
                        <span style="color: #64748b;">Tax (0%):</span>
                        <strong id="poTax" style="margin-left: 10px;">RM 0.00</strong>
                    </div>
                    <div style="font-size: 18px;">
                        <span style="color: #1e293b;">Total:</span>
                        <strong id="poTotal" style="margin-left: 10px; color: #2563eb;">RM 0.00</strong>
                    </div>
                </div>
                
                <div class="form-grid">
                    <div class="form-group full-width">
                        <label class="form-label">Remarks</label>
                        <textarea id="poRemarks" class="form-control" rows="2" placeholder="Additional notes or delivery instructions"></textarea>
                    </div>
                </div>
                
                <div class="modal-footer">
                    <button type="button" class="btn-secondary" onclick="closePurchaseOrderModal()">Cancel</button>
                    <button type="button" class="btn-outline" onclick="savePurchaseOrder('draft')">
                        <i class="fas fa-save"></i> Save as Draft
                    </button>
                    <button type="submit" class="btn-primary">
                        <i class="fas fa-paper-plane"></i> Submit for Approval
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- ==================== RECEIVE GOODS MODAL ==================== -->
    <div class="modal" id="receiveGoodsModal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h3 class="modal-title"><i class="fas fa-box"></i> Receive Goods</h3>
                <button class="modal-close" onclick="closeReceiveGoodsModal()">&times;</button>
            </div>
            <form id="receiveGoodsForm" onsubmit="event.preventDefault(); saveGoodsReceipt();">
                <input type="hidden" id="receivePoId">
                
                <div class="form-grid" style="margin-bottom: 20px;">
                    <div class="form-group">
                        <label class="form-label">PO Number</label>
                        <input type="text" id="receivePONumber" class="form-control" readonly>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Supplier</label>
                        <input type="text" id="receiveSupplier" class="form-control" readonly>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Receipt Date *</label>
                        <input type="date" id="receiveDate" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Delivery Note #</label>
                        <input type="text" id="receiveDeliveryNote" class="form-control" placeholder="Supplier's delivery note number">
                    </div>
                </div>
                
                <!-- Items to Receive -->
                <h4 style="margin-bottom: 10px;"><i class="fas fa-list-check"></i> Items to Receive</h4>
                <div id="receiveItemsContainer" style="border: 1px solid #e2e8f0; border-radius: 8px; max-height: 300px; overflow-y: auto;">
                    <!-- Items will be loaded here -->
                </div>
                
                <div class="form-group" style="margin-top: 15px;">
                    <label class="form-label">Notes</label>
                    <textarea id="receiveNotes" class="form-control" rows="2" placeholder="Any issues or notes about this delivery"></textarea>
                </div>
                
                <div class="modal-footer">
                    <button type="button" class="btn-secondary" onclick="closeReceiveGoodsModal()">Cancel</button>
                    <button type="submit" class="btn-primary">
                        <i class="fas fa-check"></i> Confirm Receipt
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- ==================== SUPPLIER DETAIL MODAL ==================== -->
    <div class="modal" id="supplierDetailModal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h3 class="modal-title" id="supplierDetailTitle">Supplier Details</h3>
                <button class="modal-close" onclick="closeModal('supplierDetailModal')">&times;</button>
            </div>
            <div id="supplierDetailContent" style="padding: 20px; max-height: 75vh; overflow-y: auto;">
                <!-- Supplier details loaded dynamically -->
            </div>
        </div>
    </div>
    
    <!-- ==================== CRM CUSTOMER MODAL ==================== -->
    <div class="modal" id="crmCustomerModal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h3 class="modal-title" id="crmCustomerModalTitle">Add Customer</h3>
                <button class="modal-close" onclick="closeModal('crmCustomerModal')">&times;</button>
            </div>
            <form id="crmCustomerForm" onsubmit="saveCRMCustomer(event)">
                <input type="hidden" id="crmCustomerId">
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label">Customer Name *</label>
                        <input type="text" id="crmCustomerName" class="form-control" required placeholder="Full name or company name">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Group</label>
                        <select id="crmCustomerGroup" class="form-control">
                            <option value="regular">Regular</option>
                            <option value="vip">VIP</option>
                            <option value="b2b">B2B (Business)</option>
                            <option value="new">New Customer</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Phone</label>
                        <input type="tel" id="crmCustomerPhone" class="form-control" placeholder="e.g., 012-3456789">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Email</label>
                        <input type="email" id="crmCustomerEmail" class="form-control" placeholder="email@example.com">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Company</label>
                        <input type="text" id="crmCustomerCompany" class="form-control" placeholder="Company name (if B2B)">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Credit Terms</label>
                        <select id="crmCustomerCreditTerms" class="form-control">
                            <option value="cod">COD (Cash on Delivery)</option>
                            <option value="7days">Net 7 Days</option>
                            <option value="14days">Net 14 Days</option>
                            <option value="30days">Net 30 Days</option>
                            <option value="60days">Net 60 Days</option>
                            <option value="90days">Net 90 Days</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Credit Limit (RM)</label>
                        <input type="number" id="crmCustomerCreditLimit" class="form-control" step="0.01" min="0" value="0" placeholder="0 = No limit">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Status</label>
                        <select id="crmCustomerStatus" class="form-control">
                            <option value="active">Active</option>
                            <option value="inactive">Inactive</option>
                        </select>
                    </div>
                    <div class="form-group full-width">
                        <label class="form-label">Address</label>
                        <textarea id="crmCustomerAddress" class="form-control" rows="2" placeholder="Full address"></textarea>
                    </div>
                    <div class="form-group full-width">
                        <label class="form-label">Notes</label>
                        <textarea id="crmCustomerNotes" class="form-control" rows="2" placeholder="Internal notes about this customer"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn-secondary" onclick="closeModal('crmCustomerModal')">Cancel</button>
                    <button type="submit" class="btn-primary">Save Customer</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- ==================== CRM CUSTOMER DETAIL MODAL ==================== -->
    <div class="modal" id="crmCustomerDetailModal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h3 class="modal-title" id="crmDetailTitle">Customer Details</h3>
                <button class="modal-close" onclick="closeModal('crmCustomerDetailModal')">&times;</button>
            </div>
            <div id="crmCustomerDetailContent" style="padding: 20px;">
                <!-- Customer details will be loaded here -->
            </div>
        </div>
    </div>
    
    <!-- ==================== QUOTATION MODAL ==================== -->
    <div class="modal" id="quotationModal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h3 class="modal-title" id="quotationModalTitle">New Quotation</h3>
                <button class="modal-close" onclick="closeModal('quotationModal')">&times;</button>
            </div>
            <form id="quotationForm" onsubmit="event.preventDefault(); saveQuotation('draft');">
                <input type="hidden" id="quotationId">
                <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
                    <!-- Header Info -->
                    <div class="form-row">
                        <div class="form-group" style="flex: 1;">
                            <label class="form-label">Quotation No</label>
                            <input type="text" id="quotationNo" class="form-control" readonly style="background: #f1f5f9;">
                        </div>
                        <div class="form-group" style="flex: 1;">
                            <label class="form-label">Date *</label>
                            <input type="date" id="quotationDate" class="form-control" required>
                        </div>
                        <div class="form-group" style="flex: 1;">
                            <label class="form-label">Valid Until *</label>
                            <input type="date" id="quotationValidUntil" class="form-control" required>
                        </div>
                    </div>
                    
                    <!-- Customer Selection -->
                    <div class="form-group">
                        <label class="form-label">Customer *</label>
                        <select id="quotationCustomer" class="form-control" required onchange="onQuotationCustomerChange()">
                            <option value="">-- Select Customer --</option>
                        </select>
                    </div>
                    <div id="quotationCustomerInfo" style="display: none;"></div>
                    
                    <!-- Salesperson -->
                    <div class="form-group">
                        <label class="form-label">Salesperson</label>
                        <select id="quotationSalesperson" class="form-control">
                            <option value="">-- Select Salesperson --</option>
                        </select>
                    </div>
                    
                    <!-- Subject -->
                    <div class="form-group">
                        <label class="form-label">Subject / Project Title</label>
                        <input type="text" id="quotationSubject" class="form-control" placeholder="e.g., Home Renovation, Website Development">
                    </div>
                    
                    <!-- Items Section -->
                    <div class="quotation-items-section">
                        <div class="section-header">
                            <h4><i class="fas fa-list"></i> Items</h4>
                            <button type="button" class="btn-outline btn-sm" onclick="addQuotationItem()">
                                <i class="fas fa-plus"></i> Add Item
                            </button>
                        </div>
                        <div class="quotation-items-header">
                            <div class="item-main">Description</div>
                            <div class="item-qty">Qty</div>
                            <div class="item-price">Unit Price (RM)</div>
                            <div class="item-total">Total</div>
                            <div class="item-actions"></div>
                        </div>
                        <div id="quotationItemsContainer">
                            <!-- Items will be rendered here -->
                        </div>
                    </div>
                    
                    <!-- Totals -->
                    <div class="quotation-totals-section">
                        <div class="form-row" style="justify-content: flex-end; gap: 20px;">
                            <div class="form-group" style="width: 120px;">
                                <label class="form-label">Discount (%)</label>
                                <input type="number" id="quotationDiscount" class="form-control" min="0" max="100" step="0.1" value="0" oninput="calculateQuotationTotals()">
                            </div>
                            <div class="form-group" style="width: 120px;">
                                <label class="form-label">Tax/SST (%)</label>
                                <input type="number" id="quotationTax" class="form-control" min="0" max="100" step="0.1" value="0" oninput="calculateQuotationTotals()">
                            </div>
                        </div>
                        <div class="totals-display">
                            <div class="total-row">
                                <span>Subtotal:</span>
                                <span id="quotationSubtotal">RM 0.00</span>
                            </div>
                            <div class="total-row">
                                <span>Discount:</span>
                                <span id="quotationDiscountAmount">- RM 0.00</span>
                            </div>
                            <div class="total-row">
                                <span>Tax/SST:</span>
                                <span id="quotationTaxAmount">+ RM 0.00</span>
                            </div>
                            <div class="total-row grand">
                                <span>Grand Total:</span>
                                <span id="quotationGrandTotal">RM 0.00</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Notes & Terms -->
                    <div class="form-group">
                        <label class="form-label">Notes (visible to customer)</label>
                        <textarea id="quotationNotes" class="form-control" rows="2" placeholder="Additional notes for the customer..."></textarea>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Terms & Conditions</label>
                        <textarea id="quotationTerms" class="form-control" rows="3" placeholder="Payment terms, validity, etc."></textarea>
                    </div>
                </div>
                <div class="modal-footer" style="display: flex; gap: 10px; justify-content: flex-end;">
                    <button type="button" class="btn-secondary" onclick="closeModal('quotationModal')">Cancel</button>
                    <button type="submit" class="btn-outline">
                        <i class="fas fa-save"></i> Save as Draft
                    </button>
                    <button type="button" class="btn-primary" onclick="saveAndSendQuotation()">
                        <i class="fas fa-paper-plane"></i> Save & Mark Sent
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- ==================== QUOTATION DETAIL MODAL ==================== -->
    <div class="modal" id="quotationDetailModal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h3 class="modal-title">Quotation Details</h3>
                <button class="modal-close" onclick="closeModal('quotationDetailModal')">&times;</button>
            </div>
            <div id="quotationDetailContent" style="padding: 20px; max-height: 75vh; overflow-y: auto;">
                <!-- Quotation details will be loaded here -->
            </div>
        </div>
    </div>
    
    <!-- ==================== INVOICE MODAL ==================== -->
    <div class="modal" id="invoiceModal">
        <div class="modal-content" style="max-width: 850px;">
            <div class="modal-header">
                <h3 class="modal-title" id="invoiceModalTitle">New Invoice</h3>
                <button class="modal-close" onclick="closeInvoiceModal()">&times;</button>
            </div>
            <form id="invoiceForm" onsubmit="saveInvoice(event)">
                <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Invoice Number</label>
                            <input type="text" id="invoiceNo" class="form-control" readonly style="background: #f1f5f9;">
                        </div>
                        <div class="form-group">
                            <label>Invoice Date</label>
                            <input type="date" id="invoiceDate" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label>Due Date</label>
                            <input type="date" id="invoiceDueDate" class="form-control" required>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group" style="flex: 2;">
                            <label>Customer</label>
                            <select id="invoiceCustomer" class="form-control">
                                <option value="">-- Select Customer --</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Status</label>
                            <select id="invoiceStatus" class="form-control">
                                <option value="draft">Draft</option>
                                <option value="unpaid" selected>Unpaid</option>
                                <option value="paid">Paid</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>Description / Reference</label>
                        <input type="text" id="invoiceDescription" class="form-control" placeholder="e.g., Monthly Retainer - December 2025">
                    </div>
                    
                    <!-- Invoice Items -->
                    <div style="margin: 15px 0;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <label style="font-weight: 600;"><i class="fas fa-list"></i> Invoice Items</label>
                            <button type="button" class="btn-secondary btn-sm" onclick="addInvoiceItem()">
                                <i class="fas fa-plus"></i> Add Item
                            </button>
                        </div>
                        
                        <div class="invoice-items-header" style="display: grid; grid-template-columns: 2fr 80px 120px 120px 40px; gap: 10px; padding: 8px 10px; background: #1e293b; color: white; border-radius: 6px 6px 0 0; font-size: 12px; font-weight: 600;">
                            <div>Description</div>
                            <div style="text-align: center;">Qty</div>
                            <div style="text-align: right;">Unit Price</div>
                            <div style="text-align: right;">Amount</div>
                            <div></div>
                        </div>
                        <div id="invoiceItemsContainer" style="border: 1px solid #e2e8f0; border-top: none; border-radius: 0 0 6px 6px;">
                            <!-- Items will be added here -->
                        </div>
                    </div>
                    
                    <!-- Totals -->
                    <div style="display: flex; justify-content: flex-end; margin: 15px 0;">
                        <div style="width: 280px; background: #f8fafc; padding: 15px; border-radius: 8px;">
                            <div style="display: flex; justify-content: space-between; padding: 5px 0; font-size: 14px;">
                                <span>Subtotal:</span>
                                <span id="invoiceSubtotal">RM 0.00</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 5px 0; font-size: 14px; align-items: center;">
                                <span>Tax: <input type="number" id="invoiceTaxRate" value="0" min="0" max="100" step="1" style="width: 50px; padding: 2px 5px; text-align: center;" onchange="updateInvoiceTotals()">%</span>
                                <span id="invoiceTax">RM 0.00</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 10px 0; font-size: 18px; font-weight: 700; border-top: 2px solid #cbd5e1; margin-top: 5px;">
                                <span>Total:</span>
                                <span id="invoiceTotal" style="color: #2563eb;">RM 0.00</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Notes & Terms -->
                    <div class="form-row">
                        <div class="form-group">
                            <label>Notes (visible to customer)</label>
                            <textarea id="invoiceNotes" class="form-control" rows="2" placeholder="Any additional notes..."></textarea>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Terms & Conditions</label>
                        <textarea id="invoiceTerms" class="form-control" rows="2">Payment due within 30 days of invoice date.</textarea>
                    </div>
                    
                    <!-- Recurring Options -->
                    <div style="margin-top: 15px; padding: 15px; background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); border-radius: 8px; border: 1px solid #bae6fd;">
                        <label style="display: flex; align-items: center; gap: 10px; cursor: pointer; margin-bottom: 10px;">
                            <input type="checkbox" id="invoiceRecurring" onchange="toggleRecurringInvoiceOptions()" style="width: 18px; height: 18px; accent-color: #0369a1; flex-shrink: 0;">
                            <span style="font-weight: 600; color: #0369a1;"><i class="fas fa-redo" style="margin-right: 6px;"></i>Make this a recurring invoice</span>
                        </label>
                        <div id="recurringInvoiceOptions" style="display: none; margin-top: 10px;">
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Frequency</label>
                                    <select id="invoiceRecurringFrequency" class="form-control">
                                        <option value="weekly">Weekly</option>
                                        <option value="monthly" selected>Monthly</option>
                                        <option value="quarterly">Quarterly</option>
                                        <option value="yearly">Yearly</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>End Date (optional)</label>
                                    <input type="date" id="invoiceRecurringEnd" class="form-control">
                                </div>
                            </div>
                            <p style="font-size: 12px; color: #64748b; margin: 5px 0 0;">
                                <i class="fas fa-info-circle"></i> A new invoice will be auto-generated based on this template.
                            </p>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn-secondary" onclick="closeInvoiceModal()">Cancel</button>
                    <button type="submit" class="btn-primary"><i class="fas fa-save"></i> Save Invoice</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- ==================== VIEW INVOICE MODAL ==================== -->
    <div class="modal" id="viewInvoiceModal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h3 class="modal-title">Invoice Details</h3>
                <button class="modal-close" onclick="closeViewInvoiceModal()">&times;</button>
            </div>
            <input type="hidden" id="viewInvoiceId">
            <div id="viewInvoiceContent" style="padding: 20px; max-height: 70vh; overflow-y: auto;">
                <!-- Invoice preview will be loaded here -->
            </div>
            <div class="modal-footer" style="display: flex; gap: 10px; justify-content: flex-end; flex-wrap: wrap;">
                <button type="button" class="btn-secondary" onclick="showInvoiceTemplateSelector()" title="Choose Template">
                    <i class="fas fa-palette"></i> Template
                </button>
                <button type="button" class="btn-secondary" onclick="editInvoice(document.getElementById('viewInvoiceId').value); closeViewInvoiceModal();">
                    <i class="fas fa-edit"></i> Edit
                </button>
                <button type="button" class="btn-secondary" onclick="recordPayment(document.getElementById('viewInvoiceId').value); closeViewInvoiceModal();">
                    <i class="fas fa-money-bill-wave"></i> Record Payment
                </button>
                <button type="button" class="btn-primary" onclick="generateInvoicePDF(document.getElementById('viewInvoiceId').value)">
                    <i class="fas fa-file-pdf"></i> Generate PDF
                </button>
                <button type="button" class="btn-secondary" style="color: #3b82f6;" onclick="sendInvoiceEmail(document.getElementById('viewInvoiceId').value)" title="Send via Email">
                    <i class="fas fa-envelope"></i>
                </button>
                <button type="button" class="btn-secondary" style="color: #25d366;" onclick="sendInvoiceWhatsApp(document.getElementById('viewInvoiceId').value)" title="Send via WhatsApp">
                    <i class="fab fa-whatsapp"></i>
                </button>
            </div>
        </div>
    </div>
    
    <!-- ==================== PAYMENT MODAL ==================== -->
    <div class="modal" id="paymentModal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h3 class="modal-title"><i class="fas fa-money-bill-wave"></i> Record Payment</h3>
                <button class="modal-close" onclick="closePaymentModal()">&times;</button>
            </div>
            <form onsubmit="savePayment(event)">
                <input type="hidden" id="paymentInvoiceId">
                <div class="modal-body">
                    <div style="background: #f0fdf4; padding: 15px; border-radius: 8px; margin-bottom: 20px; text-align: center;">
                        <div style="color: #166534; font-size: 14px;">Invoice: <strong id="paymentInvoiceNo"></strong></div>
                        <div style="color: #166534; font-size: 24px; font-weight: 700; margin-top: 5px;">Outstanding: <span id="paymentOutstanding"></span></div>
                    </div>
                    
                    <div class="form-group">
                        <label>Payment Amount (RM)</label>
                        <input type="number" id="paymentAmount" class="form-control" step="0.01" min="0.01" required style="font-size: 18px; font-weight: 600;">
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Payment Date</label>
                            <input type="date" id="paymentDate" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label>Payment Method</label>
                            <select id="paymentMethod" class="form-control">
                                <option value="bank">Bank Transfer</option>
                                <option value="cash">Cash</option>
                                <option value="card">Credit/Debit Card</option>
                                <option value="ewallet">E-Wallet</option>
                                <option value="cheque">Cheque</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>Reference / Transaction ID</label>
                        <input type="text" id="paymentReference" class="form-control" placeholder="e.g., TRX123456">
                    </div>
                    
                    <div class="form-group">
                        <label>Notes</label>
                        <textarea id="paymentNotes" class="form-control" rows="2" placeholder="Optional notes"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn-secondary" onclick="closePaymentModal()">Cancel</button>
                    <button type="submit" class="btn-primary" style="background: #10b981;"><i class="fas fa-check"></i> Record Payment</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- ==================== PROJECT MODAL ==================== -->
    <div class="modal" id="projectModal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h3 class="modal-title" id="projectModalTitle">New Project</h3>
                <button class="modal-close" onclick="closeModal('projectModal')">&times;</button>
            </div>
            <form id="projectForm" onsubmit="saveProject(event)">
                <input type="hidden" id="projectId">
                <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
                    <div class="form-row">
                        <div class="form-group" style="flex: 2;">
                            <label class="form-label">Project Name *</label>
                            <input type="text" id="projectName" class="form-control" required placeholder="e.g., Home Renovation - Mr. Tan">
                        </div>
                        <div class="form-group" style="flex: 1;">
                            <label class="form-label">Status</label>
                            <select id="projectStatus" class="form-control">
                                <option value="quotation">Quotation</option>
                                <option value="confirmed">Confirmed</option>
                                <option value="in-progress">In Progress</option>
                                <option value="completed">Completed</option>
                                <option value="cancelled">Cancelled</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Customer</label>
                        <select id="projectCustomer" class="form-control">
                            <option value="">-- Select Customer --</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Salesperson</label>
                        <select id="projectSalesperson" class="form-control">
                            <option value="">-- Select Salesperson --</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Description</label>
                        <textarea id="projectDescription" class="form-control" rows="2" placeholder="Project details..."></textarea>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Total Amount (RM) *</label>
                            <input type="number" id="projectTotalAmount" class="form-control" step="0.01" min="0" required placeholder="0.00" oninput="updateMilestoneTotal()">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Start Date</label>
                            <input type="date" id="projectStartDate" class="form-control">
                        </div>
                        <div class="form-group">
                            <label class="form-label">End Date</label>
                            <input type="date" id="projectEndDate" class="form-control">
                        </div>
                    </div>
                    
                    <div class="milestones-section">
                        <div class="milestones-header">
                            <h4><i class="fas fa-tasks"></i> Payment Milestones</h4>
                            <div class="milestone-total-badge">Total: <span id="milestoneTotal">0%</span></div>
                        </div>
                        <p class="text-muted" style="font-size: 12px; margin-bottom: 10px;">Define payment schedule (must total 100%)</p>
                        <div id="milestonesContainer">
                            <!-- Milestone inputs will be rendered here -->
                        </div>
                        <button type="button" class="btn-outline btn-sm" onclick="addMilestoneInput()" style="margin-top: 10px;">
                            <i class="fas fa-plus"></i> Add Milestone
                        </button>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn-secondary" onclick="closeModal('projectModal')">Cancel</button>
                    <button type="submit" class="btn-primary">
                        <i class="fas fa-save"></i> Save Project
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- ==================== PROJECT DETAIL MODAL ==================== -->
    <div class="modal" id="projectDetailModal">
        <div class="modal-content" style="max-width: 750px;">
            <div class="modal-header">
                <h3 class="modal-title" id="projectDetailTitle">Project Details</h3>
                <button class="modal-close" onclick="closeModal('projectDetailModal')">&times;</button>
            </div>
            <div id="projectDetailContent" style="padding: 20px; max-height: 75vh; overflow-y: auto;">
                <!-- Project details will be loaded here -->
            </div>
        </div>
    </div>
    
    <!-- ==================== PHASE 2: POS PAYMENT MODAL ==================== -->
    <div class="modal" id="posPaymentModal">
        <div class="modal-content" style="max-width: 450px;">
            <div class="modal-header">
                <h3 class="modal-title">Process Payment</h3>
                <button class="modal-close" onclick="closeModal('posPaymentModal')">&times;</button>
            </div>
            <div class="payment-summary">
                <div class="payment-total">
                    <span>Total Amount</span>
                    <span id="paymentTotalAmount">RM 0.00</span>
                </div>
            </div>
            <form id="paymentForm" onsubmit="processPayment(event)">
                <div class="form-group">
                    <label class="form-label">Payment Method *</label>
                    <div class="payment-methods">
                        <label class="payment-method-option">
                            <input type="radio" name="paymentMethod" value="cash" checked>
                            <span><i class="fas fa-money-bill-wave"></i> Cash</span>
                        </label>
                        <label class="payment-method-option">
                            <input type="radio" name="paymentMethod" value="card">
                            <span><i class="fas fa-credit-card"></i> Card</span>
                        </label>
                        <label class="payment-method-option">
                            <input type="radio" name="paymentMethod" value="ewallet">
                            <span><i class="fas fa-mobile-alt"></i> E-Wallet</span>
                        </label>
                        <label class="payment-method-option">
                            <input type="radio" name="paymentMethod" value="qr">
                            <span><i class="fas fa-qrcode"></i> DuitNow QR</span>
                        </label>
                        <label class="payment-method-option" id="creditPaymentOption" style="display: none;">
                            <input type="radio" name="paymentMethod" value="credit">
                            <span><i class="fas fa-file-invoice-dollar"></i> Credit</span>
                        </label>
                    </div>
                </div>
                <div class="form-group" id="creditInfoGroup" style="display: none;">
                    <div class="credit-info-box">
                        <div class="credit-info-header">
                            <i class="fas fa-info-circle"></i> Credit Account Info
                        </div>
                        <div class="credit-info-details">
                            <div class="credit-info-row">
                                <span>Credit Terms:</span>
                                <span id="creditTermsDisplay">-</span>
                            </div>
                            <div class="credit-info-row">
                                <span>Credit Limit:</span>
                                <span id="creditLimitDisplay">RM 0.00</span>
                            </div>
                            <div class="credit-info-row">
                                <span>Outstanding:</span>
                                <span id="creditOutstandingDisplay">RM 0.00</span>
                            </div>
                            <div class="credit-info-row">
                                <span>Available:</span>
                                <span id="creditAvailableDisplay" class="credit-available">RM 0.00</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="form-group" id="cashAmountGroup">
                    <label class="form-label">Amount Received (RM)</label>
                    <div style="display: flex; gap: 8px; align-items: center;">
                        <input type="number" id="amountReceived" class="form-control" step="0.01" min="0" oninput="calculateChange()" style="flex: 1;">
                        <button type="button" class="btn-primary" onclick="fillExactAmount()" title="Fill Exact Amount" style="white-space: nowrap; padding: 10px 16px;">
                            <i class="fas fa-equals"></i> Exact
                        </button>
                    </div>
                    <div class="change-display" id="changeDisplay" style="display: none;">
                        <span>Change:</span>
                        <span id="changeAmount">RM 0.00</span>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Transaction ID <small style="color: #94a3b8;">(Auto-generated if empty)</small></label>
                    <input type="text" id="posPaymentReference" class="form-control" placeholder="Auto-generated on payment">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn-secondary" onclick="closeModal('posPaymentModal')">Cancel</button>
                    <button type="submit" class="btn-primary">
                        <i class="fas fa-check"></i> Proceed
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- ==================== EMPLOYEE MODAL ==================== -->
    <div class="modal" id="employeeModal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h3 class="modal-title" id="employeeModalTitle">Add New Employee</h3>
                <button class="modal-close" onclick="closeEmployeeModal()">&times;</button>
            </div>
            <form id="employeeForm" onsubmit="event.preventDefault(); saveEmployee();">
                <input type="hidden" id="employeeId">
                
                <div class="form-section">
                    <h4><i class="fas fa-user"></i> Personal Information</h4>
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">Full Name *</label>
                            <input type="text" id="empName" class="form-control" required placeholder="Full name as per IC">
                        </div>
                        <div class="form-group">
                            <label class="form-label">IC Number *</label>
                            <input type="text" id="empIC" class="form-control" required placeholder="e.g., 900101-14-1234" maxlength="14">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Email</label>
                            <input type="email" id="empEmail" class="form-control" placeholder="employee@email.com">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Phone</label>
                            <input type="tel" id="empPhone" class="form-control" placeholder="012-345 6789">
                        </div>
                        <div class="form-group full-width">
                            <label class="form-label">Address</label>
                            <textarea id="empAddress" class="form-control" rows="2" placeholder="Full address"></textarea>
                        </div>
                    </div>
                </div>
                
                <div class="form-section">
                    <h4><i class="fas fa-briefcase"></i> Employment Details</h4>
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">Department</label>
                            <input type="text" id="empDepartment" class="form-control" placeholder="e.g., Sales, Operations">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Position</label>
                            <input type="text" id="empPosition" class="form-control" placeholder="e.g., Manager, Executive">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Employment Type</label>
                            <select id="empType" class="form-control">
                                <option value="full-time">Full Time</option>
                                <option value="part-time">Part Time</option>
                                <option value="contract">Contract</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">POS Account Type</label>
                            <select id="empPosAccountType" class="form-control">
                                <option value="staff">Staff</option>
                                <option value="manager">Manager</option>
                                <option value="admin">Admin</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Start Date</label>
                            <input type="date" id="empStartDate" class="form-control">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Basic Salary (RM) *</label>
                            <input type="number" id="empBasicSalary" class="form-control" required step="0.01" min="0" placeholder="Monthly basic salary">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Status</label>
                            <select id="empStatus" class="form-control">
                                <option value="active">Active</option>
                                <option value="inactive">Inactive</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <div class="form-section">
                    <h4><i class="fas fa-university"></i> Bank & Statutory</h4>
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">Bank Name</label>
                            <input type="text" id="empBankName" class="form-control" placeholder="e.g., Maybank, CIMB">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Bank Account No</label>
                            <input type="text" id="empBankAccount" class="form-control" placeholder="Account number">
                        </div>
                        <div class="form-group">
                            <label class="form-label">EPF No (KWSP)</label>
                            <input type="text" id="empEPFNo" class="form-control" placeholder="EPF member number">
                        </div>
                        <div class="form-group">
                            <label class="form-label">SOCSO No (PERKESO)</label>
                            <input type="text" id="empSOCSONo" class="form-control" placeholder="SOCSO number">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Tax No (LHDN)</label>
                            <input type="text" id="empTaxNo" class="form-control" placeholder="Income tax number">
                        </div>
                        <div class="form-group full-width">
                            <label class="form-label">Statutory Contributions</label>
                            <div style="display: flex; gap: 20px; flex-wrap: wrap; padding: 10px; background: #f8fafc; border-radius: 8px;">
                                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                    <input type="checkbox" id="empHasEPF" checked style="width: 18px; height: 18px;">
                                    <span>EPF (KWSP)</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                    <input type="checkbox" id="empHasSOCSO" checked style="width: 18px; height: 18px;">
                                    <span>SOCSO (PERKESO)</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                    <input type="checkbox" id="empHasEIS" checked style="width: 18px; height: 18px;">
                                    <span>EIS</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                    <input type="checkbox" id="empHasPCB" checked style="width: 18px; height: 18px;">
                                    <span>PCB (Tax)</span>
                                </label>
                            </div>
                            <small style="color: #64748b; margin-top: 5px; display: block;">Uncheck for foreign workers or exempt employees</small>
                        </div>
                    </div>
                </div>
                
                <div class="form-section">
                    <h4><i class="fas fa-percentage"></i> Commission Settings</h4>
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">Commission Type</label>
                            <select id="empCommissionType" class="form-control" onchange="toggleCommissionFields()">
                                <option value="none">No Commission</option>
                                <option value="percentage">Percentage of Total Sales (%)</option>
                                <option value="tiered">Tiered Commission (Sales Brackets)</option>
                                <option value="fixed">Fixed Monthly Amount (RM)</option>
                                <option value="product">Per Product/Item Sold</option>
                            </select>
                        </div>
                        <div class="form-group" id="commissionValueGroup" style="display: none;">
                            <label class="form-label" id="commissionValueLabel">Commission Rate</label>
                            <input type="number" id="empCommissionValue" class="form-control" step="0.01" min="0" placeholder="Enter value">
                        </div>
                    </div>
                    
                    <!-- Tiered Commission Section -->
                    <div id="tieredCommissionSection" style="display: none; margin-top: 15px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <label class="form-label" style="margin: 0;">Commission Tiers (Sales Brackets)</label>
                            <button type="button" class="btn-outline btn-sm" onclick="addCommissionTier()">
                                <i class="fas fa-plus"></i> Add Tier
                            </button>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr 100px 40px; gap: 10px; padding: 8px; background: #e2e8f0; border-radius: 6px; font-size: 12px; font-weight: 600; color: #64748b; margin-bottom: 8px;">
                            <span>From (RM)</span>
                            <span>To (RM)</span>
                            <span>Rate (%)</span>
                            <span></span>
                        </div>
                        <div id="commissionTiersContainer">
                            <!-- Tiers will be added here -->
                        </div>
                        <small style="color: #64748b;">Commission is calculated based on which tier the monthly sales falls into</small>
                    </div>
                    
                    <!-- Product-Based Commission Rules -->
                    <div id="productCommissionSection" style="display: none; margin-top: 15px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <label class="form-label" style="margin: 0;">Commission Rules (Per Product/Category)</label>
                            <button type="button" class="btn-outline btn-sm" onclick="addCommissionRule()">
                                <i class="fas fa-plus"></i> Add Rule
                            </button>
                        </div>
                        <div id="commissionRulesContainer">
                            <!-- Commission rules will be added here -->
                        </div>
                        <small style="color: #64748b;">Set commission per unit sold for specific products or categories</small>
                    </div>
                </div>
                
                <div class="modal-footer">
                    <button type="button" class="btn-secondary" onclick="closeEmployeeModal()">Cancel</button>
                    <button type="submit" class="btn-primary">
                        <i class="fas fa-save"></i> Save Employee
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- ==================== EMPLOYEE DETAIL MODAL ==================== -->
    <div class="modal" id="employeeDetailModal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h3 class="modal-title">Employee Details</h3>
                <button class="modal-close" onclick="closeEmployeeDetailModal()">&times;</button>
            </div>
            <div id="employeeDetailContent">
                <!-- Employee details will be loaded here -->
            </div>
        </div>
    </div>
    
    <!-- ==================== PROCESS PAYROLL MODAL ==================== -->
    <div class="modal" id="processPayrollModal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h3 class="modal-title"><i class="fas fa-calculator"></i> Process Payroll</h3>
                <button class="modal-close" onclick="closeProcessPayrollModal()">&times;</button>
            </div>
            <form id="payrollForm" onsubmit="event.preventDefault(); processPayroll();">
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label">Select Employee *</label>
                        <select id="payrollEmployee" class="form-control" required onchange="onPayrollEmployeeChange()">
                            <option value="">Select Employee</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Payroll Month *</label>
                        <input type="month" id="payrollMonth" class="form-control" required onchange="calculateAutoCommission()">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Allowances (RM)</label>
                        <input type="number" id="payrollAllowances" class="form-control" step="0.01" min="0" value="0" placeholder="Transport, meal, etc." oninput="calculatePayrollPreview()">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Overtime (RM)</label>
                        <input type="number" id="payrollOvertime" class="form-control" step="0.01" min="0" value="0" placeholder="OT pay" oninput="calculatePayrollPreview()">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Commission (RM)</label>
                        <div style="display: flex; gap: 10px;">
                            <input type="number" id="payrollCommission" class="form-control" step="0.01" min="0" value="0" placeholder="Sales commission" oninput="calculatePayrollPreview()">
                            <button type="button" class="btn-outline" onclick="calculateAutoCommission()" title="Auto-calculate from sales">
                                <i class="fas fa-calculator"></i>
                            </button>
                        </div>
                        <small id="commissionInfo" style="color: #64748b; font-size: 11px; margin-top: 4px; display: block;"></small>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Other Deductions (RM)</label>
                        <input type="number" id="payrollDeductions" class="form-control" step="0.01" min="0" value="0" placeholder="Loans, advances, etc." oninput="calculatePayrollPreview()">
                    </div>
                </div>
                
                <!-- Payroll Preview -->
                <div id="payrollPreview" class="payroll-preview">
                    <p style="text-align: center; color: #64748b;">Select an employee to see payroll preview</p>
                </div>
                
                <div class="modal-footer">
                    <button type="button" class="btn-secondary" onclick="closeProcessPayrollModal()">Cancel</button>
                    <button type="submit" class="btn-primary">
                        <i class="fas fa-check"></i> Process Payroll
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- ==================== PAYSLIP MODAL ==================== -->
    <div class="modal" id="payslipModal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h3 class="modal-title"><i class="fas fa-file-alt"></i> Pay Slip</h3>
                <button class="modal-close" onclick="closePayslipModal()">&times;</button>
            </div>
            <div id="payslipContent">
                <!-- Payslip content will be loaded here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-secondary" onclick="closePayslipModal()">Close</button>
                <button type="button" class="btn-primary" onclick="window.print()">
                    <i class="fas fa-print"></i> Print
                </button>
            </div>
        </div>
    </div>
    
    <!-- ==================== LEAVE REQUEST MODAL ==================== -->
    <div class="modal" id="leaveRequestModal">
        <div class="modal-content" style="max-width: 550px;">
            <div class="modal-header">
                <h3 class="modal-title" id="leaveRequestModalTitle"><i class="fas fa-calendar-plus"></i> New Leave Request</h3>
                <button class="modal-close" onclick="closeLeaveRequestModal()">&times;</button>
            </div>
            <form id="leaveRequestForm" onsubmit="event.preventDefault(); saveLeaveRequest();">
                <input type="hidden" id="leaveRequestId">
                
                <div class="form-group">
                    <label class="form-label">Employee *</label>
                    <select id="leaveEmployee" class="form-control" required>
                        <option value="">Select Employee</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Leave Type *</label>
                    <select id="leaveType" class="form-control" required>
                        <option value="">Select Type</option>
                        <option value="annual">Annual Leave</option>
                        <option value="medical">Medical Leave (MC)</option>
                        <option value="emergency">Emergency Leave</option>
                        <option value="unpaid">Unpaid Leave</option>
                        <option value="maternity">Maternity Leave</option>
                        <option value="paternity">Paternity Leave</option>
                        <option value="compassionate">Compassionate Leave</option>
                        <option value="replacement">Replacement Leave</option>
                        <option value="study">Study Leave</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label">From Date *</label>
                        <input type="date" id="leaveFromDate" class="form-control" required onchange="calculateLeaveDays()">
                    </div>
                    <div class="form-group">
                        <label class="form-label">To Date *</label>
                        <input type="date" id="leaveToDate" class="form-control" required onchange="calculateLeaveDays()">
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">
                        Duration: <span id="leaveDaysCount" style="font-weight: 600; color: #2563eb;">0 days</span>
                    </label>
                    <div style="display: flex; gap: 15px; margin-top: 5px;">
                        <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                            <input type="radio" name="leaveDuration" value="full" checked onchange="calculateLeaveDays()"> Full Day
                        </label>
                        <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                            <input type="radio" name="leaveDuration" value="half-am" onchange="calculateLeaveDays()"> Half Day (AM)
                        </label>
                        <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                            <input type="radio" name="leaveDuration" value="half-pm" onchange="calculateLeaveDays()"> Half Day (PM)
                        </label>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Reason</label>
                    <textarea id="leaveReason" class="form-control" rows="3" placeholder="Enter reason for leave..."></textarea>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Attachment (MC/Supporting Document)</label>
                    <input type="file" id="leaveAttachment" class="form-control" accept=".pdf,.jpg,.jpeg,.png">
                </div>
                
                <div class="modal-footer">
                    <button type="button" class="btn-secondary" onclick="closeLeaveRequestModal()">Cancel</button>
                    <button type="submit" class="btn-primary">
                        <i class="fas fa-save"></i> Submit Request
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- ==================== LEAVE BALANCE MODAL ==================== -->
    <div class="modal" id="leaveBalanceModal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h3 class="modal-title"><i class="fas fa-chart-pie"></i> Leave Balance</h3>
                <button class="modal-close" onclick="closeLeaveBalanceModal()">&times;</button>
            </div>
            <div style="margin-bottom: 15px;">
                <select id="leaveBalanceEmployee" class="form-control" onchange="loadLeaveBalance()">
                    <option value="">Select Employee</option>
                </select>
            </div>
            <div id="leaveBalanceContent">
                <div class="empty-state">
                    <i class="fas fa-user"></i>
                    <p>Select an employee to view leave balance</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-secondary" onclick="closeLeaveBalanceModal()">Close</button>
            </div>
        </div>
    </div>
    
    <!-- ==================== ATTENDANCE EDIT MODAL ==================== -->
    <div class="modal" id="attendanceEditModal">
        <div class="modal-content" style="max-width: 450px;">
            <div class="modal-header">
                <h3 class="modal-title"><i class="fas fa-edit"></i> Edit Attendance</h3>
                <button class="modal-close" onclick="closeAttendanceEditModal()">&times;</button>
            </div>
            <form id="attendanceEditForm" onsubmit="event.preventDefault(); saveAttendanceEdit();">
                <input type="hidden" id="attendanceEditId">
                
                <div class="form-group">
                    <label class="form-label">Employee</label>
                    <input type="text" id="attendanceEditEmployee" class="form-control" readonly>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Date</label>
                    <input type="date" id="attendanceEditDate" class="form-control" readonly>
                </div>
                
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label">Clock In</label>
                        <input type="time" id="attendanceEditClockIn" class="form-control">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Clock Out</label>
                        <input type="time" id="attendanceEditClockOut" class="form-control">
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Status</label>
                    <select id="attendanceEditStatus" class="form-control">
                        <option value="present">Present</option>
                        <option value="late">Late</option>
                        <option value="absent">Absent</option>
                        <option value="half-day">Half Day</option>
                        <option value="on-leave">On Leave</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Notes</label>
                    <textarea id="attendanceEditNotes" class="form-control" rows="2"></textarea>
                </div>
                
                <div class="modal-footer">
                    <button type="button" class="btn-secondary" onclick="closeAttendanceEditModal()">Cancel</button>
                    <button type="submit" class="btn-primary">
                        <i class="fas fa-save"></i> Save
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- ==================== KPI TEMPLATE MODAL ==================== -->
    <div class="modal" id="kpiTemplateModal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h3 class="modal-title" id="kpiTemplateModalTitle">Create KPI Template</h3>
                <button class="modal-close" onclick="closeKPITemplateModal()">&times;</button>
            </div>
            <form id="kpiTemplateForm" onsubmit="event.preventDefault(); saveKPITemplate();">
                <input type="hidden" id="kpiTemplateId">
                
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label">Template Name *</label>
                        <input type="text" id="kpiTemplateName" class="form-control" required placeholder="e.g., Sales Staff KPI">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Category</label>
                        <select id="kpiTemplateCategory" class="form-control">
                            <option value="sales">Sales</option>
                            <option value="operations">Operations</option>
                            <option value="admin">Admin/Support</option>
                            <option value="management">Management</option>
                            <option value="general">General</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-section">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h4><i class="fas fa-tasks"></i> Metrics</h4>
                        <div style="display: flex; align-items: center; gap: 15px;">
                            <span id="weightTotalIndicator" class="weight-indicator">Total Weight: 0%</span>
                            <button type="button" class="btn-secondary" onclick="addKPIMetric()">
                                <i class="fas fa-plus"></i> Add Metric
                            </button>
                        </div>
                    </div>
                    <div class="metric-header-row">
                        <span>Metric Name</span>
                        <span>Weight %</span>
                        <span>Unit</span>
                        <span>Target</span>
                        <span></span>
                    </div>
                    <div id="kpiMetricsEditor">
                        <!-- Metrics will be rendered here -->
                    </div>
                </div>
                
                <div class="modal-footer">
                    <button type="button" class="btn-secondary" onclick="closeKPITemplateModal()">Cancel</button>
                    <button type="submit" class="btn-primary">
                        <i class="fas fa-save"></i> Save Template
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- ==================== ASSIGN KPI MODAL ==================== -->
    <div class="modal" id="assignKPIModal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h3 class="modal-title"><i class="fas fa-user-plus"></i> Assign KPI</h3>
                <button class="modal-close" onclick="closeAssignKPIModal()">&times;</button>
            </div>
            <form id="assignKPIForm" onsubmit="event.preventDefault(); assignKPIToEmployee();">
                <div class="form-group">
                    <label class="form-label">KPI Template *</label>
                    <select id="assignKPITemplate" class="form-control" required>
                        <option value="">Select KPI Template</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Employee *</label>
                    <select id="assignKPIEmployee" class="form-control" required>
                        <option value="">Select Employee</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Period *</label>
                    <input type="month" id="assignKPIPeriod" class="form-control" required>
                </div>
                
                <div class="modal-footer">
                    <button type="button" class="btn-secondary" onclick="closeAssignKPIModal()">Cancel</button>
                    <button type="submit" class="btn-primary">
                        <i class="fas fa-check"></i> Assign KPI
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- ==================== SCORE KPI MODAL ==================== -->
    <div class="modal" id="scoreKPIModal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h3 class="modal-title"><i class="fas fa-star"></i> Score KPI</h3>
                <button class="modal-close" onclick="closeScoreKPIModal()">&times;</button>
            </div>
            <form id="scoreKPIForm" onsubmit="event.preventDefault(); saveKPIScore();">
                <input type="hidden" id="scoreAssignmentId">
                
                <div class="score-header">
                    <div class="score-employee">
                        <strong id="scoreEmployeeName">Employee Name</strong>
                        <span id="scorePeriod">Dec 2025</span>
                    </div>
                    <div class="score-template" id="scoreTemplateName">Template Name</div>
                </div>
                
                <div class="score-guide">
                    <span class="guide-item exceptional"><i class="fas fa-star"></i> 120%+ Exceptional</span>
                    <span class="guide-item excellent">100-119% Excellent</span>
                    <span class="guide-item good">80-99% Good</span>
                    <span class="guide-item needs-improvement">60-79% Needs Improvement</span>
                    <span class="guide-item poor">&lt;60% Poor</span>
                </div>
                
                <div id="scoreMetricsContainer">
                    <!-- Metrics for scoring will be loaded here -->
                </div>
                
                <div id="overallScorePreview" class="overall-score-preview">
                    <!-- Overall score preview -->
                </div>
                
                <div class="modal-footer">
                    <button type="button" class="btn-secondary" onclick="closeScoreKPIModal()">Cancel</button>
                    <button type="submit" class="btn-primary">
                        <i class="fas fa-save"></i> Save Scores
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- ==================== PERFORMANCE HISTORY MODAL ==================== -->
    <div class="modal" id="performanceModal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h3 class="modal-title"><i class="fas fa-chart-line"></i> Performance History - <span id="performanceEmployeeName"></span></h3>
                <button class="modal-close" onclick="closePerformanceModal()">&times;</button>
            </div>
            <div id="performanceContent">
                <!-- Performance history will be loaded here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-secondary" onclick="closePerformanceModal()">Close</button>
            </div>
        </div>
    </div>
    
    <!-- ==================== PHASE 2: RECEIPT MODAL ==================== -->
    <div class="modal" id="receiptModal">
        <div class="modal-content" style="max-width: 350px;">
            <div class="modal-header">
                <h3 class="modal-title">Receipt</h3>
                <button class="modal-close" onclick="closeModal('receiptModal')">&times;</button>
            </div>
            <div id="receiptContent" class="receipt-preview">
                <!-- Receipt content generated dynamically -->
            </div>
            <div class="modal-footer" style="justify-content: center; gap: 10px;">
                <button class="btn-outline" onclick="emailReceipt()" style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); color: white; border: none;">
                    <i class="fas fa-envelope"></i> Email
                </button>
                <button class="btn-outline" onclick="printReceipt()">
                    <i class="fas fa-print"></i> Print
                </button>
                <button class="btn-primary" onclick="closeModal('receiptModal'); clearCart();">
                    <i class="fas fa-check"></i> Done
                </button>
            </div>
        </div>
    </div>

    <!-- ==================== BRANCH MODAL (Phase 5) ==================== -->
    <div class="modal" id="branchModal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h3 class="modal-title" id="branchModalTitle">Add Branch</h3>
                <button class="modal-close" onclick="closeBranchModal()">&times;</button>
            </div>
            <form id="branchForm" onsubmit="saveBranch(event)">
                <input type="hidden" id="branchId">
                <div class="form-grid">
                    <div class="form-group full-width">
                        <label class="form-label">Branch Name *</label>
                        <input type="text" id="branchName" class="form-control" placeholder="e.g., Main Branch, Outlet 1, Warehouse A" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Branch Code *</label>
                        <input type="text" id="branchCode" class="form-control" placeholder="e.g., HQ, BR01, WH-A" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Branch Type</label>
                        <select id="branchType" class="form-control">
                            <option value="headquarters">Headquarters</option>
                            <option value="retail">Retail Store</option>
                            <option value="warehouse">Warehouse</option>
                            <option value="office">Office</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Manager/PIC</label>
                        <input type="text" id="branchManager" class="form-control" placeholder="Person in charge">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Phone</label>
                        <input type="tel" id="branchPhone" class="form-control" placeholder="012-345 6789">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Email</label>
                        <input type="email" id="branchEmail" class="form-control" placeholder="branch@company.com">
                    </div>
                    <div class="form-group">
                        <label class="form-label">State</label>
                        <select id="branchState" class="form-control">
                            <option value="">Select State</option>
                            <option value="Selangor">Selangor</option>
                            <option value="Kuala Lumpur">Kuala Lumpur</option>
                            <option value="Johor">Johor</option>
                            <option value="Penang">Penang</option>
                            <option value="Perak">Perak</option>
                            <option value="Sabah">Sabah</option>
                            <option value="Sarawak">Sarawak</option>
                            <option value="Kedah">Kedah</option>
                            <option value="Kelantan">Kelantan</option>
                            <option value="Negeri Sembilan">Negeri Sembilan</option>
                            <option value="Pahang">Pahang</option>
                            <option value="Terengganu">Terengganu</option>
                            <option value="Perlis">Perlis</option>
                            <option value="Melaka">Melaka</option>
                            <option value="Putrajaya">Putrajaya</option>
                            <option value="Labuan">Labuan</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">City</label>
                        <input type="text" id="branchCity" class="form-control" placeholder="City name">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Postcode</label>
                        <input type="text" id="branchPostcode" class="form-control" placeholder="e.g., 47500" maxlength="5">
                    </div>
                    <div class="form-group full-width">
                        <label class="form-label">Address</label>
                        <textarea id="branchAddress" class="form-control" rows="2" placeholder="Full branch address"></textarea>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Opening Hours</label>
                        <input type="text" id="branchHours" class="form-control" placeholder="e.g., 9:00 AM - 6:00 PM">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Status</label>
                        <select id="branchStatus" class="form-control">
                            <option value="active">Active</option>
                            <option value="inactive">Inactive</option>
                        </select>
                    </div>
                    <div class="form-group full-width">
                        <label class="form-label">Notes</label>
                        <textarea id="branchNotes" class="form-control" rows="2" placeholder="Additional notes about this branch"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn-secondary" onclick="closeBranchModal()">Cancel</button>
                    <button type="submit" class="btn-primary">
                        <i class="fas fa-save"></i> Save Branch
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- ==================== STOCK TRANSFER MODAL (Phase 5) ==================== -->
    <div class="modal" id="transferModal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h3 class="modal-title" id="transferModalTitle">New Stock Transfer</h3>
                <button class="modal-close" onclick="closeTransferModal()">&times;</button>
            </div>
            <form id="transferForm" onsubmit="saveTransfer(event)">
                <input type="hidden" id="transferId">
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label">From Branch *</label>
                        <select id="transferFromBranch" class="form-control" required onchange="onTransferBranchChange()">
                            <option value="">Select source branch</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">To Branch *</label>
                        <select id="transferToBranch" class="form-control" required>
                            <option value="">Select destination branch</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Transfer Date *</label>
                        <input type="date" id="transferDate" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Expected Arrival</label>
                        <input type="date" id="transferExpectedDate" class="form-control">
                    </div>
                    <div class="form-group full-width">
                        <label class="form-label">Transfer Reason</label>
                        <input type="text" id="transferReason" class="form-control" placeholder="e.g., Stock replenishment, Rebalancing">
                    </div>
                </div>
                
                <!-- Transfer Items -->
                <div class="form-section" style="margin-top: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h4><i class="fas fa-boxes"></i> Items to Transfer</h4>
                        <button type="button" class="btn-outline btn-sm" onclick="addTransferItem()">
                            <i class="fas fa-plus"></i> Add Item
                        </button>
                    </div>
                    <div class="table-container">
                        <table id="transferItemsTable">
                            <thead>
                                <tr>
                                    <th>Product</th>
                                    <th style="width: 120px;">Available</th>
                                    <th style="width: 120px;">Quantity</th>
                                    <th style="width: 80px;">Action</th>
                                </tr>
                            </thead>
                            <tbody id="transferItemsBody">
                                <!-- Items added dynamically -->
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <div class="form-group full-width" style="margin-top: 15px;">
                    <label class="form-label">Notes</label>
                    <textarea id="transferNotes" class="form-control" rows="2" placeholder="Additional notes for this transfer"></textarea>
                </div>
                
                <div class="modal-footer">
                    <button type="button" class="btn-secondary" onclick="closeTransferModal()">Cancel</button>
                    <button type="submit" class="btn-primary">
                        <i class="fas fa-paper-plane"></i> Create Transfer
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- ==================== TRANSFER DETAILS MODAL (Phase 5) ==================== -->
    <div class="modal" id="transferDetailModal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h3 class="modal-title">Transfer Details</h3>
                <button class="modal-close" onclick="closeModal('transferDetailModal')">&times;</button>
            </div>
            <div id="transferDetailContent">
                <!-- Content rendered dynamically -->
            </div>
            <div class="modal-footer" id="transferDetailFooter">
                <!-- Buttons rendered dynamically based on status -->
            </div>
        </div>
    </div>
    </div> <!-- Close main-content -->

    <!-- Keyboard Shortcut Hint -->
    <div class="keyboard-hint" onclick="showKeyboardShortcuts()" title="Click for all shortcuts">
        <i class="fas fa-keyboard"></i> <kbd>Ctrl</kbd>+<kbd>I</kbd> Income | <kbd>Ctrl</kbd>+<kbd>E</kbd> Expense
    </div>

    <!-- Modular JavaScript Files - v2.3.1 (Batch Split: 6 files into 12 modules) -->
    <script src="js/core.js?v=9999999999"></script>
    <!-- Data Module (Split v2.3.1) -->
    <script src="js/data/data-utils.js?v=9999999999"></script>
    <script src="js/data/data-storage.js?v=9999999999"></script>
    <script src="js/ui.js?v=9999999999"></script>
    <script src="js/transactions.js?v=9999999999"></script>
    <script src="js/dashboard.js?v=9999999999"></script>
    <script src="js/bills.js?v=9999999999"></script>
    <script src="js/charts.js?v=9999999999"></script>
    <script src="js/reports.js?v=9999999999"></script>
    <script src="js/taxes.js?v=9999999999"></script>
    <script src="js/chatbot.js?v=9999999999"></script>
    <!-- Balance Sheet Module (Split v2.2.7) -->
    <script src="js/balance-sheet/balance-sheet-core.js?v=9999999999"></script>
    <script src="js/balance-sheet/balance-sheet-reports.js?v=9999999999"></script>
    <!-- PDF Export Module (Split v2.3.1) -->
    <script src="js/pdf-export/pdf-export-core.js?v=9999999999"></script>
    <script src="js/pdf-export/pdf-export-templates.js?v=9999999999"></script>
    
    <!-- AI Assistant Module (Split v2.2.6) -->
    <script src="js/ai-assistant/ai-core.js?v=9999999999"></script>
    <script src="js/ai-assistant/ai-insights.js?v=9999999999"></script>
    <script src="js/ai-assistant/ai-chat.js?v=9999999999"></script>
    <script src="js/ai-assistant/ai-chat-b.js?v=9999999999"></script>
    <script src="js/ai-assistant/ai-tutorials.js?v=9999999999"></script>
    
    <!-- Chart of Accounts Module (Split v2.3.0) -->
    <script src="js/chart-of-accounts/chart-of-accounts-core.js?v=9999999999"></script>
    <script src="js/chart-of-accounts/chart-of-accounts-ui.js?v=9999999999"></script>
    <!-- Journal Entries Module (Split v2.3.0) -->
    <script src="js/journal-entries/journal-entries-core.js?v=9999999999"></script>
    <script src="js/journal-entries/journal-entries-ui.js?v=9999999999"></script>
    <script src="js/aging-reports.js?v=9999999999"></script>
    
    <!-- Phase 2: Operational Core -->
    <!-- Inventory Module (Split v2.3.0) -->
    <script src="js/inventory-new/inventory-new-core.js?v=9999999999"></script>
    <script src="js/inventory-new/inventory-new-ui.js?v=9999999999"></script>
    <!-- Stock Module (Split v2.3.1) -->
    <script src="js/stock/stock-core.js?v=9999999999"></script>
    <script src="js/stock/stock-ui.js?v=9999999999"></script>
    <!-- POS Module (Split for maintainability) -->
    <script src="js/pos/pos-core.js?v=9999999999"></script>
    <script src="js/pos/pos-cart.js?v=9999999999"></script>
    <script src="js/pos/pos-payment.js?v=9999999999"></script>
    <script src="js/pos/pos-receipt.js?v=9999999999"></script>
    <script src="js/orders.js?v=9999999999"></script>
    <script src="js/customers.js?v=9999999999"></script>
    <script src="js/crm.js?v=9999999999"></script>
    <!-- Suppliers Module (Split v2.3.0) -->
    <script src="js/suppliers/suppliers-core.js?v=9999999999"></script>
    <script src="js/suppliers/suppliers-ui.js?v=9999999999"></script>
    <!-- Quotations Module (Split v2.2.7) -->
    <script src="js/quotations/quotations-core.js?v=9999999999"></script>
    <script src="js/quotations/quotations-ui.js?v=9999999999"></script>
    <script src="js/quotations/quotations-actions.js?v=9999999999"></script>
    <!-- Invoices Module (Split v2.3.1) -->
    <script src="js/invoices/invoices-core.js?v=9999999999"></script>
    <script src="js/invoices/invoices-ui.js?v=9999999999"></script>
    <!-- Projects Module (Split v2.3.0) -->
    <script src="js/projects/projects-core.js?v=9999999999"></script>
    <script src="js/projects/projects-ui.js?v=9999999999"></script>
    <!-- Phase 3: HR & Payroll (Split v2.2.7) -->
    <!-- Payroll Module -->
    <script src="js/payroll/payroll-core.js?v=9999999999"></script>
    <script src="js/payroll/payroll-calculations.js?v=9999999999"></script>
    <script src="js/payroll/payroll-ui.js?v=9999999999"></script>
    <!-- KPI Module -->
    <script src="js/kpi/kpi-core.js?v=9999999999"></script>
    <script src="js/kpi/kpi-templates.js?v=9999999999"></script>
    <script src="js/kpi/kpi-scoring.js?v=9999999999"></script>
    <script src="js/kpi/kpi-reports.js?v=9999999999"></script>
    <script src="js/kpi/kpi-ui.js?v=9999999999"></script>
    <!-- Leave & Attendance Module (Split v2.3.0) -->
    <script src="js/leave-attendance/leave-attendance-core.js?v=9999999999"></script>
    <script src="js/leave-attendance/leave-attendance-ui.js?v=9999999999"></script>
    <!-- HR Modules (Split v2.3.0) -->
    <script src="js/hr-modules/hr-modules-core.js?v=9999999999"></script>
    <script src="js/hr-modules/hr-modules-ui.js?v=9999999999"></script>

    <!-- Phase 4: Procurement & e-Invoice -->
    <!-- Purchase Orders Module (Split v2.3.0) -->
    <script src="js/purchase-orders/purchase-orders-core.js?v=9999999999"></script>
    <script src="js/purchase-orders/purchase-orders-ui.js?v=9999999999"></script>
    <script src="js/delivery-orders.js?v=9999999999"></script>
    <!-- e-Invoice Module (Split v2.2.7) -->
    <script src="js/e-invoice/e-invoice-core.js?v=9999999999"></script>
    <script src="js/e-invoice/e-invoice-api.js?v=9999999999"></script>
    <script src="js/e-invoice/e-invoice-demo.js?v=9999999999"></script>
    
    <!-- Backup & Restore -->
    <script src="js/backup.js?v=9999999999"></script>
    
    <!-- Excel Export -->
    <script src="js/excel-export.js?v=9999999999"></script>
    
    <!-- Add-ons Module (Split v2.2.7) -->
    <script src="js/addons/addons-core.js?v=9999999999"></script>
    <script src="js/addons/addons-reports.js?v=9999999999"></script>
    
    <!-- Bank Reconciliation Module (Split v2.3.1) -->
    <script src="js/bank-reconciliation/bank-recon-core.js?v=9999999999"></script>
    <script src="js/bank-reconciliation/bank-recon-ui.js?v=9999999999"></script>
    
    <!-- LHDN & Audit Export Module (Split v2.3.0) -->
    <script src="js/lhdn-export/lhdn-export-core.js?v=9999999999"></script>
    <script src="js/lhdn-export/lhdn-export-ui.js?v=9999999999"></script>

    <!-- Phase 5: Multi-Branch Module (Split v2.2.7) -->
    <script src="js/branches/branches-core.js?v=9999999999"></script>
    <script src="js/branches/branches-crud.js?v=9999999999"></script>
    <script src="js/branches/branches-transfers.js?v=9999999999"></script>
    <script src="js/branches/branches-stock.js?v=9999999999"></script>
    <script src="js/branches/branches-ui.js?v=9999999999"></script>
    
    <!-- Phase 6: Multi-Tenant & User Management -->
    <script src="js/multi-tenant.js?v=9999999999"></script>
    
    <!-- Users Module (Split v2.2.5) -->
    <script src="js/users/users-core.js?v=9999999999"></script>
    <script src="js/users/users-auth.js?v=9999999999"></script>
    <script src="js/users/users-permissions.js?v=9999999999"></script>
    <script src="js/users/users-ui.js?v=9999999999"></script>
    <script src="js/users/users-management.js?v=9999999999"></script>
    <script src="js/users/users-cloud.js?v=9999999999"></script>
    
    <!-- Platform Control Module (Split v2.2.6) -->
    <script src="js/platform-control/platform-core.js?v=9999999999"></script>
    <script src="js/platform-control/platform-plans.js?v=9999999999"></script>
    <script src="js/platform-control/platform-ui.js?v=9999999999"></script>
    <script src="js/platform-control/platform-ui-advanced.js?v=9999999999"></script>
    
    <!-- Cloud Database (Supabase) -->
    <script src="js/supabase.js?v=9999999999"></script>
    <script src="js/cloud-sync.js?v=9999999999"></script>
    
    <!-- Audit Log (System Tracking) -->
    <script src="js/audit-log.js?v=9999999999"></script>
    
    <!-- App Module (Split v2.2.7) -->
    <script src="js/app/app-core.js?v=9999999999"></script>
    <script src="js/app/app-outlets.js?v=9999999999"></script>
    <script src="js/app/app-finance.js?v=9999999999"></script>
    
    <!-- PWA Service Worker Registration -->
    <script>
        // Register Service Worker for PWA functionality
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./service-worker.js')
                    .then((registration) => {
                        console.log(' PWA: Service Worker registered successfully');
                        
                        // Check for updates
                        registration.addEventListener('updatefound', () => {
                            const newWorker = registration.installing;
                            newWorker.addEventListener('statechange', () => {
                                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                    // New version available
                                    if (confirm('New version of A Lazy Human available! Reload to update?')) {
                                        newWorker.postMessage({ type: 'SKIP_WAITING' });
                                        window.location.reload();
                                    }
                                }
                            });
                        });
                    })
                    .catch((error) => {
                        console.warn(' PWA: Service Worker registration failed:', error);
                    });
            });
        }
        
        // PWA Install Prompt
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            
            // Check if on mobile/tablet - show earlier
            const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
            const delay = isMobile ? 3000 : 30000; // 3 seconds on mobile, 30 on desktop
            
            setTimeout(() => {
                showPWAInstallPrompt();
            }, delay);
        });
        
        function showPWAInstallPrompt() {
            if (!deferredPrompt) return;
            
            // Check if already dismissed permanently
            if (localStorage.getItem('pwa_prompt_dismissed')) return;
            
            // Check if already shown this session
            if (sessionStorage.getItem('pwa_prompt_shown')) return;
            sessionStorage.setItem('pwa_prompt_shown', 'true');
            
            // Create install banner
            const banner = document.createElement('div');
            banner.id = 'pwaInstallBanner';
            banner.innerHTML = `
                <div style="position: fixed; bottom: 0; left: 0; right: 0; 
                            background: linear-gradient(135deg, #1e40af, #1d4ed8); color: white; 
                            padding: 16px 20px; box-shadow: 0 -4px 20px rgba(0,0,0,0.3);
                            display: flex; align-items: center; gap: 15px; z-index: 99999;
                            animation: slideUp 0.3s ease-out;">
                    <div style="width: 48px; height: 48px; background: white; border-radius: 12px; 
                                display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                        <img src="images/icon-192.png" alt="App" style="width: 36px; height: 36px; border-radius: 8px;">
                    </div>
                    <div style="flex: 1; min-width: 0;">
                        <div style="font-weight: 700; font-size: 16px;">Install A Lazy Human</div>
                        <div style="font-size: 13px; opacity: 0.9;">Add to home screen for quick access</div>
                    </div>
                    <button onclick="installPWA()" style="background: white; color: #1e40af; border: none; 
                            padding: 10px 20px; border-radius: 8px; font-weight: 700; cursor: pointer; 
                            font-size: 14px; white-space: nowrap;">
                        Install
                    </button>
                    <button onclick="dismissPWABanner(false)" style="background: transparent; border: none; 
                            color: white; cursor: pointer; padding: 8px; opacity: 0.8;">
                        <i class="fas fa-times" style="font-size: 18px;"></i>
                    </button>
                </div>
                <style>
                    @keyframes slideUp {
                        from { transform: translateY(100%); }
                        to { transform: translateY(0); }
                    }
                    @keyframes slideDown {
                        from { transform: translateY(0); }
                        to { transform: translateY(100%); }
                    }
                </style>
            `;
            document.body.appendChild(banner);
        }
        
        function installPWA() {
            if (!deferredPrompt) return;
            
            deferredPrompt.prompt();
            deferredPrompt.userChoice.then((choiceResult) => {
                if (choiceResult.outcome === 'accepted') {
                    console.log(' PWA: User accepted install prompt');
                    showNotification('A Lazy Human installed! Check your home screen.', 'success');
                }
                deferredPrompt = null;
                dismissPWABanner(true);
            });
        }
        
        function dismissPWABanner(permanent) {
            const banner = document.getElementById('pwaInstallBanner');
            if (banner) {
                banner.style.animation = 'slideDown 0.3s ease-out forwards';
                setTimeout(() => banner.remove(), 300);
            }
            // If user dismisses 3 times, don't show again
            if (!permanent) {
                const dismissCount = parseInt(localStorage.getItem('pwa_dismiss_count') || '0') + 1;
                localStorage.setItem('pwa_dismiss_count', dismissCount);
                if (dismissCount >= 3) {
                    localStorage.setItem('pwa_prompt_dismissed', 'true');
                }
            }
        }
        
        // Detect if running as installed PWA
        window.addEventListener('appinstalled', () => {
            console.log(' PWA: App was installed');
            deferredPrompt = null;
        });
    </script>
</body>
</html>